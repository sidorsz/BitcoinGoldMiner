<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gold Bitcoin Mining Simulator</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <!-- Tailwind CSS with custom gold theme -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            gold: {
              50: '#fff9e6',
              100: '#fff1cc',
              200: '#ffe8b3',
              300: '#ffe099',
              400: '#ffd780',
              500: '#ffcf66',
              600: '#d4af37', // Primary gold color
              700: '#b38f1e',
              800: '#916f0a',
              900: '#704f00',
            },
            crystal: {
              100: '#e6f7ff',
              200: '#b3e6ff',
              300: '#80d4ff',
              400: '#4dc3ff',
              500: '#1ab1ff',
              600: '#0088cc',
              700: '#006699',
              800: '#004466',
              900: '#002233',
            }
          },
          animation: {
            'gold-pulse': 'goldPulse 3s infinite',
            'crystal-shine': 'crystalShine 4s infinite',
          },
          keyframes: {
            goldPulse: {
              '0%, 100%': { 'box-shadow': '0 0 0 0 rgba(212, 175, 55, 0.7)' },
              '50%': { 'box-shadow': '0 0 20px 10px rgba(212, 175, 55, 0.4)' },
            },
            crystalShine: {
              '0%': { 'filter': 'brightness(1)', 'transform': 'rotateY(0deg)' },
              '50%': { 'filter': 'brightness(1.5)', 'transform': 'rotateY(180deg)' },
              '100%': { 'filter': 'brightness(1)', 'transform': 'rotateY(360deg)' },
            }
          }
        }
      }
    }
  </script>
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <!-- React and ReactDOM -->
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
  <!-- Babel for JSX -->
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.23.10/babel.min.js"></script>
  <!-- Three.js and GSAP -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.5/gsap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.5/ScrollTrigger.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
   /* Global Styles */
* {
  box-sizing: border-box;
}

input:focus {
  outline: none;
  box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.3);
}

/* Main Content */
.main-content {
  box-sizing: border-box;
  min-height: calc(100vh - 64px);
  padding-bottom: 80px;
  position: relative;
  overflow-y: auto;
  width: 100%;
}

@supports (padding-bottom: env(safe-area-inset-bottom)) {
  .main-content {
    padding-bottom: calc(8rem + env(safe-area-inset-bottom));
  }
}

@supports (-webkit-overflow-scrolling: touch) {
  .main-content {
    padding-bottom: 10rem;
  }
}

/* Wallet Button */
.wallet-btn {
  align-items: center;
  background: linear-gradient(45deg, #FFD700, #FFB700);
  border: none;
  border-radius: 8px;
  color: white;
  cursor: pointer;
  display: flex;
  font-size: 16px;
  gap: 8px;
  padding: 10px 20px;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.wallet-btn.connect {
  background: linear-gradient(45deg, #FFD700, #FFB700);
}

.wallet-btn.disconnect {
  background: linear-gradient(45deg, #EF4444, #DC2626);
}

.wallet-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

.wallet-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Toggle Switch */
.toggle-switch {
  background-color: #ccc;
  border-radius: 9999px;
  height: 20px;
  position: relative;
  transition: background-color 0.3s ease;
  width: 40px;
}

.toggle-switch input {
  negligible;
}

.toggle-switch .slider {
  background-color: white;
  border-radius: 50%;
  height: 16px;
  left: 2px;
  position: absolute;
  top: 2px;
  transition: transform 0.3s ease;
  width: 16px;
}

.toggle-switch input:checked + .slider {
  transform: translateX(20px);
}

.toggle-switch input:checked ~ .toggle-switch {
  background-color: #FFD700;
}

/* Wallet Connections Modal */
.wallet-connections-modal {
  -webkit-backdrop-filter: blur(10px);
  backdrop-filter: blur(10px);
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0));
  border: 1px solid rgba(255, 255, 255, 0.18);
  max-height: 80vh;
  overflow-y: auto;
}

.wallet-connections-modal::-webkit-scrollbar {
  width: 8px;
}

.wallet-connections-modal::-webkit-scrollbar-thumb {
  background: #FFD700;
  border-radius: 4px;
}

.wallet-connections-modal::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.1);
}

/* Crystal Card */
.crystal-card {
  -webkit-backdrop-filter: blur(10px);
  backdrop-filter: blur(10px);
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0));
  border: 1px solid rgba(255, 255, 255, 0.18);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.crystal-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
}

/* Status */
.status {
  font-size: 16px;
  font-weight: 600;
  margin-top: 16px;
}

.status.success {
  color: #10B981;
}

.status.error {
  color: #EF4444;
}

/* Section Title */
.section-title {
  font-family: 'Inter', sans-serif;
  font-weight: 700;
  letter-spacing: -0.025em;
}

/* Gold Theme */
.gold-gradient {
  background: linear-gradient(135deg, #d4af37 0%, #f9d423 50%, #d4af37 100%);
}

.gold-text-gradient {
  -webkit-background-clip: text;
  background: linear-gradient(45deg, #FFD700, #FFB700);
  background-clip: text;
  color: transparent;
}

/* Dark Mode */
.dark .gold-gradient {
  background: linear-gradient(135deg, #916f0a 0%, #b38f1e 50%, #916f0a 100%);
}

.dark .crystal-card {
  background: rgba(0, 0, 0, 0.2);
  border: 1px solid rgba(212, 175, 55, 0.3);
}

/* Sidebar */
.sidebar {
  transition: transform 0.3s ease-in-out;
  z-index: 20;
}

.sidebar-overlay {
  background-color: rgba(0, 0, 0, 0.5);
  bottom: 0;
  display: none;
  left: 0;
  position: fixed;
  right: 0;
  top: 0;
  z-index: 10;
}

.sidebar-overlay.sidebar-open {
  display: block;
}

/* Navbar Bottom */
.navbar-bottom {
  -webkit-backdrop-filter: blur(10px);
  align-items: center;
  backdrop-filter: blur(10px);
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0));
  border-top: 1px solid rgba(255, 255, 255, 0.18);
  bottom: 0;
  display: flex;
  height: 64px;
  justify-content: space-around;
  left: 0;
  position: fixed;
  right: 0;
  z-index: 1000;
}

/* Canvas */
#threeCanvas {
  height: 300px;
  pointer-events: none;
  position: fixed;
  right: 0;
  top: 0;
  width: 300px;
  z-index: 5;
}

/* Language Selector */
.language-selector {
  position: relative;
}

.language-dropdown {
  display: none;
  min-width: 120px;
  position: absolute;
  right: 0;
  top: 100%;
  z-index: 20;
}

.language-selector:hover .language-dropdown {
  display: block;
}

/* Leaderboard */
.leaderboard-container {
  -webkit-overflow-scrolling: touch;
}

.leaderboard-item {
  align-items: center;
  display: flex;
  gap: 12px;
  justify-content: space-between;
}

.rank {
  align-items: center;
  display: flex;
  gap: 4px;
}

/* Typography & Layout Adjustments */
.mobile-icon {
  animation: crystalShine 4s infinite;
  font-size: 1.25rem;
}

span.text-xs {
  font-size: 0.65rem;
}

.overflow-x-auto {
  margin-bottom: 2rem;
  max-height: none;
  overflow-y: visible;
}

table.min-w-full {
  display: block;
  overflow: visible;
}

/* Animations */
.animate-slide-in {
  animation: slideIn 0.5s ease-out;
}

.animate-fade-in {
  animation: fadeIn 0.3s ease-in;
}

.animate-pulse {
  animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}

.mining-active {
  animation: goldPulse 3s infinite;
}

/* Keyframes */
@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: scale(0.8);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

/* Media Queries */
@media (max-width: 768px) {
  .main-content {
    padding: 12px;
    padding-bottom: 80px;
  }

  .crystal-card {
    border-radius: 12px;
    margin: 0 8px 16px;
    min-height: initial;
    padding: 12px;
  }

  .wallet-btn {
    font-size: 14px;
    padding: 8px 16px;
  }

  .wallet-connections-modal {
    max-width: 90%;
  }

  .section-title {
    font-size: 1.5rem;
  }

  .sidebar {
    bottom: 0;
    position: fixed;
    top: 0;
    transform: translateX(-100%);
  }

  .sidebar-open {
    transform: translateX(0);
  }

  .sidebar-close-btn {
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    font-size: 1.5rem;
    position: absolute;
    right: 10px;
    top: 10px;
    z-index: 30;
  }

  #threeCanvas {
    height: 200px;
    width: 200px;
  }

  .leaderboard-container {
    overflow-x: auto;
    scrollbar-color: rgba(255, 215, 0, 0.5) transparent;
    scrollbar-width: thin;
  }

  .leaderboard-container::-webkit-scrollbar {
    height: 6px;
  }

  .leaderboard-container::-webkit-scrollbar-thumb {
    background-color: rgba(255, 215, 0, 0.5);
    border-radius: 3px;
  }

  .leaderboard-container::-webkit-scrollbar-track {
    background: transparent;
  }

  .leaderboard-item {
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    gap: 8px;
    min-width: 320px;
    padding: 10px;
  }

  .rank {
    font-size: 0.875rem;
    width: 36px;
  }

  .rank i {
    font-size: 0.75rem;
  }

  .leaderboard-item img,
  .leaderboard-item .w-10 {
    height: 32px;
    width: 32px;
  }

  .leaderboard-item .max-width-200px {
    font-size: 0.875rem;
    max-width: 180px;
  }

  .balance {
    font-size: 0.75rem;
    white-space: nowrap;
  }
}

@media (min-width: 769px) {
  .main-content {
    min-height: 100vh;
    outline: none;
    padding: 24px;
    padding-bottom: 80px;
  }

  .crystal-card {
    padding: 24px;
  }

  .section-title {
    font-size: 2rem;
  }

  .leaderboard-container {
    overflow-x: hidden;
  }

  .leaderboard-item {
    min-width: 0;
    padding: 16px;
  }

  .rank {
    font-size: 1rem;
    width: 48px;
  }

  .rank i {
    font-size: 0.875rem;
  }

  .leaderboard-item img,
  .leaderboard-item .w-10 {
    height: 40px;
    width: 40px;
  }

  .leaderboard-item .max-w-200px {
    font-size: 1rem;
    max-width: 300px;
  }

  .balance {
    font-size: 0.875rem;
  }
}
@keyframes gold-glow {
  0%,100% { filter: drop-shadow(0 0 6px #FFD700) drop-shadow(0 0 12px #FFD700); }
  50% { filter: drop-shadow(0 0 16px #FFD700) drop-shadow(0 0 32px #FFFACD); }
}
/* Neon Gold Border Theme for All Containers */
.crystal-card,
.rounded-lg,
.rounded-xl,
.shadow-lg,
.bg-white,
.bg-gray-50,
.bg-gray-800,
.bg-gray-700 {
  border: 2px solid;
  border-radius: 2px;

  border-image: linear-gradient(
    120deg,
    #ffd700 0%,
    #fff700 20%,
    
    #ffd700 100%
  ) 1;
  box-shadow:
    0 0 8px 2px #ffd700cc,
    
    
  background-clip: padding-box;
  transition: border-color 0.3s, box-shadow 0.3s;
}

/* Neon effect on hover */
.crystal-card:hover,
.rounded-lg:hover,
.rounded-xl:hover,
.shadow-lg:hover {
  box-shadow:
    0 0 16px 4px #ffd700,
  
    
  border-color: #fff700;
}

/* Dark mode support */
.dark .crystal-card,
.dark .rounded-lg,
.dark .rounded-xl,
.dark .shadow-lg,
.dark .bg-white,
.dark .bg-gray-50,
.dark .bg-gray-800,
.dark .bg-gray-700 {
  background-color: #18181b !important;
  border-image: linear-gradient(
    120deg,
    #ffd700 0%,
  
  ) 1;
  box-shadow:
    0 0 16px 4px #ffd70099,
    
}
          .mining-card {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 215, 0, 0.05));
            border: 2px solid rgba(255, 215, 0, 0.3);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.2);
            transition: all 0.3s ease;
          }
          .mining-card:hover {
            box-shadow: 0 0 25px rgba(255, 215, 0, 0.4);
          }
          .mining-active {
            animation: goldPulse 2s infinite;
          }
          .boost-card {
            perspective: 1000px;
            height: 220px;
          }
          .boost-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.8s;
            transform-style: preserve-3d;
          }
          .boost-card-inner.flipped {
            transform: rotateY(180deg);
          }
          .boost-card-front, .boost-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 0.5rem;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
          }
          .boost-card-back {
            transform: rotateY(180deg);
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 215, 0, 0.1));
          }
          @keyframes goldPulse {
            0% {
              box-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
            }
            50% {
              box-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
            }
            100% {
              box-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
            }
          }
  </style>
    
</head>
<body class="bg-gray-100 dark:bg-gray-900 transition-colors duration-300">
  <div id="root"></div>
  <canvas id="threeCanvas"></canvas>

  <script type="text/babel">
    // Initialize 3D scene
    let miningAnimationActive = false;
    let torusKnot;

    function initThreeJS() {
      const canvas = document.getElementById('threeCanvas');
      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(75, 1, 0.1, 1000);
      const renderer = new THREE.WebGLRenderer({
        canvas,
        alpha: true,
        antialias: true
      });
      renderer.setSize(300, 300);

      // Create gold crystal geometry
      const geometry = new THREE.TorusKnotGeometry(1, 0.4, 100, 16);
      const material = new THREE.MeshPhongMaterial({
        color: 0xd4af37,
        emissive: 0x222222,
        specular: 0xffeeaa,
        shininess: 100,
        wireframe: false,
        transparent: true,
        opacity: 0.9
      });

      torusKnot = new THREE.Mesh(geometry, material);
      scene.add(torusKnot);

      // Add lights
      const ambientLight = new THREE.AmbientLight(0x404040);
      scene.add(ambientLight);

      const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
      directionalLight.position.set(1, 1, 1);
      scene.add(directionalLight);

      const pointLight = new THREE.PointLight(0xffcc00, 1, 100);
      pointLight.position.set(5, 5, 5);
      scene.add(pointLight);

      camera.position.z = 3;

      // Animation function
      function animate() {
        requestAnimationFrame(animate);

        if (miningAnimationActive) {
          torusKnot.rotation.x += 0.02;
          torusKnot.rotation.y += 0.02;

          // Pulsing effect when mining
          const scale = 1 + Math.sin(Date.now() * 0.005) * 0.2;
          torusKnot.scale.set(scale, scale, scale);

          // Color shift effect
          const hue = (Date.now() * 0.05) % 360;
          torusKnot.material.color.setHSL(hue / 360, 0.7, 0.5);
        } else {
          torusKnot.rotation.x += 0.005;
          torusKnot.rotation.y += 0.005;
          torusKnot.scale.set(1, 1, 1);
          torusKnot.material.color.setHex(0xd4af37);
        }

        renderer.render(scene, camera);
      }

      animate();

      // Handle window resize
      function handleResize() {
        const size = window.innerWidth < 768 ? 200 : 300;
        renderer.setSize(size, size);
        camera.aspect = 1;
        camera.updateProjectionMatrix();
      }

      window.addEventListener('resize', handleResize);
    }

    // Initialize GSAP ScrollTrigger
    function initScrollAnimations() {
      gsap.registerPlugin(ScrollTrigger);

      gsap.from('.section-title', {
        scrollTrigger: {
          trigger: '.section-title',
          start: 'top 80%',
        },
        opacity: 0,
        y: -100,
        duration: 1.5,
        ease: 'power3.out'
      });

      gsap.from('.about-card', {
        scrollTrigger: {
          trigger: '.about-card',
          start: 'top 80%',
        },
        opacity: 0,
        scale: 0.8,
        stagger: 0.3,
        duration: 1,
        ease: 'back.out(1.7)'
      });

      gsap.from('.timeline-card', {
        scrollTrigger: {
          trigger: '.timeline-card',
          start: 'top 80%',
        },
        opacity: 0,
        x: -100,
        stagger: 0.3,
        duration: 1,
        ease: 'power2.out'
      });

      gsap.from('.product-card', {
        scrollTrigger: {
          trigger: '.product-showcase',
          start: 'top 80%',
        },
        opacity: 0,
        y: 50,
        stagger: 0.3,
        duration: 1,
        ease: 'power3.out'
      });
    }

    // Initialize 3D and animations when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
      initThreeJS();
      initScrollAnimations();
    });

    // Supabase configuration
    const supabaseUrl = 'https://mnobniomzmjgpyyqartz.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1ub2JuaW9tem1qZ3B5eXFhcnR6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU3NDQ0NzYsImV4cCI6MjA2MTMyMDQ3Nn0.N1w5Ro7TGWu5zdTHhNCyop-iMTl7So7h6UwZfuybx1k';

// Validasi URL
try {
  new URL(supabaseUrl);
} catch (e) {
  console.error('Invalid Supabase URL:', supabaseUrl, e);
  throw new Error('Please provide a valid Supabase URL in supabaseUrl');
}
const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    

    // Referral utility function
function generateReferralCode() {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
  let code = '';
  for (let i = 0; i < 8; i++) {
    code += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return code;
}

// Main App Component
function App() {
  const [user, setUser] = React.useState(null);
  const [activeTab, setActiveTab] = React.useState('dashboard');
  const [session, setSession] = React.useState(null);
  const [isMobileMenuOpen, setIsMobileMenuOpen] = React.useState(false);
  const [darkMode, setDarkMode] = React.useState(false);
  const [language, setLanguage] = React.useState('en');
  const [isLoading, setIsLoading] = React.useState(true);
  const [error, setError] = React.useState('');
  const [profile, setProfile] = React.useState({
    full_name: '',
    phone_number: '',
    profile_photo: null,
    profile_photo_url: '',
    email: '',
    referral_code: '',
    referred_by: null,
  });

  const [miningState, setMiningState] = React.useState({
    status: 'stopped',
    hashRate: 0,
    btcMined: 0,
    networkSpeed: 0,
    sessionId: null,
    lastUpdate: null,
  });

  const translations = {
    en: {
      welcome: 'Home',
      mining: 'Mining',
      dashboard: 'Dashboard',
      profile: 'Profile',
      wallet: 'Wallet',
      leaderboard: 'Leaderboard',
      settings: 'Settings',
      logout: 'Logout',
      startMining: 'Start Mining',
      stopMining: 'Stop Mining',
      btcMined: '₿Ǥɱ Mined',
      hashRate: 'Hash Rate',
      networkSpeed: 'Network Speed',
      miningHistory: 'Mining History',
      refresh: 'Refresh',
      signIn: 'Sign In',
      signUp: 'Sign Up',
      email: 'Email',
      password: 'Password',
      fullName: 'Full Name',
      forgotPassword: 'Forgot Password?',
      needAccount: 'Need an account? Sign up',
      haveAccount: 'Already have an account? Sign in',
      orContinueWith: 'Or continue with',
      transactions: 'Transactions',
      balance: 'Balance',
      rank: 'Rank',
      miner: 'Miner',
      totalBtc: 'Total ₿Ǥɱ',
      sessions: 'Sessions',
      darkMode: 'Dark Mode',
      notifications: 'Notifications',
      about: 'About',
      version: 'Version 1.0.0',
      referralCode: 'Referral Code',
      copyReferralLink: 'Copy Referral Link',
      address: 'Address',
    disabled: 'Disabled',
    Connect: 'Connect',
    Disconnect: 'Disconnect',
    selectWallet: 'Select Wallet',
    walletConnected: 'Wallet Connected',
    connectedWallets: 'Connected Wallets',
    noConnectedWallets: 'No connected wallets',
    close: 'Close',
    processing: 'Processing...',
    cancel: 'Cancel',
    preview: 'Preview',
    editProfile: 'Edit Profile',
    save: 'Save',
    saving: 'Saving...',
    enterFullName: 'Enter full name',
    notSet: 'Not set',
    phoneNumber: 'Phone Number',
    enterPhoneNumber: 'Enter phone number',
    profileUpdated: 'Profile updated successfully!',
    loading: 'Loading...',
    noTransactions: 'No transactions found',
    date: 'Date',
    type: 'Type',
    amount: 'Amount',
    description: 'Description',
    noData: 'No data available',
    'Top Miners': 'Top Miners',
    networkError: 'Network error, please check your connection',
    darkModeDescription: 'Toggle between light and dark themes',
    notificationsDescription: 'Manage your notification preferences',
    emailNotifications: 'Email notifications',
    pushNotifications: 'Push notifications',
    sending: 'Sending...',
    sendNotification: 'Send Notification',
    appUpdate: 'App Update',
    updateMessage: 'There is a new update in your app!',
    invalidEmail: 'Invalid email address.',
    updateMessageEmail: 'Hello, there is a new update in your app. Check your settings!',
    emailNotificationFailed: 'Failed to send email notification.',
    userNotAuthenticated: 'User not authenticated.',
    emailNotSet: 'Email address not set in profile. Please update your profile.',
    enableNotificationsGuide: 'To enable notifications, go to your browser settings and allow notifications for this site.',
    userNotFoundGuide: 'User profile not found. Please ensure your profile is set up correctly.',
    invalidEmailGuide: 'The email address is invalid. Please update your profile with a valid email address.',
    emailNotificationGuide: 'Unable to send email. Please ensure your email address is correct in your profile and try again.',
    fileTooLarge: 'File too large. Max 5MB.',
    metaMaskNotFound: 'MetaMask not found! Please install MetaMask.',
    metaMaskNoAccounts: 'No accounts found in MetaMask.',
    phantomNotFound: 'Phantom wallet not found! Please install Phantom.',
    phantomNoPublicKey: 'No public key found in Phantom.',
    okxNotFound: 'OKX Wallet not found! Please install OKX Wallet.',
    okxNoAccounts: 'No accounts found in OKX Wallet.',
    walletAddressInUse: 'This wallet address is already used by another user.',
    invalidWalletType: 'Invalid wallet type selected.',
    },
    id: {
      welcome: 'Beranda',
      mining: 'Penambangan',
      dashboard: 'Dasbor',
      profile: 'Profil',
      wallet: 'Dompet',
      leaderboard: 'Papan Peringkat',
      settings: 'Pengaturan',
      logout: 'Keluar',
      startMining: 'Mulai Menambang',
      stopMining: 'Berhenti Menambang',
      btcMined: '₿Ǥɱ Ditambang',
      hashRate: 'Tingkat Hash',
      networkSpeed: 'Kecepatan Jaringan',
      miningHistory: 'Riwayat Penambangan',
      refresh: 'Muat Ulang',
      signIn: 'Masuk',
      signUp: 'Daftar',
      email: 'Email',
      password: 'Kata Sandi',
      fullName: 'Nama Lengkap',
      forgotPassword: 'Lupa Kata Sandi?',
      needAccount: 'Perlu akun? Daftar',
      haveAccount: 'Sudah punya akun? Masuk',
      orContinueWith: 'Atau lanjutkan dengan',
      transactions: 'Transaksi',
      balance: 'Saldo',
      rank: 'Peringkat',
      miner: 'Penambang',
      totalBtc: 'Total ₿Ǥɱ',
      sessions: 'Sesi',
      darkMode: 'Mode Gelap',
      notifications: 'Notifikasi',
      about: 'Tentang',
      version: 'Versi 1.0.0',
      referralCode: 'Kode Referral',
      copyReferralLink: 'Salin Tautan Referral',
      address: 'Alamat',
    disabled: 'Dinonaktifkan',
    Connect: 'Hubungkan',
    Disconnect: 'Putuskan',
    selectWallet: 'Pilih Wallet',
    walletConnected: 'Wallet Terhubung',
    connectedWallets: 'Wallet Terhubung',
    noConnectedWallets: 'Belum ada wallet terhubung',
    close: 'Tutup',
    processing: 'Memproses...',
    cancel: 'Batal',
    preview: 'Pratinjau',
    editProfile: 'Edit Profil',
    save: 'Simpan',
    saving: 'Menyimpan...',
    enterFullName: 'Masukkan nama lengkap',
    notSet: 'Belum diatur',
    phoneNumber: 'Nomor Telepon',
    enterPhoneNumber: 'Masukkan nomor telepon',
    profileUpdated: 'Profil berhasil diperbarui!',
    loading: 'Memuat...',
    noTransactions: 'Tidak ada transaksi',
    date: 'Tanggal',
    type: 'Tipe',
    amount: 'Jumlah',
    description: 'Deskripsi',
    noData: 'Tidak ada data',
    'Top Miners': 'Penambang Teratas',
    networkError: 'Kesalahan jaringan, periksa koneksi Anda',
    darkModeDescription: 'Beralih antara tema terang dan gelap',
    notificationsDescription: 'Kelola preferensi notifikasi Anda',
    emailNotifications: 'Notifikasi email',
    pushNotifications: 'Notifikasi push',
    sending: 'Mengirim...',
    sendNotification: 'Kirim Notifikasi',
    appUpdate: 'Pembaruan Aplikasi',
    updateMessage: 'Ada pembaruan baru di aplikasi Anda!',
    invalidEmail: 'Alamat email tidak valid.',
    updateMessageEmail: 'Halo, ada pembaruan baru di aplikasi Anda. Periksa pengaturan Anda!',
    emailNotificationFailed: 'Gagal mengirim notifikasi email.',
    userNotAuthenticated: 'Pengguna belum terautentikasi.',
    emailNotSet: 'Alamat email belum diatur di profil. Silakan perbarui profil Anda.',
    enableNotificationsGuide: 'Untuk mengaktifkan notifikasi, buka pengaturan browser dan izinkan notifikasi untuk situs ini.',
    userNotFoundGuide: 'Profil pengguna tidak ditemukan. Pastikan profil Anda sudah benar.',
    invalidEmailGuide: 'Alamat email tidak valid. Perbarui profil Anda dengan email yang benar.',
    emailNotificationGuide: 'Tidak dapat mengirim email. Pastikan alamat email Anda benar di profil dan coba lagi.',
    fileTooLarge: 'Ukuran file terlalu besar. Maksimal 5MB.',
    metaMaskNotFound: 'MetaMask tidak ditemukan! Silakan instal MetaMask.',
    metaMaskNoAccounts: 'Tidak ada akun di MetaMask.',
    phantomNotFound: 'Wallet Phantom tidak ditemukan! Silakan instal Phantom.',
    phantomNoPublicKey: 'Tidak ada public key di Phantom.',
    okxNotFound: 'OKX Wallet tidak ditemukan! Silakan instal OKX Wallet.',
    okxNoAccounts: 'Tidak ada akun di OKX Wallet.',
    walletAddressInUse: 'Alamat wallet ini sudah digunakan oleh pengguna lain.',
    invalidWalletType: 'Tipe wallet tidak valid.',
    },
  };

  const t = (key) => translations[language][key] || key;

  React.useEffect(() => {
    const savedDarkMode = localStorage.getItem('darkMode') === 'true';
    setDarkMode(savedDarkMode);
    if (savedDarkMode) {
      document.documentElement.classList.add('dark');
    }

    const getSession = async () => {
      setIsLoading(true);
      try {
        const { data, error } = await supabase.auth.getSession();
        if (error) throw error;
        console.log('App: Session data:', data);
        if (data.session && data.session.user) {
          setSession(data.session);
          setUser(data.session.user);
          console.log('App: User authenticated:', data.session.user.id);
          await ensureProfileAndWallet(data.session.user);
          await Promise.all([
            fetchUserProfile(data.session.user.id),
            restoreMiningState(data.session.user.id),
          ]);
        } else {
          console.log('App: No active session found');
          setUser(null);
          setSession(null);
          setMiningState({
            status: 'stopped',
            hashRate: 0,
            btcMined: 0,
            networkSpeed: 0,
            sessionId: null,
            lastUpdate: null,
          });
        }
      } catch (err) {
        console.error('App: Session restore error:', err);
        setError(`Failed to restore session: ${err.message}`);
      } finally {
        setIsLoading(false);
      }
    };
    getSession();

    const { data: authListener } = supabase.auth.onAuthStateChange(async (event, session) => {
      console.log('App: Auth state changed:', event, session);
      setSession(session);
      setUser(session?.user ?? null);
      if (session?.user) {
        await ensureProfileAndWallet(session.user);
        await Promise.all([
          fetchUserProfile(session.user.id),
          restoreMiningState(session.user.id),
        ]);
      } else {
        console.log('App: Resetting mining state due to logout');
        setMiningState({
          status: 'stopped',
          hashRate: 0,
          btcMined: 0,
          networkSpeed: 0,
          sessionId: null,
          lastUpdate: null,
        });
        miningAnimationActive = false;
      }
    });

    return () => {
      authListener?.subscription.unsubscribe();
    };
  }, []);

  const ensureProfileAndWallet = async (user) => {
    try {
      // Pastikan profil ada
      const { data: profileData, error: profileError } = await supabase
        .from('profiles')
        .select('id, referral_code')
        .eq('id', user.id)
        .maybeSingle();

      if (profileError && profileError.code !== 'PGRST116') {
        throw profileError;
      }

      if (!profileData) {
        console.log('ensureProfileAndWallet: Creating profile for user:', user.id);
        const referralCode = generateReferralCode(); // Gunakan fungsi global
        const { error: insertProfileError } = await supabase.from('profiles').insert({
          id: user.id,
          email: user.email,
          full_name: user.user_metadata?.full_name || '',
          phone_number: '',
          profile_photo: '',
          referral_code: referralCode,
          created_at: new Date().toISOString(),
        });
        if (insertProfileError) throw insertProfileError;
      } else if (!profileData.referral_code) {
        console.log('ensureProfileAndWallet: Updating referral code for user:', user.id);
        const referralCode = generateReferralCode(); // Gunakan fungsi global
        const { error: updateProfileError } = await supabase
          .from('profiles')
          .update({ referral_code: referralCode })
          .eq('id', user.id);
        if (updateProfileError) throw updateProfileError;
      }

      // Pastikan wallet ada
      const { data: walletData, error: walletError } = await supabase
        .from('wallet')
        .select('user_id')
        .eq('user_id', user.id)
        .maybeSingle();

      if (walletError && walletError.code !== 'PGRST116') {
        throw walletError;
      }

      if (!walletData) {
        console.log('ensureProfileAndWallet: Creating wallet for user:', user.id);
        const { error: insertWalletError } = await supabase.from('wallet').insert({
          user_id: user.id,
          balance: 0,
          last_updated: new Date().toISOString(),
        });
        if (insertWalletError) throw insertWalletError;
      }
    } catch (err) {
      console.error('ensureProfileAndWallet: Error:', err);
      setError(`Failed to ensure profile or wallet: ${err.message}`);
    }
  };

  const fetchUserProfile = async (userId) => {
    try {
      console.log('fetchUserProfile: Fetching profile for user:', userId);
      const { data, error } = await supabase
        .from('profiles')
        .select('full_name, phone_number, profile_photo, email, referral_code, referred_by')
        .eq('id', userId)
        .single();

      if (error) {
        if (error.code === 'PGRST116') {
          const referralCode = generateReferralCode(); // Gunakan fungsi global
          console.log('fetchUserProfile: Creating profile for user:', userId);
          const { error: insertError } = await supabase.from('profiles').insert({
            id: userId,
            full_name: '',
            phone_number: '',
            profile_photo: '',
            email: user?.email || '',
            referral_code: referralCode,
            created_at: new Date().toISOString(),
          });
          if (insertError) throw insertError;
          setProfile({
            full_name: '',
            phone_number: '',
            profile_photo: null,
            profile_photo_url: '',
            email: user?.email || '',
            referral_code: referralCode,
            referred_by: null,
          });
        } else {
          throw error;
        }
      } else {
        console.log('fetchUserProfile: Profile data:', data);
        setProfile({
          full_name: data.full_name || '',
          phone_number: data.phone_number || '',
          profile_photo: null,
          profile_photo_url: data.profile_photo || '',
          email: data.email || user?.email || '',
          referral_code: data.referral_code || generateReferralCode(),
          referred_by: data.referred_by || null,
        });
      }
    } catch (err) {
      console.error('fetchUserProfile: Error:', err);
      setError(`Failed to fetch profile: ${err.message}`);
    }
  };

  const restoreMiningState = async (userId) => {
    try {
      console.log('restoreMiningState: Restoring mining state for user:', userId);
      // Bersihkan sesi duplikat
      const { data: activeSessions, error: fetchError } = await supabase
        .from('mining_sessions')
        .select('id')
        .eq('user_id', userId)
        .is('end_time', null);

      if (fetchError) {
        console.error('restoreMiningState: Failed to fetch active sessions:', fetchError);
        throw fetchError;
      }

      if (activeSessions && activeSessions.length > 1) {
        console.log('restoreMiningState: Cleaning up duplicate sessions for user:', userId);
        const sessionIdsToDelete = activeSessions.slice(1).map((session) => session.id);
        const { error: deleteError } = await supabase
          .from('mining_sessions')
          .delete()
          .in('id', sessionIdsToDelete);
        if (deleteError) {
          console.error('restoreMiningState: Failed to delete duplicate sessions:', deleteError);
          throw deleteError;
        }
      }

      // Ambil sesi aktif
      const { data, error } = await supabase
        .from('mining_sessions')
        .select('*')
        .eq('user_id', userId)
        .is('end_time', null)
        .limit(1)
        .maybeSingle();

      if (error) {
        console.error('restoreMiningState: Failed to restore mining state:', error);
        throw new Error(`Failed to restore mining state: ${error.message}`);
      }

      if (data) {
        console.log('restoreMiningState: Restored mining session:', data.id);
        setMiningState({
          status: 'mining',
          hashRate: data.hash_rate || 0,
          btcMined: data.btc_mined || 0,
          networkSpeed: data.network_speed || 0,
          sessionId: data.id,
          lastUpdate: new Date().toISOString(),
        });
        miningAnimationActive = true;
      } else {
        console.log('restoreMiningState: No active mining session found');
        // Periksa localStorage untuk pemulihan
        const savedState = localStorage.getItem('miningState');
        if (savedState) {
          const parsedState = JSON.parse(savedState);
          if (parsedState.userId === userId && parsedState.sessionId) {
            console.log('restoreMiningState: Restoring from localStorage:', parsedState);
            const { data: sessionData, error: sessionError } = await supabase
              .from('mining_sessions')
              .select('id, btc_mined')
              .eq('id', parsedState.sessionId)
              .eq('user_id', userId)
              .single();
            if (sessionError || !sessionData) {
              console.error('restoreMiningState: Invalid session in localStorage:', sessionError);
              localStorage.removeItem('miningState');
              setMiningState({
                status: 'stopped',
                hashRate: 0,
                btcMined: 0,
                networkSpeed: 0,
                sessionId: null,
                lastUpdate: null,
              });
              return;
            }

            // Simpan BTC yang ditambang ke wallet
            const { data: walletData, error: walletError } = await supabase
              .from('wallet')
              .select('balance')
              .eq('user_id', userId)
              .maybeSingle();
            if (walletError && walletError.code !== 'PGRST116') throw walletError;

            const newBalance = (walletData?.balance || 0) + parsedState.btc_mined;
            const { error: updateWalletError } = await supabase
              .from('wallet')
              .upsert({
                user_id: userId,
                balance: newBalance,
                last_updated: new Date().toISOString(),
              });
            if (updateWalletError) throw updateWalletError;

            // Tandai sesi sebagai selesai
            const { error: updateSessionError } = await supabase
              .from('mining_sessions')
              .update({
                btc_mined: parsedState.btc_mined,
                end_time: new Date().toISOString(),
              })
              .eq('id', parsedState.sessionId)
              .eq('user_id', userId);
            if (updateSessionError) throw updateSessionError;

            // Catat transaksi
            const { error: transactionError } = await supabase
              .from('transactions')
              .insert([
                {
                  user_id: userId,
                  type: 'mining',
                  amount: parsedState.btc_mined,
                  description: 'Mining session restored from localStorage',
                  created_at: new Date().toISOString(),
                },
              ]);
            if (transactionError) throw transactionError;

            localStorage.removeItem('miningState');
            console.log('restoreMiningState: Successfully restored and saved mining data');
          } else {
            localStorage.removeItem('miningState');
          }
        }
        setMiningState({
          status: 'stopped',
          hashRate: 0,
          btcMined: 0,
          networkSpeed: 0,
          sessionId: null,
          lastUpdate: null,
        });
      }
    } catch (err) {
      console.error('restoreMiningState: Error:', err);
      setError(`Failed to restore mining state: ${err.message}`);
    }
  };

  const handleLogout = async () => {
    try {
      const { error } = await supabase.auth.signOut();
      if (error) throw error;
      setUser(null);
      setSession(null);
      setActiveTab('home');
      setProfile({
        full_name: '',
        phone_number: '',
        profile_photo: null,
        profile_photo_url: '',
        email: '',
        referral_code: '',
        referred_by: null,
      });
      setMiningState({
        status: 'stopped',
        hashRate: 0,
        btcMined: 0,
        networkSpeed: 0,
        sessionId: null,
        lastUpdate: null,
      });
      miningAnimationActive = false;
      localStorage.removeItem('miningState');
    } catch (err) {
      setError(`Failed to logout: ${err.message}`);
    }
  };

  const toggleDarkMode = () => {
    const newMode = !darkMode;
    setDarkMode(newMode);
    localStorage.setItem('darkMode', newMode);
    if (newMode) {
      document.documentElement.classList.add('dark');
    } else {
      document.documentElement.classList.remove('dark');
    }
  };

  const changeLanguage = (lang) => {
    setLanguage(lang);
  };

  if (isLoading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <i className="bi bi-arrow-repeat animate-spin text-4xl text-gold-600"></i>
      </div>
    );
  }

  if (!user) {
    return (
      <AuthPage
        setActiveTab={setActiveTab}
        t={t}
        language={language}
        changeLanguage={changeLanguage}
        setUser={setUser}
        setSession={setSession}
      />
    );
  }

  return (
    <div className={`min-h-screen flex flex-col md:flex-row ${darkMode ? 'dark' : ''}`}>
      {error && (
        <div className="fixed top-4 right-4 bg-red-100 dark:bg-red-900 border border-red-400 dark:border-red-700 text-red-700 dark:text-red-100 px-4 py-3 rounded shadow-lg z-50">
          {error}
          <button
            onClick={() => setError('')}
            className="ml-2 text-red-700 dark:text-red-100 hover:text-red-900 dark:hover:text-red-300"
          >
            <i className="bi bi-x"></i>
          </button>
        </div>
      )}
      <Sidebar
  activeTab={activeTab}
  setActiveTab={setActiveTab}
  isMobileMenuOpen={isMobileMenuOpen}
  profilePhoto={profile.profile_photo_url}
  t={t}
  setIsMobileMenuOpen={setIsMobileMenuOpen}
  handleLogout={handleLogout}
      />
      <div className="flex-1 flex flex-col">
        <TopNavbar
  handleLogout={handleLogout} // <-- Penting!
  isMobileMenuOpen={isMobileMenuOpen}
  setIsMobileMenuOpen={setIsMobileMenuOpen}
  profilePhoto={profile.profile_photo_url}
  darkMode={darkMode}
  toggleDarkMode={toggleDarkMode}
  t={t}
  language={language}
  changeLanguage={changeLanguage}
/>
        <main className="flex-grow p-4 md:p-6 main-content">
  {activeTab === 'home' && <HomePage t={t} user={user} />} {/* Tambahkan user di sini */}
  {activeTab === 'dashboard' && (
    <DashboardPage
      user={user}
      t={t}
      miningState={miningState}
      setMiningState={setMiningState}
      profile={profile}
    />
  )}
  {activeTab === 'profile' && (
    <ProfilePage
      profile={profile}
      setProfile={setProfile}
      userId={user.id}
      fetchUserProfile={fetchUserProfile}
      t={t}
    />
  )}
  {activeTab === 'wallet' && <WalletPage user={user} t={t} />}
  {activeTab === 'leaderboard' && <LeaderboardPage user={user} t={t} />}
  {activeTab === 'settings' && (
    <SettingsPage darkMode={darkMode} toggleDarkMode={toggleDarkMode} t={t} />
  )}
</main>s
        <MobileBottomNav activeTab={activeTab} setActiveTab={setActiveTab} t={t} />
      </div>
    </div>
  );
}
function Sidebar({ activeTab, setActiveTab, isMobileMenuOpen, profilePhoto, t, setIsMobileMenuOpen, handleLogout }) {
  const navItems = [
    { id: 'home', icon: 'bi-house', label: t('welcome') },
    { id: 'dashboard', icon: 'bi-speedometer2', label: t('dashboard') },
    { id: 'profile', icon: 'bi-person', label: t('profile') },
    { id: 'wallet', icon: 'bi-wallet', label: t('wallet') },
    { id: 'leaderboard', icon: 'bi-trophy', label: t('leaderboard') },
    { id: 'settings', icon: 'bi-gear', label: t('settings') },
  ];

  return (
    <>
      <div
        className={`sidebar-overlay ${isMobileMenuOpen ? 'sidebar-open' : ''}`}
        onClick={() => setIsMobileMenuOpen(false)}
      />
      <div
        className={`sidebar ${isMobileMenuOpen ? 'sidebar-open' : ''} w-96 bg-gray-800 text-white shadow-lg fixed top-0 left-0 h-screen z-20 flex flex-col`}
      >
        {isMobileMenuOpen && (
          <button
            className="sidebar-close-btn md:hidden p-4"
            onClick={() => setIsMobileMenuOpen(false)}
          >
            <i className="bi bi-x-lg text-xl text-white"></i>
          </button>
        )}
        <div className="p-6 flex items-center border-b border-gray-700 gold-gradient">
          <i className="bi bi-currency-bitcoin text-white text-3xl mr-3"></i>
          <span className="text-2xl font-semibold text-white">Gold Miner</span>
        </div>
        <div className="flex-grow overflow-y-auto p-6">
          {navItems.map((item) => (
            <button
              key={item.id}
              onClick={() => {
                setActiveTab(item.id);
                setIsMobileMenuOpen(false);
              }}
              className={`w-full px-4 py-3 rounded-lg text-base font-medium flex items-center mb-3 transition-all ${
                activeTab === item.id
                  ? 'bg-gray-900 text-gold-600 text-lg font-bold gold-gradient'
                  : 'text-gray-300 hover:bg-gray-700 hover:text-white'
              }`}
            >
              <i
                className={`bi ${item.icon} mr-4 text-xl ${
                  activeTab === item.id ? 'text-white' : 'text-gold-400'
                }`}
              ></i>
              {item.label}
            </button>
          ))}
        </div>
        <div className="p-6 border-t border-gray-700">
          <div className="flex items-center mb-4">
            {profilePhoto ? (
              <img className="h-10 w-10 rounded-full mr-4 border-2 border-gold-400" src={profilePhoto || "/placeholder.svg"} alt="Profile" />
            ) : (
              <i className="bi bi-person-circle text-3xl mr-4 text-gold-400"></i>
            )}
            <span className="text-base text-gold-200">{t('welcome')}, Miner</span>
          </div>
          <button
            onClick={handleLogout}
            className="w-full mt-2 bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-md font-medium flex items-center justify-center transition-colors duration-300"
          >
            <i className="bi bi-box-arrow-right mr-2"></i> {t('logout')}
          </button>
        </div>
      </div>
    </>
  );
}


// Top Navbar Component
function TopNavbar({
  handleLogout,
  isMobileMenuOpen,
  setIsMobileMenuOpen,
  profilePhoto,
  darkMode,
  toggleDarkMode,
  t,
  language,
  changeLanguage,
}) {
  return (
    <nav className="bg-gray-800 text-white shadow-lg md:hidden">
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div className="flex justify-between h-16">
          <div className="flex items-center">
            <button
              onClick={() => setIsMobileMenuOpen(!isMobileMenuOpen)}
              className="inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-white hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-white"
            >
              <span className="sr-only">Open menu</span>
              <i className={`bi ${isMobileMenuOpen ? 'bi-x' : 'bi-list'} text-2xl`}></i>
            </button>
          </div>
          <div className="flex items-center space-x-4">
            <div className="language-selector relative">
              <button className="flex items-center text-sm text-gold-300">
                <i className="bi bi-translate mr-1"></i>
                {language === 'en' ? 'EN' : 'ID'}
              </button>
              <div className="language-dropdown bg-gray-800 rounded-md shadow-lg py-1">
                <button
                  onClick={() => changeLanguage('en')}
                  className="w-full text-left px-4 py-2 text-sm text-white hover:bg-gray-700 flex items-center"
                >
                  <i className="bi bi-check-lg mr-2 opacity-0"></i>
                  English
                  {language === 'en' && <i className="bi bi-check-lg ml-2 text-gold-400"></i>}
                </button>
                <button
                  onClick={() => changeLanguage('id')}
                  className="w-full text-left px-4 py-2 text-sm text-white hover:bg-gray-700 flex items-center"
                >
                  <i className="bi bi-check-lg mr-2 opacity-0"></i>
                  Bahasa Indonesia
                  {language === 'id' && <i className="bi bi-check-lg ml-2 text-gold-400"></i>}
                </button>
              </div>
            </div>
            <button
              onClick={toggleDarkMode}
              className="p-2 rounded-md text-gray-400 hover:text-white hover:bg-gray-700"
            >
              <i className={`bi ${darkMode ? 'bi-sun' : 'bi-moon'} text-xl`}></i>
            </button>
            <div className="ml-4 relative">
              <div className="flex items-center">
                {profilePhoto ? (
                  <img className="h-8 w-8 rounded-full" src={profilePhoto || "/placeholder.svg"} alt="Profile" />
                ) : (
                  <i className="bi bi-person-circle text-2xl text-gold-400"></i>
                )}
                <button
                  onClick={handleLogout}
                  className="ml-4 px-3 py-2 rounded-md text-sm font-medium text-gray-300 hover:bg-gray-700 hover:text-white flex items-center"
                >
                  <i className="bi bi-box-arrow-right mr-1"></i> {t('logout')}
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </nav>
  );
}

// Mobile Bottom Navigation Component
function MobileBottomNav({ activeTab, setActiveTab, t }) {
  const navItems = [
    { id: 'home', icon: 'bi-house', label: t('welcome') },
    { id: 'dashboard', icon: 'bi-speedometer2', label: t('mining') },
    { id: 'profile', icon: 'bi-person', label: t('profile') },
    { id: 'wallet', icon: 'bi-wallet', label: t('wallet') },
  ];

  return (
    <div className="md:hidden fixed bottom-0 left-0 right-0 bg-gray-800 text-white shadow-lg-t z-10">
      <div className="flex justify-around items-center h-16">
        {navItems.map((item) => (
          <button
            key={item.id}
            onClick={() => setActiveTab(item.id)}
            className={`flex flex-col items-center justify-center w-full h-full transition-all ${
              activeTab === item.id ? 'text-gold-400 scale-110' : 'text-gray-300'
            }`}
          >
            <i className={`bi ${item.icon} text-xl mobile-icon`}></i>
            <span className="text-xs mt-1">{item.label}</span>
          </button>
        ))}
      </div>
    </div>
  );
}

function AuthPage({ setActiveTab, t, language, changeLanguage, setUser, setSession }) {
  const [email, setEmail] = React.useState('');
  const [password, setPassword] = React.useState('');
  const [fullName, setFullName] = React.useState('');
  const [referralCode, setReferralCode] = React.useState('');
  const [isLogin, setIsLogin] = React.useState(true);
  const [error, setError] = React.useState('');
  const [success, setSuccess] = React.useState('');
  const [isLoading, setIsLoading] = React.useState(false);

  // Check for referral code in URL
  React.useEffect(() => {
    const urlParams = new URLSearchParams(window.location.search);
    const refCode = urlParams.get('ref');
    if (refCode) {
      setReferralCode(refCode);
    }
  }, []);

  const handleAuth = async (e) => {
  e.preventDefault();
  setIsLoading(true);
  setError('');
  setSuccess('');

  try {
    if (isLogin) {
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) throw error;
      if (data.user && data.session) {
        setUser(data.user);
        setSession(data.session);
        setActiveTab('dashboard');
      }
    } else {
      const newReferralCode = generateReferralCode(); // Gunakan fungsi global
      const { data, error: signUpError } = await supabase.auth.signUp({
        email,
        password,
        options: {
          data: {
            full_name: fullName,
            referral_code: newReferralCode,
          },
        },
      });

      if (signUpError) {
        console.error('handleAuth: Sign-up error:', signUpError);
        if (signUpError.status === 429) {
          throw new Error('Too many requests. Please wait a moment and try again.');
        }
        throw new Error(signUpError.message);
      }

      if (data.user) {
        let referredBy = null;
        if (referralCode) {
          const { data: referrer, error: referrerError } = await supabase
            .from('profiles')
            .select('id')
            .eq('referral_code', referralCode)
            .single();
          if (referrerError || !referrer) {
            console.warn('Invalid referral code:', referralCode);
          } else {
            referredBy = referrer.id;
            // Tambahkan reward referral ke wallet referrer
            const reward = 0.01;
            // Update wallet referrer
            const { data: refWallet } = await supabase
              .from('wallet')
              .select('balance')
              .eq('user_id', referrer.id)
              .maybeSingle();
            await supabase.from('wallet').upsert({
              user_id: referrer.id,
              balance: (refWallet?.balance || 0) + reward,
              last_updated: new Date().toISOString()
            });
            // Catat transaksi referral
            await supabase.from('referral_transactions').insert({
              referrer_id: referrer.id,
              referred_id: data.user.id,
              amount: reward,
              description: 'Reward referral otomatis',
              created_at: new Date().toISOString()
            });
          }
        }

        // Tunggu session aktif sebelum upsert profile
        if (data.session) {
          await supabase.auth.setSession(data.session);
          // Upsert profile dengan full_name dari input dan referred_by
          const { error: profileError } = await supabase.from('profiles').upsert({
            id: data.user.id,
            email: data.user.email,
            full_name: fullName, // Pastikan dari input!
            phone_number: '',
            profile_photo: '',
            referral_code: newReferralCode,
            referred_by: referredBy,
            created_at: new Date().toISOString(),
          });

          if (profileError) {
            console.error('handleAuth: Profile creation error:', profileError);
            throw new Error(profileError.message);
          }

          // Hapus pembuatan wallet di sini, cukup di ensureProfileAndWallet!
          // (JANGAN buat wallet di sini)
        }

        setSuccess('Registration successful! Please check your email for confirmation.');
        setIsLogin(true);
      } else {
        throw new Error('No user returned after sign-up');
      }
    }
  } catch (err) {
    console.error('handleAuth: Error:', err);
    let errorMessage = `Authentication failed: ${err.message}`;
    if (err.message.includes('Too many requests')) {
      errorMessage = 'Too many requests. Retrying in 10 seconds...';
      setTimeout(() => handleAuth(e), 10000); // Retry setelah 10 detik
    }
    setError(errorMessage);
  } finally {
    setIsLoading(false);
  }
};


  const handleOAuthLogin = async (provider) => {
    setIsLoading(true);
    setError('');
    console.log('handleOAuthLogin: Initiating OAuth login with provider:', provider);
    try {
      const { error } = await supabase.auth.signInWithOAuth({
        provider,
        options: {
          redirectTo: window.location.origin, // Pastikan redirect kembali ke aplikasi
        },
      });
      if (error) {
        console.error('handleOAuthLogin: OAuth error:', error);
        throw error;
      }
      console.log('handleOAuthLogin: OAuth request initiated, awaiting redirect');
    } catch (err) {
      console.error('handleOAuthLogin: Error:', err);
      setError(t('oauthLoginFailed') || 'Failed to login with OAuth. Please try again.');
    } finally {
      setIsLoading(false);
    }
  };

  const handlePasswordReset = async () => {
    if (!email) {
      setError('Please enter your email to reset password');
      return;
    }

    setIsLoading(true);
    setError('');

    try {
      const { error } = await supabase.auth.resetPasswordForEmail(email);
      if (error) throw error;
      setSuccess('Password reset link sent to your email');
    } catch (err) {
      setError(`Password reset failed: ${err.message}`);
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50 dark:bg-gray-900 py-12 px-4 sm:px-6 lg:px-8 transition-colors duration-300">
      {isLoading && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="flex flex-col items-center">
            <i className="bi bi-arrow-repeat animate-spin text-4xl text-gold-600 mb-2"></i>
            <p className="text-white text-lg">{t('loggingIn') || 'Logging in...'}</p>
          </div>
        </div>
      )}
      <div className="max-w-md w-full space-y-8 bg-white dark:bg-gray-800 p-8 rounded-lg shadow-md crystal-card transition-colors duration-300">
        <div className="text-center">
          <i className="bi bi-currency-bitcoin text-5xl text-gold-600 mb-4"></i>
          <h2 className="mt-6 text-3xl font-extrabold text-gray-900 dark:text-white gold-text-gradient">
            {isLogin ? t('signIn') : t('signUp')}
          </h2>
        </div>

        {error && (
          <div
            className="bg-red-100 dark:bg-red-900 border border-red-400 dark:border-red-700 text-red-700 dark:text-red-100 px-4 py-3 rounded relative"
            role="alert"
          >
            <span className="block sm:inline">{error}</span>
            <button
              onClick={() => setError('')}
              className="ml-2 text-red-700 dark:text-red-100 hover:text-red-900 dark:hover:text-red-300"
            >
              <i className="bi bi-x"></i>
            </button>
          </div>
        )}

        {success && (
          <div
            className="bg-green-100 dark:bg-green-900 border border-green-400 dark:border-green-700 text-green-700 dark:text-green-100 px-4 py-3 rounded relative"
            role="alert"
          >
            <span className="block sm:inline">{success}</span>
          </div>
        )}

        <form className="mt-8 space-y-6" onSubmit={handleAuth}>
          <div className="rounded-md shadow-sm space-y-4">
            {!isLogin && (
              <>
                <div>
                  <label htmlFor="full-name" className="sr-only">
                    {t('fullName')}
                  </label>
                  <input
                    id="full-name"
                    name="full-name"
                    type="text"
                    required
                    className="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 placeholder-gray-500 dark:placeholder-gray-400 text-gray-900 dark:text-white rounded-t-md focus:outline-none focus:ring-gold-500 focus:border-gold-500 focus:z-10 sm:text-sm bg-white dark:bg-gray-700"
                    placeholder={t('fullName')}
                    value={fullName}
                    onChange={(e) => setFullName(e.target.value)}
                  />
                </div>
                <div>
                  <label htmlFor="referral-code" className="sr-only">
                    Referral Code
                  </label>
                  <input
                    id="referral-code"
                    name="referral-code"
                    type="text"
                    className="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 placeholder-gray-500 dark:placeholder-gray-400 text-gray-900 dark:text-white focus:outline-none focus:ring-gold-500 focus:border-gold-500 focus:z-10 sm:text-sm bg-white dark:bg-gray-700"
                    placeholder="Referral Code (optional)"
                    value={referralCode}
                    onChange={(e) => setReferralCode(e.target.value)}
                  />
                </div>
              </>
            )}
            <div>
              <label htmlFor="email-address" className="sr-only">
                {t('email')}
              </label>
              <input
                id="email-address"
                name="email"
                type="email"
                autoComplete="email"
                required
                className="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 placeholder-gray-500 dark:placeholder-gray-400 text-gray-900 dark:text-white focus:outline-none focus:ring-gold-500 focus:border-gold-500 focus:z-10 sm:text-sm bg-white dark:bg-gray-700"
                placeholder={t('email')}
                value={email}
                onChange={(e) => setEmail(e.target.value)}
              />
            </div>
            <div>
              <label htmlFor="password" className="sr-only">
                {t('password')}
              </label>
              <input
                id="password"
                name="password"
                type="password"
                autoComplete="current-password"
                required
                className="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 placeholder-gray-500 dark:placeholder-gray-400 text-gray-900 dark:text-white rounded-b-md focus:outline-none focus:ring-gold-500 focus:border-gold-500 focus:z-10 sm:text-sm bg-white dark:bg-gray-700"
                placeholder={t('password')}
                value={password}
                onChange={(e) => setPassword(e.target.value)}
              />
            </div>
          </div>

          <div className="flex items-center justify-between">
            {isLogin && (
              <div className="text-sm">
                <button
                  type="button"
                  onClick={handlePasswordReset}
                  className="font-medium text-gold-600 hover:text-gold-500 dark:text-gold-400 dark:hover:text-gold-300"
                >
                  {t('forgotPassword')}
                </button>
              </div>
            )}
            <div className="text-sm">
              <button
                type="button"
                onClick={() => setIsLogin(!isLogin)}
                className="font-medium text-gold-600 hover:text-gold-500 dark:text-gold-400 dark:hover:text-gold-300"
              >
                {isLogin ? t('needAccount') : t('haveAccount')}
              </button>
            </div>
          </div>

          <div>
            <button
              type="submit"
              disabled={isLoading}
              className="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-gold-600 hover:bg-gold-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gold-500 disabled:opacity-50"
            >
              {isLoading ? (
                <span className="flex items-center">
                  <i className="bi bi-arrow-repeat animate-spin mr-2"></i>
                  Processing...
                </span>
              ) : isLogin ? t('signIn') : t('signUp')}
            </button>
          </div>
        </form>

        <div className="mt-6">
          <div className="relative">
            <div className="absolute inset-0 flex items-center">
              <div className="w-full border-t border-gray-300 dark:border-gray-600"></div>
            </div>
            <div className="relative flex justify-center text-sm">
              <span className="px-2 bg-white dark:bg-gray-800 text-gray-500 dark:text-gray-400">
                {t('orContinueWith')}
              </span>
            </div>
          </div>

          <div className="mt-6 grid grid-cols-2 gap-3">
            <button
              onClick={() => handleOAuthLogin('github')}
              disabled={isLoading}
              className="w-full inline-flex justify-center py-2 px-4 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-sm font-medium text-gray-500 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-600 disabled:opacity-50"
            >
              <i className="bi bi-github mr-2"></i> GitHub
            </button>
            <button
              onClick={() => handleOAuthLogin('google')}
              disabled={isLoading}
              className="w-full inline-flex justify-center py-2 px-4 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-sm font-medium text-gray-500 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-600 disabled:opacity-50"
            >
              <i className="bi bi-google mr-2"></i> Google
            </button>
          </div>
        </div>

        <div className="mt-4 flex justify-center">
          <div className="language-selector relative">
            <button className="flex items-center text-sm text-gold-600 dark:text-gold-400">
              <i className="bi bi-translate mr-1"></i>
              {language === 'en' ? 'English' : 'Bahasa Indonesia'}
            </button>
            <div className="language-dropdown bg-white dark:bg-gray-800 rounded-md shadow-lg py-1 border border-gray-200 dark:border-gray-700">
              <button
                onClick={() => changeLanguage('en')}
                className="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center"
              >
                <i className="bi bi-check-lg mr-2 opacity-0"></i>
                English
                {language === 'en' && (
                  <i className="bi bi-check-lg ml-2 text-gold-600 dark:text-gold-400"></i>
                )}
              </button>
              <button
                onClick={() => changeLanguage('id')}
                className="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center"
              >
                <i className="bi bi-check-lg mr-2 opacity-0"></i>
                Bahasa Indonesia
                {language === 'id' && (
                  <i className="bi bi-check-lg ml-2 text-gold-600 dark:text-gold-400"></i>
                )}
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

function HomePage({ t, user }) {
  const [tasks, setTasks] = React.useState([]);
  const [userTasks, setUserTasks] = React.useState([]);
  const [isLoading, setIsLoading] = React.useState(false);
  const [isAuthLoading, setIsAuthLoading] = React.useState(true);
  const [error, setError] = React.useState('');
  const [taskLoading, setTaskLoading] = React.useState({});
  const [hasActiveBooster, setHasActiveBooster] = React.useState(false); // Added: Track active booster

  // Fetch tasks and user task completions
  const fetchTasks = async () => {
    setIsLoading(true);
    try {
      console.log('Fetching tasks, user:', user);
      // Fetch all tasks
      const { data: tasksData, error: tasksError } = await supabase
        .from('tasks')
        .select('*');

      if (tasksError) throw new Error(`Gagal mengambil tugas: ${tasksError.message}`);
      console.log('Tasks fetched:', tasksData);

      // Filter duplicates by name
      const uniqueTasks = [];
      const taskNames = new Set();
      for (const task of tasksData) {
        if (!taskNames.has(task.name)) {
          taskNames.add(task.name);
          uniqueTasks.push(task);
        }
      }
      setTasks(uniqueTasks);

      if (user?.id) {
        // Ensure user profile exists
        const { data: profileData, error: profileError } = await supabase
          .from('profiles')
          .select('id')
          .eq('id', user.id)
          .single();

        if (profileError && profileError.code !== 'PGRST116') {
          throw new Error(`Gagal memeriksa profil: ${profileError.message}`);
        }
        if (!profileData) {
          console.log('No profile found, creating one for user:', user.id);
          const { error: insertProfileError } = await supabase
            .from('profiles')
            .insert({
              id: user.id,
              username: user.email || `user_${user.id.slice(0, 8)}`,
              created_at: new Date().toISOString(),
              updated_at: new Date().toISOString(),
            });

          if (insertProfileError) throw new Error(`Gagal membuat profil: ${insertProfileError.message}`);
          console.log('Profile created for user:', user.id);
        } else {
          console.log('Profile fetched:', profileData);
        }

        // Fetch user task completions
        const { data: userTasksData, error: userTasksError } = await supabase
          .from('user_tasks')
          .select('task_id, completed_at')
          .eq('user_id', user.id);

        if (userTasksError) throw new Error(`Gagal mengambil tugas pengguna: ${userTasksError.message}`);
        console.log('User tasks fetched:', userTasksData);
        setUserTasks(userTasksData || []);

        // Check for active booster purchases
        const { data: purchasesData, error: purchasesError } = await supabase
  .from('user_boost_purchases')
  .select('id, purchased_at, expires_at')
  .eq('user_id', user.id)
  .gte('expires_at', new Date().toISOString());

if (purchasesError) throw new Error(`Gagal mengambil pembelian booster: ${purchasesError.message}`);
console.log('Booster purchases:', purchasesData);
setHasActiveBooster((purchasesData || []).length > 0);

        if (purchasesError) throw new Error(`Gagal mengambil pembelian booster: ${purchasesError.message}`);
        console.log('Booster purchases:', purchasesData);
        setHasActiveBooster((purchasesData || []).length > 0);
      } else {
        console.log('No user, skipping user tasks fetch');
      }
    } catch (err) {
      setError(err.message || 'Gagal mengambil data tugas');
      console.error('Fetch tasks error:', err);
    } finally {
      setIsLoading(false);
    }
  };

  // Complete a task and update wallet
  const completeTask = async (task, completedAt = new Date().toISOString()) => {
    if (!task?.id) {
      setError('Tugas tidak valid');
      console.error('Invalid task:', task);
      return;
    }
    if (!user?.id) {
      setError('Silakan login untuk menyelesaikan tugas');
      console.log('No user logged in');
      window.location.href = '/login';
      return;
    }
    if (task.type === 'purchase' && !hasActiveBooster) {
      setError('Beli booster terlebih dahulu untuk menyelesaikan tugas ini');
      console.log('No active booster for Buy Booster task');
      return;
    }

    setTaskLoading((prev) => ({ ...prev, [task.id]: true }));
    try {
      // Ensure user profile exists
      const { data: profileData, error: profileError } = await supabase
        .from('profiles')
        .select('id')
        .eq('id', user.id)
        .single();

      if (profileError && profileError.code !== 'PGRST116') {
        throw new Error(`Gagal memeriksa profil: ${profileError.message}`);
      }
      if (!profileData) {
        console.log('No profile found, creating one for user:', user.id);
        const { error: insertProfileError } = await supabase
          .from('profiles')
          .insert({
            id: user.id,
            username: user.email || `user_${user.id.slice(0, 8)}`,
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString(),
          });

        if (insertProfileError) throw new Error(`Gagal membuat profil: ${insertProfileError.message}`);
        console.log('Profile created for user:', user.id);
      }

      // Check if task is already completed
      const { data: existingTask, error: checkError } = await supabase
        .from('user_tasks')
        .select('id')
        .eq('user_id', user.id)
        .eq('task_id', task.id)
        .maybeSingle();

      if (checkError && checkError.code !== 'PGRST116') {
        throw new Error(`Gagal memeriksa tugas: ${checkError.message}`);
      }
      if (existingTask) {
        setError('Tugas ini sudah selesai');
        console.log('Task already completed:', existingTask);
        return;
      }

      // Insert new task completion
      const { error: taskError } = await supabase
        .from('user_tasks')
        .insert({
          id: crypto.randomUUID(),
          user_id: user.id,
          task_id: task.id,
          completed_at: completedAt,
        });

      if (taskError) throw new Error(`Gagal menyelesaikan tugas: ${taskError.message}`);
      console.log('Task completion inserted');

      // Update wallet balance
      const { data: walletData, error: walletError } = await supabase
        .from('wallet')
        .select('balance')
        .eq('user_id', user.id)
        .maybeSingle();

      if (walletError && walletError.code !== 'PGRST116') throw new Error(`Gagal mengambil dompet: ${walletError.message}`);

      const newBalance = (walletData?.balance || 0) + task.reward;
      const { error: updateWalletError } = await supabase
        .from('wallet')
        .upsert({
          user_id: user.id,
          balance: newBalance,
          last_updated: new Date().toISOString(),
        });

      if (updateWalletError) throw new Error(`Gagal memperbarui dompet: ${updateWalletError.message}`);
      console.log('Wallet updated, new balance:', newBalance);

      // Log transaction
      const { error: transactionError } = await supabase
        .from('transactions')
        .insert({
          user_id: user.id,
          type: 'task_reward',
          amount: task.reward,
          description: `Reward dari tugas: ${task.name}`,
          created_at: new Date().toISOString(),
        });

      if (transactionError) {
        console.error('Failed to log transaction:', transactionError);
      } else {
        console.log('Transaction logged');
      }

      // Refresh user tasks
      const { data: userTasksData, error: userTasksError } = await supabase
        .from('user_tasks')
        .select('task_id, completed_at')
        .eq('user_id', user.id);

      if (userTasksError) throw new Error(`Gagal memperbarui tugas pengguna: ${userTasksError.message}`);
      setUserTasks(userTasksData || []);
      setError('');
    } catch (err) {
      setError(err.message || 'Gagal menyelesaikan tugas');
      console.error('Complete task error:', err);
    } finally {
      setTaskLoading((prev) => ({ ...prev, [task.id]: false }));
    }
  };

  // Check auth status and fetch tasks
  React.useEffect(() => {
    const checkAuth = async () => {
      console.log('Checking auth, user:', user);
      setIsAuthLoading(true);
      try {
        const { data: { session } } = await supabase.auth.getSession();
        console.log('Session check:', session);
        if (session?.user) {
          await fetchTasks();
        }
      } catch (err) {
        console.error('Auth check error:', err);
        setError('Gagal memeriksa autentikasi');
      } finally {
        setIsAuthLoading(false);
      }
    };

    checkAuth();
  }, [user]);

  if (isAuthLoading) {
    return (
      <div className="flex justify-center items-center h-screen">
        {/* Spinner dengan efek gradasi dan glow */}
        <div className="relative w-12 h-12">
                                <div className="absolute inset-0 border-4 border-t-transparent border-gold-400 rounded-full animate-spin [animation-duration:1.2s] bg-gradient-to-r from-gold-300/30 to-transparent opacity-50 blur-sm"></div>
                                <div className="absolute inset-0 border-4 border-t-gold-500 border-gold-200/50 rounded-full animate-spin [animation-duration:1.2s]"></div>
                                {/* Inner glow untuk kesan premium */}
                                <div className="absolute inset-2 bg-gold-500/10 rounded-full animate-pulse"></div>
                              </div>
                              {/* Teks dengan efek pulsating */}
                              <span className="ml-4 text-lg font-light text-gray-700 dark:text-gray-200 animate-[pulse_2s_ease-in-out_infinite]">
                                
                              </span>
      </div>
    );
  }

  return (
    <div className="ml-0 md:ml-96 px-4 md:px-6 max-w-full md:max-w-[calc(100%-384px)]">
      <style>
        {`
          .task-card {
            background: linear-gradient(135deg, #f3e7ff 0%, #e8d4ff 100%);
            border: 1px solid #d1c4e9;
            transition: transform 0.3s, box-shadow 0.3s;
          }
          .task-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
          }
          .task-button {
            background: linear-gradient(135deg, #7e57c2 0%, #ab47bc 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background 0.3s;
          }
          .task-button:hover {
            background: linear-gradient(135deg, #9575cd 0%, #ba68c8 100%);
          }
          .task-button:disabled {
            background: #bdbdbd;
            cursor: not-allowed;
          }
          .error-message {
            z-index: 1000;
            position: relative;
          }
        `}
      </style>

      {error && (
        <div className="bg-red-100 dark:bg-red-900 border border-red-400 dark:border-red-700 text-red-700 dark:text-red-100 px-4 py-3 rounded mb-4 error-message">
          {error}
        </div>
      )}

      <div className="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-8 crystal-card transition-colors duration-300 animate-slide-in">
        <h1 className="text-3xl font-bold text-gray-900 dark:text-white mb-6 section-title gold-text-gradient">
          {t('welcome')}
        </h1>
        <p className="text-gray-600 dark:text-gray-300 mb-6 text-lg leading-relaxed">
          Experience the thrill of Bitcoin mining without the expensive hardware! Our simulator lets you
          mine virtual Bitcoin based on your network speed and performance.
        </p>

        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
          <div className="bg-indigo-50 dark:bg-indigo-900 p-6 rounded-lg about-card transition-transform duration-300 hover:scale-105 hover:shadow-xl">
            <div className="flex items-center mb-3">
              <i className="bi bi-speedometer2 text-indigo-600 dark:text-indigo-300 text-2xl mr-3"></i>
              <h3 className="font-semibold text-indigo-800 dark:text-indigo-200 text-lg">
                Real-time Mining
              </h3>
            </div>
            <p className="text-gray-700 dark:text-gray-300 text-sm leading-relaxed">
              Start and stop mining anytime. Watch your hashrate adjust based on your network speed.
            </p>
          </div>

          <div className="bg-green-50 dark:bg-green-900 p-6 rounded-lg about-card transition-transform duration-300 hover:scale-105 hover:shadow-xl">
            <div className="flex items-center mb-3">
              <i className="bi bi-wallet text-green-600 dark:text-green-300 text-2xl mr-3"></i>
              <h3 className="font-semibold text-green-800 dark:text-green-200 text-lg">
                Track Earnings
              </h3>
            </div>
            <p className="text-gray-700 dark:text-gray-300 text-sm leading-relaxed">
              See your accumulated Bitcoin in your wallet and track your mining history.
            </p>
          </div>

          <div className="bg-yellow-50 dark:bg-yellow-900 p-6 rounded-lg about-card transition-transform duration-300 hover:scale-105 hover:shadow-xl">
            <div className="flex items-center mb-3">
              <i className="bi bi-trophy text-yellow-600 dark:text-yellow-300 text-2xl mr-3"></i>
              <h3 className="font-semibold text-yellow-800 dark:text-yellow-200 text-lg">
                Compete
              </h3>
            </div>
            <p className="text-gray-700 dark:text-gray-300 text-sm leading-relaxed">
              Compare your mining performance with others on the leaderboard.
            </p>
          </div>
        </div>

        <div className="bg-gray-50 dark:bg-gray-700 p-6 rounded-lg border border-gray-200 dark:border-gray-600 mb-8">
          <h3 className="font-semibold text-gray-800 dark:text-gray-200 text-lg mb-3">
            How it works:
          </h3>
          <ol className="list-decimal list-inside text-gray-700 dark:text-gray-300 space-y-3 text-sm">
            <li>Go to the Dashboard to start mining</li>
            <li>Your mining speed depends on your network connection</li>
            <li>Earn virtual Bitcoin based on your hashrate</li>
            <li>Track your earnings in your Wallet</li>
            <li>See how you rank against others on the Leaderboard</li>
          </ol>
        </div>

        <div className="bg-gray-50 dark:bg-gray-700 p-6 rounded-lg border border-gray-200 dark:border-gray-600">
          <h3 className="font-semibold text-gray-800 dark:text-gray-200 text-lg mb-4">
            Tasks - Earn More ₿Ǥɱ
          </h3>
          {tasks.length === 0 ? (
            <p className="text-gray-500 dark:text-gray-400">Tidak ada tugas tersedia.</p>
          ) : (
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              {tasks.map((task) => {
                const isCompleted = userTasks.some((ut) => ut.task_id === task.id);
                const isTaskLoading = taskLoading[task.id] || false;
                console.log(`Task: ${task.name}, isCompleted: ${isCompleted}, isLoading: ${isTaskLoading}, user: ${user ? user.id : 'none'}`);
                return (
                  <div
                    key={task.id}
                    className="task-card p-4 rounded-lg"
                  >
                    <div className="flex items-center mb-2">
                      <i
                        className={`bi ${
                          task.name.includes('Facebook')
                            ? 'bi-facebook'
                            : task.name.includes('Twitter')
                            ? 'bi-twitter'
                            : task.name.includes('Instagram')
                            ? 'bi-instagram'
                            : task.name.includes('YouTube')
                            ? 'bi-youtube'
                            : 'bi-lightning-charge-fill'
                        } text-purple-600 dark:text-purple-300 text-xl mr-2`}
                      ></i>
                      <h4 className="font-semibold text-purple-800 dark:text-purple-200">
                        {task.name}
                      </h4>
                    </div>
                    <p className="text-gray-700 dark:text-gray-300 text-sm mb-2">
                      {task.description}
                    </p>
                    <p className="text-gray-700 dark:text-gray-300 text-sm mb-3">
                      Reward: <span className="font-bold text-gold-600">{task.reward.toFixed(4)} ₿Ǥɱ</span>
                    </p>
                    <button
                      onClick={() => {
                        console.log('Complete Task button clicked for:', task.name);
                        completeTask(task);
                      }}
                      disabled={
                        isCompleted ||
                        isTaskLoading ||
                        !user ||
                        (task.type === 'purchase' && !hasActiveBooster)
                      }
                      className="task-button"
                    >
                      {isTaskLoading ? (
                        <span className="flex items-center">
                          <i className="bi bi-arrow-repeat animate-spin mr-2"></i>
                          Memproses...
                        </span>
                      ) : isCompleted ? (
                        'Selesai'
                      ) : !user ? (
                        'Login Diperlukan'
                      ) : task.type === 'purchase' && !hasActiveBooster ? (
                        'Beli booster dulu'
                      ) : (
                        'Complete Task'
                      )}
                    </button>
                  </div>
                );
              })}
            </div>
          )}
        </div>
      </div>
    </div>
  );
}

const DashboardPage = ({ user, t, miningState, setMiningState, profile }) => {
  const [miningHistory, setMiningHistory] = React.useState([]);
  const [isLoading, setIsLoading] = React.useState(false);
  const [error, setError] = React.useState('');
  const [wallet, setWallet] = React.useState({ balance: 0 });
  const [items, setItems] = React.useState([]);
  const [userItems, setUserItems] = React.useState([]);
  const [dailyMiningData, setDailyMiningData] = React.useState({ labels: [], values: [], boosterValues: [] });
  const [flipStates, setFlipStates] = React.useState({});

  // Toggle flip state on touch for mobile devices
  const handleTouchStart = (itemId) => {
    setFlipStates((prev) => ({
      ...prev,
      [itemId]: !prev[itemId],
    }));
  };

  // Fetch mining history
  const fetchMiningHistory = async () => {
    setIsLoading(true);
    try {
      const { data, error } = await supabase
        .from('mining_sessions')
        .select('*')
        .eq('user_id', user.id)
        .order('start_time', { ascending: false })
        .limit(10);

      if (error) throw error;
      setMiningHistory(data || []);
    } catch (err) {
      setError(`Gagal mengambil riwayat mining: ${err.message}`);
    } finally {
      setIsLoading(false);
    }
  };

  // Fetch daily mining data + booster bonus
  const fetchDailyMiningData = async () => {
    try {
      // Ambil sesi mining 7 hari terakhir
      const { data, error } = await supabase
        .from('mining_sessions')
        .select('start_time, btc_mined, id')
        .eq('user_id', user.id)
        .gte('start_time', new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString());

      if (error) throw error;

      // Ambil booster aktif user
      const { data: purchases } = await supabase
        .from('user_boost_purchases')
        .select('item_id, purchased_at, expires_at')
        .eq('user_id', user.id);

      // Ambil data item booster
      const { data: boostItems } = await supabase
        .from('boost_items')
        .select('id, boost');

      // Hitung hasil harian dan bonus booster
      const dailyData = {};
      const boosterData = {};

      data.forEach((session) => {
        const date = new Date(session.start_time).toLocaleDateString('id-ID', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric',
        });
        dailyData[date] = (dailyData[date] || 0) + (session.btc_mined || 0);

        // Hitung bonus booster
        let boosterBonus = 0;
        if (purchases && boostItems) {
          purchases.forEach((purchase) => {
            const item = boostItems.find((i) => i.id === purchase.item_id);
            if (
              item &&
              new Date(session.start_time) >= new Date(purchase.purchased_at) &&
              new Date(session.start_time) <= new Date(purchase.expires_at)
            ) {
              boosterBonus += ((item.boost - 1) * (session.btc_mined || 0));
            }
          });
        }
        boosterData[date] = (boosterData[date] || 0) + boosterBonus;
      });

      const labels = [];
      const values = [];
      const boosterValues = [];
      for (let i = 6; i >= 0; i--) {
        const date = new Date(Date.now() - i * 24 * 60 * 60 * 1000);
        const dateStr = date.toLocaleDateString('id-ID', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric',
        });
        labels.push(dateStr);
        values.push(dailyData[dateStr] || 0);
        boosterValues.push(boosterData[dateStr] || 0);
      }

      setDailyMiningData({ labels, values, boosterValues });
    } catch (err) {
      setError(`Gagal mengambil data mining harian: ${err.message}`);
    }
  };

  // Fetch available boost items
  const fetchItems = async () => {
    try {
      const { data: availableItems, error: itemsError } = await supabase
        .from('boost_items')
        .select('*');
      if (itemsError) throw itemsError;
      setItems(availableItems || []);

      const { data: purchasedItems, error: purchaseError } = await supabase
        .from('user_boost_purchases')
        .select('*')
        .eq('user_id', user.id)
        .gte('expires_at', new Date().toISOString());
      if (purchaseError) throw purchaseError;
      setUserItems(purchasedItems || []);
    } catch (err) {
      setError(`Gagal mengambil data item: ${err.message}`);
    }
  };

  // Test network speed
  const testNetworkSpeed = async () => {
    const startTime = performance.now();
    try {
      const response = await fetch('https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js', {
        method: 'GET',
        mode: 'cors',
        cache: 'no-store',
      });
      const data = await response.arrayBuffer();
      const endTime = performance.now();
      const duration = (endTime - startTime) / 1000;
      const bitsLoaded = data.byteLength * 8;
      const speedBps = bitsLoaded / duration;
      const speedMbps = speedBps / (1024 * 1024);
      return Math.max(speedMbps, 1);
    } catch (err) {
      try {
        const localResponse = await fetch('/assets/testfile.bin');
        const localData = await localResponse.arrayBuffer();
        const endTime = performance.now();
        const duration = (endTime - startTime) / 1000;
        const bitsLoaded = localData.byteLength * 8;
        const speedBps = bitsLoaded / duration;
        const speedMbps = speedBps / (1024 * 1024);
        return Math.max(speedMbps, 1);
      } catch {
        return 1;
      }
    }
  };

  // Calculate hash rate based on network speed and boosts
  const calculateHashRate = (speedMbps) => {
    const baseHashRate = 10;
    const additional = Math.min(speedMbps * 5, 90);
    const randomFactor = 1 + Math.random() * 0.2;

    let totalBoost = 1;
    userItems.forEach((purchase) => {
      const item = items.find((i) => i.id === purchase.item_id);
      if (item && purchase.expires_at > new Date().toISOString()) {
        totalBoost *= item.boost;
      }
    });

    const hashRate = (baseHashRate + additional) * randomFactor * totalBoost;
    return Math.min(hashRate, 1000);
  };

  // Purchase item function
  const purchaseItem = async (item) => {
    if (!window.ethereum) {
      setError('Silakan instal MetaMask untuk melakukan pembelian');
      return;
    }

    setIsLoading(true);
    try {
      const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
      if (!accounts || accounts.length === 0) {
        throw new Error('Tidak ada akun MetaMask yang ditemukan');
      }

      const value = (item.price * 1e18).toString(16);
      const txHash = await window.ethereum.request({
        method: 'eth_sendTransaction',
        params: [
          {
            from: accounts[0],
            to: '0x597c2c69f5a3538e9809f563274a8f5168bc9907',
            value: '0x' + value,
            gas: '0x5208',
          },
        ],
      });

      const expiresAt = new Date(Date.now() + item.duration).toISOString();
      const { error: purchaseError } = await supabase
        .from('user_boost_purchases')
        .insert({
          id: crypto.randomUUID(),
          user_id: user.id,
          item_id: item.id,
          purchased_at: new Date().toISOString(),
          expires_at: expiresAt,
          transaction_hash: txHash,
        });

      if (purchaseError) {
        throw new Error(`Gagal menyimpan pembelian: ${purchaseError.message}`);
      }

      await fetchItems();
      setError('');
    } catch (err) {
      const errorMessage = err.message || 'Terjadi kesalahan saat membeli item';
      setError(`Gagal membeli item: ${errorMessage}`);
    } finally {
      setIsLoading(false);
    }
  };

  let miningInterval = null;

  // Clear mining interval
  const clearMiningInterval = () => {
    if (miningInterval) {
      clearInterval(miningInterval);
      miningInterval = null;
    }
  };

  // Start mining session
  const startMining = async () => {
    setIsLoading(true);
    setError('');

    try {
      if (!user || !user.id) {
        throw new Error('Pengguna tidak terautentikasi');
      }

      const speedMbps = await testNetworkSpeed();
      const initialHashRate = calculateHashRate(speedMbps);

      const { data, error } = await supabase
        .from('mining_sessions')
        .insert([
          {
            user_id: user.id,
            start_time: new Date().toISOString(),
            network_speed: speedMbps,
            btc_mined: 0,
            hash_rate: initialHashRate,
          },
        ])
        .select()
        .single();

      if (error) throw new Error(`Gagal membuat sesi mining: ${error.message}`);
      if (!data || !data.id) throw new Error('Tidak ada ID sesi dari database');

      setMiningState({
        status: 'mining',
        hashRate: initialHashRate,
        btcMined: 0,
        networkSpeed: speedMbps,
        sessionId: data.id,
        lastUpdate: new Date().toISOString(),
      });
    } catch (err) {
      setError(`Gagal memulai mining: ${err.message}`);
      setMiningState({
        status: 'stopped',
        hashRate: 0,
        btcMined: 0,
        networkSpeed: 0,
        sessionId: null,
        lastUpdate: null,
      });
    } finally {
      setIsLoading(false);
    }
  };

  // Stop mining session
  const stopMining = async () => {
    setIsLoading(true);
    setError('');

    try {
      if (!miningState.sessionId || !user || !user.id) {
        throw new Error('Tidak ada sesi mining aktif atau pengguna tidak valid');
      }

      // Perbarui mining_sessions
      const { error: sessionError } = await supabase
        .from('mining_sessions')
        .update({
          end_time: new Date().toISOString(),
          btc_mined: miningState.btcMined,
          hash_rate: miningState.hashRate,
          network_speed: miningState.networkSpeed,
        })
        .eq('id', miningState.sessionId)
        .eq('user_id', user.id);

      if (sessionError) throw new Error(`Gagal menghentikan sesi mining: ${sessionError.message}`);

      // Perbarui wallet
      const { data: walletData, error: walletError } = await supabase
        .from('wallet')
        .select('balance')
        .eq('user_id', user.id)
        .maybeSingle();

      if (walletError && walletError.code !== 'PGRST116') {
        throw new Error(`Gagal mengambil wallet: ${walletError.message}`);
      }

      const currentBalance = walletData?.balance || 0;
      const newBalance = currentBalance + (miningState.btcMined || 0);

      const { error: updateWalletError } = await supabase
        .from('wallet')
        .upsert({
          user_id: user.id,
          balance: newBalance,
          last_updated: new Date().toISOString(),
        });

      if (updateWalletError) throw new Error(`Gagal memperbarui wallet: ${updateWalletError.message}`);

      // Catat transaksi
      if (miningState.btcMined > 0) {
        await supabase
          .from('transactions')
          .insert([{
            user_id: user.id,
            type: 'mining',
            amount: miningState.btcMined,
            description: 'Sesi mining selesai',
            created_at: new Date().toISOString(),
          }]);
      }

      setMiningState({
        status: 'stopped',
        hashRate: 0,
        btcMined: 0,
        networkSpeed: 0,
        sessionId: null,
        lastUpdate: null,
      });
      localStorage.removeItem('miningState');
      setWallet({ balance: newBalance });
      await fetchMiningHistory();
      await fetchDailyMiningData();
    } catch (err) {
      setError(`Gagal menghentikan mining: ${err.message}`);
    } finally {
      setIsLoading(false);
      clearMiningInterval();
    }
  };

  // Start mining interval
  const startMiningInterval = () => {
    clearMiningInterval();

    if (!miningState.sessionId || !user || !user.id) {
      setError('Tidak dapat memulai interval mining: ID sesi atau pengguna tidak valid');
      setMiningState((prev) => ({
        ...prev,
        status: 'stopped',
        sessionId: null,
      }));
      return;
    }

    let lastSaved = Date.now();

    miningInterval = setInterval(async () => {
      try {
        const newBtcMined = miningState.btcMined + (miningState.hashRate * 0.00001);

        setMiningState((prev) => {
          const updatedState = {
            ...prev,
            btcMined: newBtcMined,
            lastUpdate: new Date().toISOString(),
          };
          localStorage.setItem(
            'miningState',
            JSON.stringify({
              sessionId: prev.sessionId,
              btcMined: newBtcMined,
              lastUpdate: updatedState.lastUpdate,
              userId: user.id,
            })
          );
          return updatedState;
        });

        const now = Date.now();
        if (now - lastSaved >= 10000) {
          // Update mining_sessions dan wallet
          const { data: finishedSessions } = await supabase
            .from('mining_sessions')
            .select('btc_mined')
            .eq('user_id', user.id)
            .not('end_time', 'is', null);

          const { data: activeSession } = await supabase
            .from('mining_sessions')
            .select('btc_mined')
            .eq('id', miningState.sessionId)
            .eq('user_id', user.id)
            .is('end_time', null)
            .maybeSingle();

          let totalMined = 0;
          if (finishedSessions) {
            totalMined += finishedSessions.reduce((sum, s) => sum + (s.btc_mined || 0), 0);
          }
          if (activeSession) {
            totalMined += activeSession.btc_mined || 0;
          }

          await supabase
            .from('wallet')
            .update({
              balance: totalMined,
              last_updated: new Date().toISOString(),
            })
            .eq('user_id', user.id);

          setWallet({ balance: totalMined });
        }

        // Perbarui network speed setiap 10 detik
        const lastUpdateTime = miningState.lastUpdate ? new Date(miningState.lastUpdate).getTime() : 0;
        if (!miningState.lastUpdate || now - lastUpdateTime >= 10000) {
          const newSpeed = await testNetworkSpeed();
          const newHashRate = calculateHashRate(newSpeed);
          setMiningState((prev) => ({
            ...prev,
            networkSpeed: newSpeed,
            hashRate: newHashRate,
            lastUpdate: new Date().toISOString(),
          }));
        }
      } catch (error) {
        setError(`Peringatan mining: ${error.message || error}`);
      }
    }, 1000);
  };

  // Effects
  React.useEffect(() => {
    if (miningState.status === 'mining' && miningState.sessionId) {
      startMiningInterval();
    }
    return () => clearMiningInterval();
  }, [miningState]);

  React.useEffect(() => {
    if (user) {
      fetchMiningHistory();
      fetchItems();
      fetchDailyMiningData();
      const fetchWallet = async () => {
        try {
          const { data: walletData, error: walletError } = await supabase
            .from('wallet')
            .select('balance')
            .eq('user_id', user.id)
            .maybeSingle();
          if (walletError && walletError.code !== 'PGRST116') throw walletError;
          setWallet({ balance: walletData?.balance || 0 });
        } catch (err) {
          setError(`Gagal mengambil wallet: ${err.message}`);
        }
      };
      fetchWallet();
    }
    return () => clearMiningInterval();
  }, [user]);

  React.useEffect(() => {
    const handleBeforeUnload = () => {
      if (miningState.status === 'mining' && miningState.sessionId && user?.id) {
        try {
          localStorage.setItem(
            'miningState',
            JSON.stringify({
              sessionId: miningState.sessionId,
              btcMined: miningState.btcMined,
              lastUpdate: new Date().toISOString(),
              userId: user.id,
            })
          );
        } catch {}
      }
    };

    window.addEventListener('beforeunload', handleBeforeUnload);
    return () => {
      window.removeEventListener('beforeunload', handleBeforeUnload);
      clearMiningInterval();
    };
  }, [miningState.sessionId, miningState.status, miningState.btcMined, user]);

  React.useEffect(() => {
    if (dailyMiningData.labels && dailyMiningData.labels.length > 0) {
      const ctx = document.getElementById('miningChart')?.getContext('2d');
      if (ctx) {
        const existingChart = Chart.getChart(ctx);
        if (existingChart) {
          existingChart.destroy();
        }

        // Cek apakah user punya booster aktif (ada nilai > 0 di boosterValues)
        const hasBooster = dailyMiningData.boosterValues && dailyMiningData.boosterValues.some(v => v > 0);

        // Dataset selalu 1 (kuning), dan tambah hijau jika user punya booster aktif
        const datasets = [
          {
            label: '₿Ǥɱ Ditambang',
            data: dailyMiningData.values,
            backgroundColor: 'rgba(255, 215, 0, 0.6)',
            borderColor: 'rgba(255, 215, 0, 1)',
            borderWidth: 1,
          },
        ];
        if (hasBooster) {
          datasets.push({
            label: 'Bonus Booster',
            data: dailyMiningData.boosterValues,
            backgroundColor: 'rgba(0, 200, 83, 0.4)',
            borderColor: 'rgba(0, 200, 83, 1)',
            borderWidth: 1,
          });
        }

        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: dailyMiningData.labels,
            datasets,
          },
          options: {
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: '₿Ǥɱ',
                },
              },
              x: {
                title: {
                  display: true,
                  text: 'Tanggal',
                },
              },
            },
            plugins: {
              legend: {
                display: true,
              },
            },
          },
        });
      }
    }
  }, [dailyMiningData]);

  // Helper functions
  const formatTime = (dateString) => {
    if (!dateString) return 'N/A';
    return new Date(dateString).toLocaleString();
  };

  const formatDuration = (start, end) => {
    if (!start) return 'N/A';
    const startDate = new Date(start);
    const endDate = end ? new Date(end) : new Date();
    const seconds = Math.floor((endDate - startDate) / 1000);
    const hours = Math.floor((seconds % 3600) / 60);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;
    return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs
      .toString()
      .padStart(2, '0')}`;
  };

  return (
    <div className="ml-0 md:ml-96 px-4 md:px-6 max-w-full md:max-w-[calc(100%-384px)]">
      <style>
        {`
          .mining-card {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 215, 0, 0.05));
            border: 2px solid rgba(255, 215, 0, 0.3);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.2);
            transition: all 0.3s ease;
          }
          .mining-card:hover {
            box-shadow: 0 0 25px rgba(255, 215, 0, 0.4);
          }
          .mining-active {
            animation: goldPulse 2s infinite;
          }
          .boost-card {
            perspective: 1000px;
            height: 220px;
          }
          .boost-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.8s;
            transform-style: preserve-3d;
          }
          .boost-card-inner.flipped {
            transform: rotateY(180deg);
          }
          .boost-card-front, .boost-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 0.5rem;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
          }
          .boost-card-back {
            transform: rotateY(180deg);
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 215, 0, 0.1));
          }
          @keyframes goldPulse {
            0% {
              box-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
            }
            50% {
              box-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
            }
            100% {
              box-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
            }
          }
        `}
      </style>

      {error && (
        <div className="bg-red-100 dark:bg-red-900 border border-red-400 dark:border-red-700 text-red-700 dark:text-red-100 px-4 py-3 rounded mb-4">
          {error}
          <button
            onClick={() => setError('')}
            className="ml-2 text-red-700 dark:text-red-100 hover:text-red-900 dark:hover:text-red-300"
          >
            <i className="bi bi-x"></i>
          </button>
        </div>
      )}

      <div className="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 crystal-card transition-colors duration-300 animate-slide-in mb-6">
        <h1 className="text-3xl font-bold text-gray-900 dark:text-white mb-6 section-title gold-text-gradient">
          {t('dashboard')}
        </h1>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
          <div className={`mining-card p-6 rounded-lg ${miningState.status === 'mining' ? 'mining-active' : ''}`}>
            <div className="flex justify-between items-center mb-4">
              <h2 className="text-xl font-semibold text-gray-800 dark:text-white gold-text-gradient">
                {t('mining')}
              </h2>
              <div className="flex items-center">
                <span className={`inline-block w-3 h-3 rounded-full mr-2 ${
                  miningState.status === 'mining' ? 'bg-green-500 animate-pulse' : 'bg-red-500'
                }`}></span>
                <span className="text-sm font-medium text-gray-600 dark:text-gray-300">
                  {miningState.status === 'mining' ? 'Active' : 'Inactive'}
                </span>
              </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
              <div className="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                <div className="flex items-center mb-2">
                  <i className="bi bi-lightning-charge-fill text-yellow-500 mr-2"></i>
                  <span className="text-sm text-gray-600 dark:text-gray-300">{t('hashRate')}</span>
                </div>
                <div className="text-2xl font-bold text-gray-800 dark:text-white">
                  {miningState.hashRate.toFixed(2)} H/s
                </div>
              </div>
              <div className="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                <div className="flex items-center mb-2">
                  <i className="bi bi-currency-bitcoin text-yellow-500 mr-2"></i>
                  <span className="text-sm text-gray-600 dark:text-gray-300">{t('btcMined')}</span>
                </div>
                <div className="text-2xl font-bold text-gray-800 dark:text-white">
                  {miningState.btcMined.toFixed(8)} ₿Ǥɱ
                </div>
              </div>
              <div className="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                <div className="flex items-center mb-2">
                  <i className="bi bi-speedometer text-yellow-500 mr-2"></i>
                  <span className="text-sm text-gray-600 dark:text-gray-300">{t('networkSpeed')}</span>
                </div>
                <div className="text-2xl font-bold text-gray-800 dark:text-white">
                  {miningState.networkSpeed.toFixed(2)} Mbps
                </div>
              </div>
              <div className="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                <div className="flex items-center mb-2">
                  <i className="bi bi-wallet-fill text-yellow-500 mr-2"></i>
                  <span className="text-sm text-gray-600 dark:text-gray-300">{t('balance')}</span>
                </div>
                <div className="text-2xl font-bold text-gray-800 dark:text-white">
                  {wallet.balance.toFixed(8)} ₿Ǥɱ
                </div>
              </div>
            </div>

            <div className="flex justify-center">
              {miningState.status === 'mining' ? (
                <button
                  onClick={stopMining}
                  disabled={isLoading}
                  className="px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg shadow-lg transition-colors duration-300 flex items-center"
                >
                  {isLoading ? (
                    <i className="bi bi-arrow-repeat animate-spin mr-2"></i>
                  ) : (
                    <i className="bi bi-stop-fill mr-2"></i>
                  )}
                  {t('stopMining')}
                </button>
              ) : (
                <button
                  onClick={startMining}
                  disabled={isLoading}
                  className="px-6 py-3 bg-gradient-to-r from-yellow-500 to-yellow-600 hover:from-yellow-600 hover:to-yellow-700 text-white font-medium rounded-lg shadow-lg transition-colors duration-300 flex items-center"
                >
                  {isLoading ? (
                    <i className="bi bi-arrow-repeat animate-spin mr-2"></i>
                  ) : (
                    <i className="bi bi-play-fill mr-2"></i>
                  )}
                  {t('startMining')}
                </button>
              )}
            </div>
          </div>

          <div className="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg crystal-card">
            <h2 className="text-xl font-semibold text-gray-800 dark:text-white gold-text-gradient mb-4">
              {t('miningHistory')}
            </h2>
            <canvas id="miningChart" width="400" height="200" className="mb-4"></canvas>
            <div className="flex justify-end">
              <button
                onClick={() => {
                  fetchMiningHistory();
                  fetchDailyMiningData();
                }}
                className="px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-white rounded-lg transition-colors duration-300 flex items-center text-sm"
              >
                <i className="bi bi-arrow-clockwise mr-2"></i>
                {t('refresh')}
              </button>
            </div>
          </div>
        </div>

        <div className="mb-8">
          <h2 className="text-xl font-semibold text-gray-800 dark:text-white gold-text-gradient mb-4">
            Boosters
          </h2>
          <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6">
            {items.map((item) => {
              const isOwned = userItems.some(
                (ui) => ui.item_id === item.id && new Date(ui.expires_at) > new Date()
              );
              const isFlipped = flipStates[item.id] || false;
              return (
                <div
                  key={item.id}
                  className="boost-card"
                  onTouchStart={() => handleTouchStart(item.id)}
                >
                  <div className={`boost-card-inner ${isFlipped ? 'flipped' : ''}`}>
                    <div className="boost-card-front bg-white dark:bg-gray-700 p-4 rounded-lg shadow-lg">
                      <div className="flex justify-between items-start">
                        <h3 className="text-lg font-semibold text-gray-800 dark:text-white">
                          {item.name}
                        </h3>
                        <span className="inline-block px-2 py-1 bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200 text-xs font-semibold rounded">
                          {item.boost}x Boost
                        </span>
                      </div>
                      <div className="my-4 flex justify-center">
                        <i className={`bi ${item.icon || 'bi-lightning-charge'} text-5xl text-yellow-500`}></i>
                      </div>
                      <p className="text-sm text-gray-600 dark:text-gray-300 mb-4">
                        {item.description || 'Increases your mining speed and earnings.'}
                      </p>
                      <div className="flex justify-between items-center mt-auto">
                        <span className="text-lg font-bold text-gray-800 dark:text-white">
                          {item.price} ETH
                        </span>
                        {isOwned ? (
                          <span className="inline-block px-3 py-1 bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 text-sm font-semibold rounded">
                            Active
                          </span>
                        ) : (
                          <button
                            onClick={() => purchaseItem(item)}
                            disabled={isLoading}
                            className="px-3 py-1 bg-gradient-to-r from-yellow-500 to-yellow-600 hover:from-yellow-600 hover:to-yellow-700 text-white text-sm font-medium rounded shadow transition-colors duration-300"
                          >
                            Buy Now
                          </button>
                        )}
                      </div>
                      <div className="text-center mt-2">
                        <button
                          onClick={() => setFlipStates((prev) => ({ ...prev, [item.id]: true }))}
                          className="text-xs text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200"
                        >
                          More Info <i className="bi bi-arrow-right-short"></i>
                        </button>
                      </div>
                    </div>
                    <div className="boost-card-back p-4 rounded-lg shadow-lg">
                      <h3 className="text-lg font-semibold text-gray-800 dark:text-white mb-2">
                        {item.name} Details
                      </h3>
                      <ul className="text-sm text-gray-600 dark:text-gray-300 space-y-2 mb-4">
                        <li>
                          <i className="bi bi-check-circle-fill text-green-500 mr-1"></i> {item.boost}x mining speed
                        </li>
                        <li>
                          <i className="bi bi-check-circle-fill text-green-500 mr-1"></i> {item.duration / (24 * 60 * 60 * 1000)} days duration
                        </li>
                        <li>
                          <i className="bi bi-check-circle-fill text-green-500 mr-1"></i> Instant activation
                        </li>
                        <li>
                          <i className="bi bi-check-circle-fill text-green-500 mr-1"></i> Stackable with other boosters
                        </li>
                      </ul>
                      <div className="text-center mt-auto">
                        <button
                          onClick={() => setFlipStates((prev) => ({ ...prev, [item.id]: false }))}
                          className="text-xs text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200"
                        >
                          <i className="bi bi-arrow-left-short"></i> Back
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        </div>

        <div>
          <h2 className="text-xl font-semibold text-gray-800 dark:text-white gold-text-gradient mb-4">
            {t('miningHistory')}
          </h2>
          <div className="overflow-x-auto">
            <table className="min-w-full bg-white dark:bg-gray-800 rounded-lg overflow-hidden">
              <thead className="bg-gray-100 dark:bg-gray-700">
                <tr>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                    Start Time
                  </th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                    End Time
                  </th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                    Duration
                  </th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                    Hash Rate
                  </th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                    Network
                  </th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                    ₿Ǥɱ Mined
                  </th>
                </tr>
              </thead>
              <tbody className="divide-y divide-gray-200 dark:divide-gray-700">
                {miningHistory.length === 0 ? (
                  <tr>
                    <td colSpan="6" className="px-6 py-4 text-center text-gray-500 dark:text-gray-400">
                      No mining history found
                    </td>
                  </tr>
                ) : (
                  miningHistory.map((session) => (
                    <tr key={session.id} className="hover:bg-gray-50 dark:hover:bg-gray-700">
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                        {formatTime(session.start_time)}
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                        {session.end_time ? formatTime(session.end_time) : 'Active'}
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                        {formatDuration(session.start_time, session.end_time)}
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                        {session.hash_rate?.toFixed(2) || 0} H/s
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                        {session.network_speed?.toFixed(2) || 0} Mbps
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-yellow-600 dark:text-yellow-400">
                        {session.btc_mined?.toFixed(8) || 0} ₿Ǥɱ
                      </td>
                    </tr>
                  ))
                )}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      {profile && profile.referral_code && (
        <div className="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 crystal-card transition-colors duration-300 animate-slide-in">
          <h2 className="text-xl font-semibold text-gray-800 dark:text-white gold-text-gradient mb-4">
            {t('referralCode')}
          </h2>
          <div className="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg mb-4">
            <div className="flex items-center justify-between">
              <div className="text-lg font-bold text-gray-800 dark:text-white">
                {profile.referral_code}
              </div>
              <button
                onClick={() => {
                  const url = `${window.location.origin}?ref=${profile.referral_code}`;
                  navigator.clipboard.writeText(url);
                  setError('Referral link copied to clipboard!');
                  setTimeout(() => setError(''), 3000);
                }}
                className="px-3 py-1 bg-gradient-to-r from-yellow-500 to-yellow-600 hover:from-yellow-600 hover:to-yellow-700 text-white text-sm font-medium rounded shadow transition-colors duration-300 flex items-center"
              >
                <i className="bi bi-clipboard mr-1"></i>
                {t('copyReferralLink')}
              </button>
            </div>
          </div>
          <p className="text-sm text-gray-600 dark:text-gray-300">
            Share your referral code with friends and earn 0.01 ₿Ǥɱ for each new user who signs up using your code!
          </p>
        </div>
      )}
    </div>
  );
};

function ProfilePage({ profile, setProfile, userId, fetchUserProfile, t }) {
  const [isEditing, setIsEditing] = React.useState(false);
  const [editedProfile, setEditedProfile] = React.useState({ ...profile });
  const [isLoading, setIsLoading] = React.useState(false);
  const [error, setError] = React.useState('');
  const [success, setSuccess] = React.useState('');
  const [referrals, setReferrals] = React.useState([]);
  const [referralRewards, setReferralRewards] = React.useState([]);

  React.useEffect(() => {
    setEditedProfile({ ...profile });
    fetchReferrals();
    fetchReferralRewards();
  }, [profile]);

  const fetchReferrals = async () => {
    try {
      const { data, error } = await supabase
        .from('profiles')
        .select('id, full_name, email, created_at')
        .eq('referred_by', userId);

      if (error) throw error;
      setReferrals(data || []);
    } catch (err) {
      setError(`Failed to fetch referrals: ${err.message}`);
    }
  };

  const fetchReferralRewards = async () => {
    try {
      const { data, error } = await supabase
        .from('referral_transactions')
        .select('id, amount, created_at, referred_id, profiles:referred_id(full_name, email)')
        .eq('referrer_id', userId);

      if (error) throw error;
      setReferralRewards(data || []);
    } catch (err) {
      setError(`Failed to fetch referral rewards: ${err.message}`);
    }
  };

  const handleInputChange = (e) => {
    const { name, value } = e.target;
    setEditedProfile((prev) => ({
      ...prev,
      [name]: value,
    }));
  };

  const handleFileChange = (e) => {
    const file = e.target.files[0];
    if (!file) return;

    if (file.size > 5 * 1024 * 1024) {
      setError(t('fileTooLarge'));
      return;
    }

    setEditedProfile((prev) => ({
      ...prev,
      profile_photo: file,
    }));

    // Preview image
    const reader = new FileReader();
    reader.onloadend = () => {
      setEditedProfile((prev) => ({
        ...prev,
        profile_photo_url: reader.result,
      }));
    };
    reader.readAsDataURL(file);
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    setIsLoading(true);
    setError('');
    setSuccess('');

    try {
      let profile_photo_url = profile.profile_photo_url;

      // Upload new profile photo if changed
      if (editedProfile.profile_photo && editedProfile.profile_photo instanceof File) {
        const fileExt = editedProfile.profile_photo.name.split('.').pop();
        const fileName = `${userId}-${Math.random().toString(36).substring(2)}.${fileExt}`;
        const filePath = `profile_photos/${fileName}`;

        const { error: uploadError } = await supabase.storage
          .from('avatars')
          .upload(filePath, editedProfile.profile_photo);

        if (uploadError) throw uploadError;

        const { data } = supabase.storage.from('avatars').getPublicUrl(filePath);
        profile_photo_url = data.publicUrl;
      }

      // Update profile in database
      const { error: updateError } = await supabase
        .from('profiles')
        .update({
          full_name: editedProfile.full_name,
          phone_number: editedProfile.phone_number,
          profile_photo: profile_photo_url,
          email: editedProfile.email,
          updated_at: new Date().toISOString(),
        })
        .eq('id', userId);

      if (updateError) throw updateError;

      await fetchUserProfile(userId);
      setSuccess(t('profileUpdated'));
      setIsEditing(false);
    } catch (err) {
      setError(`Failed to update profile: ${err.message}`);
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className="ml-0 md:ml-96 px-4 md:px-6 max-w-full md:max-w-[calc(100%-384px)]">
      {error && (
        <div className="bg-red-100 dark:bg-red-900 border border-red-400 dark:border-red-700 text-red-700 dark:text-red-100 px-4 py-3 rounded mb-4">
          {error}
          <button
            onClick={() => setError('')}
            className="ml-2 text-red-700 dark:text-red-100 hover:text-red-900 dark:hover:text-red-300"
          >
            <i className="bi bi-x"></i>
          </button>
        </div>
      )}

      {success && (
        <div className="bg-green-100 dark:bg-green-900 border border-green-400 dark:border-green-700 text-green-700 dark:text-green-100 px-4 py-3 rounded mb-4">
          {success}
          <button
            onClick={() => setSuccess('')}
            className="ml-2 text-green-700 dark:text-green-100 hover:text-green-900 dark:hover:text-green-300"
          >
            <i className="bi bi-x"></i>
          </button>
        </div>
      )}

      <div className="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 crystal-card transition-colors duration-300 animate-slide-in mb-6">
        <div className="flex justify-between items-center mb-6">
          <h1 className="text-3xl font-bold text-gray-900 dark:text-white section-title gold-text-gradient">
            {t('profile')}
          </h1>
          {!isEditing && (
            <button
              onClick={() => setIsEditing(true)}
              className="px-4 py-2 bg-gradient-to-r from-yellow-500 to-yellow-600 hover:from-yellow-600 hover:to-yellow-700 text-white font-medium rounded-lg shadow-lg transition-colors duration-300 flex items-center"
            >
              <i className="bi bi-pencil-fill mr-2"></i>
              {t('editProfile')}
            </button>
          )}
        </div>

        {isEditing ? (
          <form onSubmit={handleSubmit} className="space-y-6">
            <div className="flex flex-col md:flex-row gap-6">
              <div className="md:w-1/3 flex flex-col items-center">
                <div className="relative w-40 h-40 mb-4">
                  <img
                    src={editedProfile.profile_photo_url || '/placeholder.svg?height=160&width=160'}
                    alt="Profile"
                    className="w-full h-full object-cover rounded-full border-4 border-gold-400"
                  />
                  <label
                    htmlFor="profile-photo"
                    className="absolute bottom-0 right-0 bg-gold-500 hover:bg-gold-600 text-white rounded-full p-2 cursor-pointer shadow-lg"
                  >
                    <i className="bi bi-camera-fill"></i>
                    <input
                      type="file"
                      id="profile-photo"
                      accept="image/*"
                      className="hidden"
                      onChange={handleFileChange}
                    />
                  </label>
                </div>
                <p className="text-sm text-gray-500 dark:text-gray-400 text-center">
                  Click the camera icon to change your profile photo
                </p>
              </div>

              <div className="md:w-2/3 space-y-4">
                <div>
                  <label
                    htmlFor="full_name"
                    className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
                  >
                    {t('fullName')}
                  </label>
                  <input
                    type="text"
                    id="full_name"
                    name="full_name"
                    value={editedProfile.full_name}
                    onChange={handleInputChange}
                    placeholder={t('enterFullName')}
                    className="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-gold-500 focus:border-gold-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                  />
                </div>

                <div>
                  <label
                    htmlFor="email"
                    className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
                  >
                    {t('email')}
                  </label>
                  <input
                    type="email"
                    id="email"
                    name="email"
                    value={editedProfile.email}
                    onChange={handleInputChange}
                    className="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-gold-500 focus:border-gold-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                  />
                </div>

                <div>
                  <label
                    htmlFor="phone_number"
                    className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1"
                  >
                    {t('phoneNumber')}
                  </label>
                  <input
                    type="tel"
                    id="phone_number"
                    name="phone_number"
                    value={editedProfile.phone_number}
                    onChange={handleInputChange}
                    placeholder={t('enterPhoneNumber')}
                    className="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-gold-500 focus:border-gold-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                  />
                </div>

                <div> text-gray-900 dark:text-white"
                  />
                </div>

                <div className="flex justify-end space-x-4">
                  <button
                    type="button"
                    onClick={() => setIsEditing(false)}
                    className="px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-white rounded-lg transition-colors duration-300"
                  >
                    {t('cancel')}
                  </button>
                  <button
                    type="submit"
                    disabled={isLoading}
                    className="px-4 py-2 bg-gradient-to-r from-yellow-500 to-yellow-600 hover:from-yellow-600 hover:to-yellow-700 text-white font-medium rounded-lg shadow-lg transition-colors duration-300 flex items-center"
                  >
                    {isLoading ? (
                      <>
                        <i className="bi bi-arrow-repeat animate-spin mr-2"></i>
                        {t('saving')}
                      </>
                    ) : (
                      <>
                        <i className="bi bi-check-lg mr-2"></i>
                        {t('save')}
                      </>
                    )}
                  </button>
                </div>
              </div>
            </div>
          </form>
        ) : (
          <div className="flex flex-col md:flex-row gap-6">
            <div className="md:w-1/3 flex flex-col items-center">
              <div className="w-40 h-40 mb-4">
                <img
                  src={profile.profile_photo_url || '/placeholder.svg?height=160&width=160'}
                  alt="Profile"
                  className="w-full h-full object-cover rounded-full border-4 border-gold-400"
                />
              </div>
              {profile.referral_code && (
                <div className="bg-gray-50 dark:bg-gray-700 p-3 rounded-lg w-full text-center">
                  <p className="text-sm text-gray-500 dark:text-gray-400 mb-1">{t('referralCode')}</p>
                  <p className="text-lg font-semibold text-gray-800 dark:text-white">{profile.referral_code}</p>
                  <button
                    onClick={() => {
                      const url = `${window.location.origin}?ref=${profile.referral_code}`;
                      navigator.clipboard.writeText(url);
                      setSuccess('Referral link copied to clipboard!');
                      setTimeout(() => setSuccess(''), 3000);
                    }}
                    className="mt-2 px-3 py-1 bg-gradient-to-r from-yellow-500 to-yellow-600 hover:from-yellow-600 hover:to-yellow-700 text-white text-sm font-medium rounded shadow transition-colors duration-300 flex items-center justify-center mx-auto"
                  >
                    <i className="bi bi-clipboard mr-1"></i>
                    {t('copyReferralLink')}
                  </button>
                </div>
              )}
            </div>

            <div className="md:w-2/3 space-y-4">
              <div className="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                <p className="text-sm text-gray-500 dark:text-gray-400 mb-1">{t('fullName')}</p>
                <p className="text-lg font-semibold text-gray-800 dark:text-white">
                  {profile.full_name || t('notSet')}
                </p>
              </div>

              <div className="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                <p className="text-sm text-gray-500 dark:text-gray-400 mb-1">{t('email')}</p>
                <p className="text-lg font-semibold text-gray-800 dark:text-white">
                  {profile.email || t('notSet')}
                </p>
              </div>

              <div className="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                <p className="text-sm text-gray-500 dark:text-gray-400 mb-1">{t('phoneNumber')}</p>
                <p className="text-lg font-semibold text-gray-800 dark:text-white">
                  {profile.phone_number || t('notSet')}
                </p>
              </div>
            </div>
          </div>
        )}
      </div>

      <div className="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 crystal-card transition-colors duration-300 animate-slide-in">
        <h2 className="text-xl font-semibold text-gray-900 dark:text-white gold-text-gradient mb-4">
          Referrals
        </h2>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <h3 className="text-lg font-medium text-gray-800 dark:text-white mb-3">
              Referred Users ({referrals.length})
            </h3>
            {referrals.length === 0 ? (
              <p className="text-gray-500 dark:text-gray-400">
                You haven't referred any users yet. Share your referral code to earn rewards!
              </p>
            ) : (
              <div className="bg-gray-50 dark:bg-gray-700 rounded-lg overflow-hidden">
                <ul className="divide-y divide-gray-200 dark:divide-gray-600">
                  {referrals.map((referral) => (
                    <li key={referral.id} className="p-4 hover:bg-gray-100 dark:hover:bg-gray-600">
                      <div className="flex items-center">
                        <div className="flex-shrink-0">
                          <i className="bi bi-person-circle text-2xl text-gray-400 dark:text-gray-500"></i>
                        </div>
                        <div className="ml-3">
                          <p className="text-sm font-medium text-gray-900 dark:text-white">
                            {referral.full_name || referral.email || 'Anonymous User'}
                          </p>
                          <p className="text-xs text-gray-500 dark:text-gray-400">
                            Joined: {new Date(referral.created_at).toLocaleDateString()}
                          </p>
                        </div>
                      </div>
                    </li>
                  ))}
                </ul>
              </div>
            )}
          </div>

          <div>
            <h3 className="text-lg font-medium text-gray-800 dark:text-white mb-3">
              Referral Rewards ({referralRewards.length})
            </h3>
            {referralRewards.length === 0 ? (
              <p className="text-gray-500 dark:text-gray-400">
                No rewards yet. You'll earn 0.01 ₿Ǥɱ for each new user who signs up using your referral code.
              </p>
            ) : (
              <div className="bg-gray-50 dark:bg-gray-700 rounded-lg overflow-hidden">
                <ul className="divide-y divide-gray-200 dark:divide-gray-600">
                  {referralRewards.map((reward) => (
                    <li key={reward.id} className="p-4 hover:bg-gray-100 dark:hover:bg-gray-600">
                      <div className="flex items-center justify-between">
                        <div className="flex items-center">
                          <div className="flex-shrink-0">
                            <i className="bi bi-coin text-2xl text-yellow-500"></i>
                          </div>
                          <div className="ml-3">
                            <p className="text-sm font-medium text-gray-900 dark:text-white">
                              {reward.profiles?.full_name || reward.profiles?.email || 'Anonymous User'}
                            </p>
                            <p className="text-xs text-gray-500 dark:text-gray-400">
                              {new Date(reward.created_at).toLocaleDateString()}
                            </p>
                          </div>
                        </div>
                        <div className="text-sm font-semibold text-yellow-600 dark:text-yellow-400">
                          +{reward.amount.toFixed(8)} ₿Ǥɱ
                        </div>
                      </div>
                    </li>
                  ))}
                </ul>
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}

function WalletPage({ user, t }) {
  const [wallet, setWallet] = React.useState({ balance: 0 });
  const [transactions, setTransactions] = React.useState([]);
  const [isLoading, setIsLoading] = React.useState(true);
  const [error, setError] = React.useState('');
  const [connectedWallets, setConnectedWallets] = React.useState([]);
  const [isModalOpen, setIsModalOpen] = React.useState(false);
  const [selectedWalletType, setSelectedWalletType] = React.useState('metamask');
  const [isConnecting, setIsConnecting] = React.useState(false);

  React.useEffect(() => {
    fetchWalletData();
    fetchTransactions();
    fetchConnectedWallets();
  }, [user]);

  const fetchWalletData = async () => {
    try {
      const { data, error } = await supabase
        .from('wallet')
        .select('balance, last_updated')
        .eq('user_id', user.id)
        .maybeSingle();

      if (error) throw error;
      setWallet(data || { balance: 0, last_updated: new Date().toISOString() });
    } catch (err) {
      setError(`Failed to fetch wallet data: ${err.message}`);
    }
  };

  const fetchTransactions = async () => {
    setIsLoading(true);
    try {
      const { data, error } = await supabase
        .from('transactions')
        .select('*')
        .eq('user_id', user.id)
        .order('created_at', { ascending: false })
        .limit(50);

      if (error) throw error;
      setTransactions(data || []);
    } catch (err) {
      setError(`Failed to fetch transactions: ${err.message}`);
    } finally {
      setIsLoading(false);
    }
  };

  const fetchConnectedWallets = async () => {
    try {
      const { data, error } = await supabase
        .from('connected_wallets')
        .select('*')
        .eq('user_id', user.id);

      if (error) throw error;
      setConnectedWallets(data || []);
    } catch (err) {
      setError(`Failed to fetch connected wallets: ${err.message}`);
    }
  };

  const connectWallet = async () => {
    setIsConnecting(true);
    setError('');
    try {
      let walletAddress = '';
      let walletType = selectedWalletType;

      if (selectedWalletType === 'metamask') {
        if (!window.ethereum) {
          throw new Error(t('metaMaskNotFound'));
        }
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        if (!accounts || accounts.length === 0) {
          throw new Error(t('metaMaskNoAccounts'));
        }
        walletAddress = accounts[0];
      } else if (selectedWalletType === 'phantom') {
        if (!window.solana) {
          throw new Error(t('phantomNotFound'));
        }
        const resp = await window.solana.connect();
        if (!resp.publicKey) {
          throw new Error(t('phantomNoPublicKey'));
        }
        walletAddress = resp.publicKey.toString();
      } else if (selectedWalletType === 'okx') {
        if (!window.okxwallet) {
          throw new Error(t('okxNotFound'));
        }
        const accounts = await window.okxwallet.ethereum.request({ method: 'eth_requestAccounts' });
        if (!accounts || accounts.length === 0) {
          throw new Error(t('okxNoAccounts'));
        }
        walletAddress = accounts[0];
      } else {
        throw new Error(t('invalidWalletType'));
      }

      // Check if wallet is already connected to another user
      const { data: existingWallet, error: checkError } = await supabase
        .from('connected_wallets')
        .select('user_id')
        .eq('wallet_address', walletAddress)
        .not('user_id', 'eq', user.id)
        .maybeSingle();

      if (checkError) throw checkError;
      if (existingWallet) {
        throw new Error(t('walletAddressInUse'));
      }

      // Add wallet to database
      const { error: insertError } = await supabase
        .from('connected_wallets')
        .insert({
          user_id: user.id,
          wallet_type: walletType,
          wallet_address: walletAddress,
          connected_at: new Date().toISOString(),
        });

      if (insertError) throw insertError;

      await fetchConnectedWallets();
      setIsModalOpen(false);
    } catch (err) {
      setError(`Failed to connect wallet: ${err.message}`);
    } finally {
      setIsConnecting(false);
    }
  };

  const disconnectWallet = async (walletId) => {
    try {
      const { error } = await supabase
        .from('connected_wallets')
        .delete()
        .eq('id', walletId)
        .eq('user_id', user.id);

      if (error) throw error;
      await fetchConnectedWallets();
    } catch (err) {
      setError(`Failed to disconnect wallet: ${err.message}`);
    }
  };

  const formatDate = (dateString) => {
    return new Date(dateString).toLocaleString();
  };

  const formatTransactionType = (type) => {
    switch (type) {
      case 'mining':
        return 'Mining Reward';
      case 'task_reward':
        return 'Task Reward';
      case 'referral':
        return 'Referral Bonus';
      case 'purchase':
        return 'Purchase';
      default:
        return type;
    }
  };

  const truncateAddress = (address) => {
    if (!address) return '';
    return `${address.substring(0, 6)}...${address.substring(address.length - 4)}`;
  };

  return (
    <div className="ml-0 md:ml-96 px-4 md:px-6 max-w-full md:max-w-[calc(100%-384px)]">
      {error && (
        <div className="bg-red-100 dark:bg-red-900 border border-red-400 dark:border-red-700 text-red-700 dark:text-red-100 px-4 py-3 rounded mb-4">
          {error}
          <button
            onClick={() => setError('')}
            className="ml-2 text-red-700 dark:text-red-100 hover:text-red-900 dark:hover:text-red-300"
          >
            <i className="bi bi-x"></i>
          </button>
        </div>
      )}

      <div className="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 crystal-card transition-colors duration-300 animate-slide-in mb-6">
        <h1 className="text-3xl font-bold text-gray-900 dark:text-white mb-6 section-title gold-text-gradient">
          {t('wallet')}
        </h1>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
          <div className="bg-gradient-to-r from-yellow-500 to-yellow-600 rounded-lg p-6 text-white shadow-lg">
            <div className="flex justify-between items-start mb-4">
              <div>
                <h2 className="text-lg font-semibold opacity-80">₿Ǥɱ {t('balance')}</h2>
                <p className="text-3xl font-bold mt-1">{wallet.balance.toFixed(8)}</p>
              </div>
              <i className="bi bi-currency-bitcoin text-4xl opacity-80"></i>
            </div>
            <div className="text-sm opacity-80">
              {t('lastUpdated')}: {formatDate(wallet.last_updated)}
            </div>
          </div>

          <div className="bg-gray-50 dark:bg-gray-700 rounded-lg p-6 shadow-lg">
            <h2 className="text-lg font-semibold text-gray-800 dark:text-white mb-4">
              {t('connectedWallets')}
            </h2>
            {connectedWallets.length === 0 ? (
              <div className="text-center py-4">
                <p className="text-gray-500 dark:text-gray-400 mb-4">{t('noConnectedWallets')}</p>
                <button
                  onClick={() => setIsModalOpen(true)}
                  className="px-4 py-2 bg-gradient-to-r from-yellow-500 to-yellow-600 hover:from-yellow-600 hover:to-yellow-700 text-white font-medium rounded-lg shadow-lg transition-colors duration-300 flex items-center mx-auto"
                >
                  <i className="bi bi-wallet-fill mr-2"></i>
                  {t('Connect')}
                </button>
              </div>
            ) : (
              <div className="space-y-3">
                {connectedWallets.map((wallet) => (
                  <div
                    key={wallet.id}
                    className="flex justify-between items-center bg-white dark:bg-gray-800 p-3 rounded-lg shadow"
                  >
                    <div className="flex items-center">
                      <i
                        className={`bi ${
                          wallet.wallet_type === 'metamask'
                            ? 'bi-currency-ethereum'
                            : wallet.wallet_type === 'phantom'
                            ? 'bi-currency-bitcoin'
                            : 'bi-wallet'
                        } text-xl mr-3 ${
                          wallet.wallet_type === 'metamask'
                            ? 'text-purple-500'
                            : wallet.wallet_type === 'phantom'
                            ? 'text-blue-500'
                            : 'text-green-500'
                        }`}
                      ></i>
                      <div>
                        <p className="text-sm font-medium text-gray-800 dark:text-white">
                          {wallet.wallet_type.charAt(0).toUpperCase() + wallet.wallet_type.slice(1)}
                        </p>
                        <p className="text-xs text-gray-500 dark:text-gray-400">
                          {truncateAddress(wallet.wallet_address)}
                        </p>
                      </div>
                    </div>
                    <button
                      onClick={() => disconnectWallet(wallet.id)}
                      className="text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300"
                    >
                      <i className="bi bi-trash"></i>
                    </button>
                  </div>
                ))}
                <div className="text-center pt-3">
                  <button
                    onClick={() => setIsModalOpen(true)}
                    className="px-3 py-1 bg-gradient-to-r from-yellow-500 to-yellow-600 hover:from-yellow-600 hover:to-yellow-700 text-white text-sm font-medium rounded shadow transition-colors duration-300"
                  >
                    <i className="bi bi-plus-lg mr-1"></i>
                    {t('Connect')}
                  </button>
                </div>
              </div>
            )}
          </div>
        </div>

        <div>
          <h2 className="text-xl font-semibold text-gray-800 dark:text-white gold-text-gradient mb-4">
            {t('transactions')}
          </h2>
          {isLoading ? (
            <div className="flex justify-center items-center py-8">
              <i className="bi bi-arrow-repeat animate-spin text-3xl text-gold-600"></i>
            </div>
          ) : transactions.length === 0 ? (
            <div className="text-center py-8 text-gray-500 dark:text-gray-400">
              {t('noTransactions')}
            </div>
          ) : (
            <div className="overflow-x-auto">
              <table className="min-w-full bg-white dark:bg-gray-800 rounded-lg overflow-hidden">
                <thead className="bg-gray-100 dark:bg-gray-700">
                  <tr>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                      {t('date')}
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                      {t('type')}
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                      {t('amount')}
                    </th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                      {t('description')}
                    </th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-gray-200 dark:divide-gray-700">
                  {transactions.map((transaction) => (
                    <tr key={transaction.id} className="hover:bg-gray-50 dark:hover:bg-gray-700">
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                        {formatDate(transaction.created_at)}
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                        {formatTransactionType(transaction.type)}
                      </td>
                      <td
                        className={`px-6 py-4 whitespace-nowrap text-sm font-medium ${
                          transaction.amount >= 0
                            ? 'text-green-600 dark:text-green-400'
                            : 'text-red-600 dark:text-red-400'
                        }`}
                      >
                        {transaction.amount >= 0 ? '+' : ''}
                        {transaction.amount.toFixed(8)} ₿Ǥɱ
                      </td>
                      <td className="px-6 py-4 text-sm text-gray-500 dark:text-gray-400 max-w-xs truncate">
                        {transaction.description}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </div>
      </div>

      {/* Connect Wallet Modal */}
      {isModalOpen && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full wallet-connections-modal">
            <div className="flex justify-between items-center mb-4">
              <h3 className="text-xl font-semibold text-gray-900 dark:text-white">
                {t('selectWallet')}
              </h3>
              <button
                onClick={() => setIsModalOpen(false)}
                className="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200"
              >
                <i className="bi bi-x-lg"></i>
              </button>
            </div>

            <div className="space-y-4 mb-6">
              <div
                className={`flex items-center p-4 border rounded-lg cursor-pointer ${
                  selectedWalletType === 'metamask'
                    ? 'border-yellow-500 bg-yellow-50 dark:bg-yellow-900/20'
                    : 'border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700'
                }`}
                onClick={() => setSelectedWalletType('metamask')}
              >
                <div className="w-10 h-10 flex items-center justify-center bg-orange-100 dark:bg-orange-900/30 rounded-full mr-4">
                  <i className="bi bi-currency-ethereum text-orange-500 text-xl"></i>
                </div>
                <div>
                  <h4 className="font-medium text-gray-900 dark:text-white">MetaMask</h4>
                  <p className="text-sm text-gray-500 dark:text-gray-400">
                    Connect using MetaMask wallet
                  </p>
                </div>
              </div>

              <div
                className={`flex items-center p-4 border rounded-lg cursor-pointer ${
                  selectedWalletType === 'phantom'
                    ? 'border-yellow-500 bg-yellow-50 dark:bg-yellow-900/20'
                    : 'border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700'
                }`}
                onClick={() => setSelectedWalletType('phantom')}
              >
                <div className="w-10 h-10 flex items-center justify-center bg-purple-100 dark:bg-purple-900/30 rounded-full mr-4">
                  <i className="bi bi-currency-bitcoin text-purple-500 text-xl"></i>
                </div>
                <div>
                  <h4 className="font-medium text-gray-900 dark:text-white">Phantom</h4>
                  <p className="text-sm text-gray-500 dark:text-gray-400">
                    Connect using Phantom wallet
                  </p>
                </div>
              </div>

              <div
                className={`flex items-center p-4 border rounded-lg cursor-pointer ${
                  selectedWalletType === 'okx'
                    ? 'border-yellow-500 bg-yellow-50 dark:bg-yellow-900/20'
                    : 'border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700'
                }`}
                onClick={() => setSelectedWalletType('okx')}
              >
                <div className="w-10 h-10 flex items-center justify-center bg-blue-100 dark:bg-blue-900/30 rounded-full mr-4">
                  <i className="bi bi-wallet2 text-blue-500 text-xl"></i>
                </div>
                <div>
                  <h4 className="font-medium text-gray-900 dark:text-white">OKX Wallet</h4>
                  <p className="text-sm text-gray-500 dark:text-gray-400">
                    Connect using OKX wallet
                  </p>
                </div>
              </div>
            </div>

            <div className="flex justify-end space-x-3">
              <button
                onClick={() => setIsModalOpen(false)}
                className="px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-white rounded-lg transition-colors duration-300"
              >
                {t('cancel')}
              </button>
              <button
                onClick={connectWallet}
                disabled={isConnecting}
                className="px-4 py-2 bg-gradient-to-r from-yellow-500 to-yellow-600 hover:from-yellow-600 hover:to-yellow-700 text-white font-medium rounded-lg shadow-lg transition-colors duration-300 flex items-center"
              >
                {isConnecting ? (
                  <>
                    <i className="bi bi-arrow-repeat animate-spin mr-2"></i>
                    {t('processing')}
                  </>
                ) : (
                  <>
                    <i className="bi bi-link-45deg mr-2"></i>
                    {t('Connect')}
                  </>
                )}
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

function LeaderboardPage({ user, t }) {
  const [leaderboard, setLeaderboard] = React.useState([]);
  const [isLoading, setIsLoading] = React.useState(true);
  const [error, setError] = React.useState('');
  const [userRank, setUserRank] = React.useState(null);
  const [timeframe, setTimeframe] = React.useState('all');

  React.useEffect(() => {
    fetchLeaderboard();
  }, [timeframe]);

  const fetchLeaderboard = async () => {
    setIsLoading(true);
    try {
      let query = supabase.rpc('get_leaderboard');
      
      if (timeframe === 'week') {
        query = supabase.rpc('get_weekly_leaderboard');
      } else if (timeframe === 'month') {
        query = supabase.rpc('get_monthly_leaderboard');
      }
      
      const { data, error } = await query;

      if (error) throw error;
      
      setLeaderboard(data || []);
      
      // Find user's rank
      if (user) {
        const userPosition = data.findIndex(item => item.user_id === user.id);
        setUserRank(userPosition !== -1 ? userPosition + 1 : null);
      }
    } catch (err) {
      setError(`Failed to fetch leaderboard: ${err.message}`);
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className="ml-0 md:ml-96 px-4 md:px-6 max-w-full md:max-w-[calc(100%-384px)]">
      {error && (
        <div className="bg-red-100 dark:bg-red-900 border border-red-400 dark:border-red-700 text-red-700 dark:text-red-100 px-4 py-3 rounded mb-4">
          {error}
          <button
            onClick={() => setError('')}
            className="ml-2 text-red-700 dark:text-red-100 hover:text-red-900 dark:hover:text-red-300"
          >
            <i className="bi bi-x"></i>
          </button>
        </div>
      )}

      <div className="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 crystal-card transition-colors duration-300 animate-slide-in">
        <h1 className="text-3xl font-bold text-gray-900 dark:text-white mb-6 section-title gold-text-gradient">
          {t('leaderboard')}
        </h1>

        <div className="flex justify-between items-center mb-6">
          <h2 className="text-xl font-semibold text-gray-800 dark:text-white">
            {t('Top Miners')}
          </h2>
          <div className="flex space-x-2">
            <button
              onClick={() => setTimeframe('all')}
              className={`px-3 py-1 rounded-lg text-sm font-medium ${
                timeframe === 'all'
                  ? 'bg-gradient-to-r from-yellow-500 to-yellow-600 text-white'
                  : 'bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white'
              }`}
            >
              All Time
            </button>
            <button
              onClick={() => setTimeframe('month')}
              className={`px-3 py-1 rounded-lg text-sm font-medium ${
                timeframe === 'month'
                  ? 'bg-gradient-to-r from-yellow-500 to-yellow-600 text-white'
                  : 'bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white'
              }`}
            >
              Monthly
            </button>
            <button
              onClick={() => setTimeframe('week')}
              className={`px-3 py-1 rounded-lg text-sm font-medium ${
                timeframe === 'week'
                  ? 'bg-gradient-to-r from-yellow-500 to-yellow-600 text-white'
                  : 'bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white'
              }`}
            >
              Weekly
            </button>
          </div>
        </div>

        {userRank !== null && (
          <div className="bg-gradient-to-r from-yellow-500/20 to-yellow-600/20 border border-yellow-500/30 rounded-lg p-4 mb-6">
            <div className="flex items-center">
              <div className="w-10 h-10 bg-yellow-500 rounded-full flex items-center justify-center text-white font-bold mr-4">
                {userRank}
              </div>
              <div>
                <p className="text-gray-700 dark:text-gray-300">Your Rank</p>
                <p className="text-lg font-semibold text-gray-900 dark:text-white">
                  {userRank === 1 ? '🏆 Top Miner!' : userRank <= 3 ? '🥇 Top 3!' : userRank <= 10 ? '🌟 Top 10!' : `Rank #${userRank}`}
                </p>
              </div>
            </div>
          </div>
        )}

        {isLoading ? (
          <div className="flex justify-center items-center py-12">
            <i className="bi bi-arrow-repeat animate-spin text-4xl text-gold-600"></i>
          </div>
        ) : leaderboard.length === 0 ? (
          <div className="text-center py-12 text-gray-500 dark:text-gray-400">
            {t('noData')}
          </div>
        ) : (
          <div className="leaderboard-container">
            <div className="space-y-4">
              {leaderboard.map((item, index) => (
                <div
                  key={item.user_id}
                  className={`leaderboard-item bg-white dark:bg-gray-800 rounded-lg p-4 shadow-md ${
                    item.user_id === user?.id
                      ? 'border-2 border-yellow-500 bg-yellow-50 dark:bg-yellow-900/20'
                      : ''
                  }`}
                >
                  <div className="flex items-center">
                    <div className="rank">
                      {index === 0 ? (
                        <span className="text-2xl">🥇</span>
                      ) : index === 1 ? (
                        <span className="text-2xl">🥈</span>
                      ) : index === 2 ? (
                        <span className="text-2xl">🥉</span>
                      ) : (
                        <span className="w-8 h-8 bg-gray-200 dark:bg-gray-700 rounded-full flex items-center justify-center font-bold text-gray-700 dark:text-gray-300">
                          {index + 1}
                        </span>
                      )}
                    </div>
                    <div className="flex items-center ml-4">
                      {item.profile_photo ? (
                        <img
                          src={item.profile_photo || "/placeholder.svg"}
                          alt="Miner"
                          className="w-10 h-10 rounded-full object-cover border-2 border-gray-200 dark:border-gray-700"
                        />
                      ) : (
                        <div className="w-10 h-10 bg-gray-200 dark:bg-gray-700 rounded-full flex items-center justify-center">
                          <i className="bi bi-person text-gray-500 dark:text-gray-400"></i>
                        </div>
                      )}
                      <div className="ml-3 max-w-200px">
                        <p className="font-medium text-gray-900 dark:text-white truncate">
                          {item.full_name || item.email || 'Anonymous Miner'}
                        </p>
                        <p className="text-xs text-gray-500 dark:text-gray-400">
                          {item.mining_sessions} sessions
                        </p>
                      </div>
                    </div>
                  </div>
                  <div className="balance">
                    <span className="font-bold text-yellow-600 dark:text-yellow-400">
                      {parseFloat(item.total_mined).toFixed(8)} ₿Ǥɱ
                    </span>
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}
      </div>
    </div>
  );
}

function SettingsPage({ darkMode, toggleDarkMode, t }) {
  const [notifications, setNotifications] = React.useState({
    email: false,
    push: false,
  });
  const [isLoading, setIsLoading] = React.useState(false);
  const [error, setError] = React.useState('');
  const [success, setSuccess] = React.useState('');

  const handleNotificationChange = (type) => {
    setNotifications((prev) => ({
      ...prev,
      [type]: !prev[type],
    }));
  };

  const requestNotificationPermission = async () => {
    try {
      if (!('Notification' in window)) {
        setError('This browser does not support desktop notifications');
        return;
      }

      const permission = await Notification.requestPermission();
      if (permission === 'granted') {
        setSuccess('Notification permission granted!');
        setNotifications((prev) => ({
          ...prev,
          push: true,
        }));
      } else {
        setError('Notification permission denied');
      }
    } catch (err) {
      setError(`Failed to request notification permission: ${err.message}`);
    }
  };

  const sendTestNotification = () => {
    if (!('Notification' in window) || Notification.permission !== 'granted') {
      requestNotificationPermission();
      return;
    }

    try {
      new Notification('Gold Bitcoin Miner', {
        body: t('updateMessage'),
        icon: '/favicon.ico',
      });
    } catch (err) {
      setError(`Failed to send notification: ${err.message}`);
    }
  };

  return (
    <div className="ml-0 md:ml-96 px-4 md:px-6 max-w-full md:max-w-[calc(100%-384px)]">
      {error && (
        <div className="bg-red-100 dark:bg-red-900 border border-red-400 dark:border-red-700 text-red-700 dark:text-red-100 px-4 py-3 rounded mb-4">
          {error}
          <button
            onClick={() => setError('')}
            className="ml-2 text-red-700 dark:text-red-100 hover:text-red-900 dark:hover:text-red-300"
          >
            <i className="bi bi-x"></i>
          </button>
        </div>
      )}

      {success && (
        <div className="bg-green-100 dark:bg-green-900 border border-green-400 dark:border-green-700 text-green-700 dark:text-green-100 px-4 py-3 rounded mb-4">
          {success}
          <button
            onClick={() => setSuccess('')}
            className="ml-2 text-green-700 dark:text-green-100 hover:text-green-900 dark:hover:text-green-300"
          >
            <i className="bi bi-x"></i>
          </button>
        </div>
      )}

      <div className="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 crystal-card transition-colors duration-300 animate-slide-in">
        <h1 className="text-3xl font-bold text-gray-900 dark:text-white mb-6 section-title gold-text-gradient">
          {t('settings')}
        </h1>

        <div className="space-y-8">
          <div className="border-b border-gray-200 dark:border-gray-700 pb-6">
            <h2 className="text-xl font-semibold text-gray-800 dark:text-white mb-4">
              Appearance
            </h2>
            <div className="flex items-center justify-between">
              <div>
                <p className="text-gray-800 dark:text-white font-medium">{t('darkMode')}</p>
                <p className="text-sm text-gray-500 dark:text-gray-400">
                  {t('darkModeDescription')}
                </p>
              </div>
              <div className="toggle-switch bg-gray-300 dark:bg-gray-600">
                <input
                  type="checkbox"
                  id="dark-mode-toggle"
                  checked={darkMode}
                  onChange={toggleDarkMode}
                  className="sr-only"
                />
                <label htmlFor="dark-mode-toggle" className="slider"></label>
              </div>
            </div>
          </div>

          <div className="border-b border-gray-200 dark:border-gray-700 pb-6">
            <h2 className="text-xl font-semibold text-gray-800 dark:text-white mb-4">
              {t('notifications')}
            </h2>
            <p className="text-sm text-gray-500 dark:text-gray-400 mb-4">
              {t('notificationsDescription')}
            </p>

            <div className="space-y-4">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-gray-800 dark:text-white font-medium">
                    {t('emailNotifications')}
                  </p>
                  <p className="text-sm text-gray-500 dark:text-gray-400">
                    Receive mining updates and rewards via email
                  </p>
                </div>
                <div className="toggle-switch bg-gray-300 dark:bg-gray-600">
                  <input
                    type="checkbox"
                    id="email-notifications-toggle"
                    checked={notifications.email}
                    onChange={() => handleNotificationChange('email')}
                    className="sr-only"
                  />
                  <label htmlFor="email-notifications-toggle" className="slider"></label>
                </div>
              </div>

              <div className="flex items-center justify-between">
                <div>
                  <p className="text-gray-800 dark:text-white font-medium">
                    {t('pushNotifications')}
                  </p>
                  <p className="text-sm text-gray-500 dark:text-gray-400">
                    Receive real-time alerts in your browser
                  </p>
                </div>
                <div className="toggle-switch bg-gray-300 dark:bg-gray-600">
                  <input
                    type="checkbox"
                    id="push-notifications-toggle"
                    checked={notifications.push}
                    onChange={() => {
                      if (!notifications.push) {
                        requestNotificationPermission();
                      } else {
                        handleNotificationChange('push');
                      }
                    }}
                    className="sr-only"
                  />
                  <label htmlFor="push-notifications-toggle" className="slider"></label>
                </div>
              </div>

              <button
                onClick={sendTestNotification}
                disabled={isLoading}
                className="px-4 py-2 bg-gradient-to-r from-yellow-500 to-yellow-600 hover:from-yellow-600 hover:to-yellow-700 text-white font-medium rounded-lg shadow-lg transition-colors duration-300 flex items-center"
              >
                <i className="bi bi-bell-fill mr-2"></i>
                Test Notification
              </button>
            </div>
          </div>

          <div>
            <h2 className="text-xl font-semibold text-gray-800 dark:text-white mb-4">
              {t('about')}
            </h2>
            <div className="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
              <p className="text-gray-800 dark:text-white font-medium">Gold Bitcoin Miner</p>
              <p className="text-sm text-gray-500 dark:text-gray-400 mb-2">{t('version')}</p>
              <p className="text-sm text-gray-500 dark:text-gray-400">
                A virtual Bitcoin mining simulator that lets you experience the thrill of mining
                without expensive hardware.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

    // Render the app
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
