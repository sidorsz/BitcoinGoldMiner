<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gold Bitcoin Mining Simulator</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <!-- Tailwind CSS with custom gold theme -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            gold: {
              50: '#fff9e6',
              100: '#fff1cc',
              200: '#ffe8b3',
              300: '#ffe099',
              400: '#ffd780',
              500: '#ffcf66',
              600: '#d4af37', // Primary gold color
              700: '#b38f1e',
              800: '#916f0a',
              900: '#704f00',
            },
            crystal: {
              100: '#e6f7ff',
              200: '#b3e6ff',
              300: '#80d4ff',
              400: '#4dc3ff',
              500: '#1ab1ff',
              600: '#0088cc',
              700: '#006699',
              800: '#004466',
              900: '#002233',
            }
          },
          animation: {
            'gold-pulse': 'goldPulse 3s infinite',
            'crystal-shine': 'crystalShine 4s infinite',
          },
          keyframes: {
            goldPulse: {
              '0%, 100%': { 'box-shadow': '0 0 0 0 rgba(212, 175, 55, 0.7)' },
              '50%': { 'box-shadow': '0 0 20px 10px rgba(212, 175, 55, 0.4)' },
            },
            crystalShine: {
              '0%': { 'filter': 'brightness(1)', 'transform': 'rotateY(0deg)' },
              '50%': { 'filter': 'brightness(1.5)', 'transform': 'rotateY(180deg)' },
              '100%': { 'filter': 'brightness(1)', 'transform': 'rotateY(360deg)' },
            }
          }
        }
      }
    }
  </script>
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <!-- React and ReactDOM -->
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
  <!-- Babel for JSX -->
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.23.10/babel.min.js"></script>
  <!-- Three.js and GSAP -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.5/gsap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.11.5/ScrollTrigger.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
   /* Global Styles */
* {
  box-sizing: border-box;
}

input:focus {
  outline: none;
  box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.3);
}

/* Main Content */
.main-content {
  box-sizing: border-box;
  min-height: calc(100vh - 64px);
  padding-bottom: 80px;
  position: relative;
  overflow-y: auto;
  width: 100%;
}

@supports (padding-bottom: env(safe-area-inset-bottom)) {
  .main-content {
    padding-bottom: calc(8rem + env(safe-area-inset-bottom));
  }
}

@supports (-webkit-overflow-scrolling: touch) {
  .main-content {
    padding-bottom: 10rem;
  }
}

/* Wallet Button */
.wallet-btn {
  align-items: center;
  background: linear-gradient(45deg, #FFD700, #FFB700);
  border: none;
  border-radius: 8px;
  color: white;
  cursor: pointer;
  display: flex;
  font-size: 16px;
  gap: 8px;
  padding: 10px 20px;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.wallet-btn.connect {
  background: linear-gradient(45deg, #FFD700, #FFB700);
}

.wallet-btn.disconnect {
  background: linear-gradient(45deg, #EF4444, #DC2626);
}

.wallet-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

.wallet-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Toggle Switch */
.toggle-switch {
  background-color: #ccc;
  border-radius: 9999px;
  height: 20px;
  position: relative;
  transition: background-color 0.3s ease;
  width: 40px;
}

.toggle-switch input {
  negligible;
}

.toggle-switch .slider {
  background-color: white;
  border-radius: 50%;
  height: 16px;
  left: 2px;
  position: absolute;
  top: 2px;
  transition: transform 0.3s ease;
  width: 16px;
}

.toggle-switch input:checked + .slider {
  transform: translateX(20px);
}

.toggle-switch input:checked ~ .toggle-switch {
  background-color: #FFD700;
}

/* Wallet Connections Modal */
.wallet-connections-modal {
  -webkit-backdrop-filter: blur(10px);
  backdrop-filter: blur(10px);
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0));
  border: 1px solid rgba(255, 255, 255, 0.18);
  max-height: 80vh;
  overflow-y: auto;
}

.wallet-connections-modal::-webkit-scrollbar {
  width: 8px;
}

.wallet-connections-modal::-webkit-scrollbar-thumb {
  background: #FFD700;
  border-radius: 4px;
}

.wallet-connections-modal::-webkit-scrollbar-track {
  background: rgba(255, 255, 255, 0.1);
}

/* Crystal Card */
.crystal-card {
  -webkit-backdrop-filter: blur(10px);
  backdrop-filter: blur(10px);
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0));
  border: 1px solid rgba(255, 255, 255, 0.18);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.crystal-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
}

/* Status */
.status {
  font-size: 16px;
  font-weight: 600;
  margin-top: 16px;
}

.status.success {
  color: #10B981;
}

.status.error {
  color: #EF4444;
}

/* Section Title */
.section-title {
  font-family: 'Inter', sans-serif;
  font-weight: 700;
  letter-spacing: -0.025em;
}

/* Gold Theme */
.gold-gradient {
  background: linear-gradient(135deg, #d4af37 0%, #f9d423 50%, #d4af37 100%);
}

.gold-text-gradient {
  -webkit-background-clip: text;
  background: linear-gradient(45deg, #FFD700, #FFB700);
  background-clip: text;
  color: transparent;
}

/* Dark Mode */
.dark .gold-gradient {
  background: linear-gradient(135deg, #916f0a 0%, #b38f1e 50%, #916f0a 100%);
}

.dark .crystal-card {
  background: rgba(0, 0, 0, 0.2);
  border: 1px solid rgba(212, 175, 55, 0.3);
}

/* Sidebar */
.sidebar {
  transition: transform 0.3s ease-in-out;
  z-index: 20;
}

.sidebar-overlay {
  background-color: rgba(0, 0, 0, 0.5);
  bottom: 0;
  display: none;
  left: 0;
  position: fixed;
  right: 0;
  top: 0;
  z-index: 10;
}

.sidebar-overlay.sidebar-open {
  display: block;
}

/* Navbar Bottom */
.navbar-bottom {
  -webkit-backdrop-filter: blur(10px);
  align-items: center;
  backdrop-filter: blur(10px);
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0));
  border-top: 1px solid rgba(255, 255, 255, 0.18);
  bottom: 0;
  display: flex;
  height: 64px;
  justify-content: space-around;
  left: 0;
  position: fixed;
  right: 0;
  z-index: 1000;
}

/* Canvas */
#threeCanvas {
  height: 300px;
  pointer-events: none;
  position: fixed;
  right: 0;
  top: 0;
  width: 300px;
  z-index: 5;
}

/* Language Selector */
.language-selector {
  position: relative;
}

.language-dropdown {
  display: none;
  min-width: 120px;
  position: absolute;
  right: 0;
  top: 100%;
  z-index: 20;
}

.language-selector:hover .language-dropdown {
  display: block;
}

/* Leaderboard */
.leaderboard-container {
  -webkit-overflow-scrolling: touch;
}

.leaderboard-item {
  align-items: center;
  display: flex;
  gap: 12px;
  justify-content: space-between;
}

.rank {
  align-items: center;
  display: flex;
  gap: 4px;
}

/* Typography & Layout Adjustments */
.mobile-icon {
  animation: crystalShine 4s infinite;
  font-size: 1.25rem;
}

span.text-xs {
  font-size: 0.65rem;
}

.overflow-x-auto {
  margin-bottom: 2rem;
  max-height: none;
  overflow-y: visible;
}

table.min-w-full {
  display: block;
  overflow: visible;
}

/* Animations */
.animate-slide-in {
  animation: slideIn 0.5s ease-out;
}

.animate-fade-in {
  animation: fadeIn 0.3s ease-in;
}

.animate-pulse {
  animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}

.mining-active {
  animation: goldPulse 3s infinite;
}

/* Keyframes */
@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: scale(0.8);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

/* Media Queries */
@media (max-width: 768px) {
  .main-content {
    padding: 12px;
    padding-bottom: 80px;
  }

  .crystal-card {
    border-radius: 12px;
    margin: 0 8px 16px;
    min-height: initial;
    padding: 12px;
  }

  .wallet-btn {
    font-size: 14px;
    padding: 8px 16px;
  }

  .wallet-connections-modal {
    max-width: 90%;
  }

  .section-title {
    font-size: 1.5rem;
  }

  .sidebar {
    bottom: 0;
    position: fixed;
    top: 0;
    transform: translateX(-100%);
  }

  .sidebar-open {
    transform: translateX(0);
  }

  .sidebar-close-btn {
    background: none;
    border: none;
    color: white;
    cursor: pointer;
    font-size: 1.5rem;
    position: absolute;
    right: 10px;
    top: 10px;
    z-index: 30;
  }

  #threeCanvas {
    height: 200px;
    width: 200px;
  }

  .leaderboard-container {
    overflow-x: auto;
    scrollbar-color: rgba(255, 215, 0, 0.5) transparent;
    scrollbar-width: thin;
  }

  .leaderboard-container::-webkit-scrollbar {
    height: 6px;
  }

  .leaderboard-container::-webkit-scrollbar-thumb {
    background-color: rgba(255, 215, 0, 0.5);
    border-radius: 3px;
  }

  .leaderboard-container::-webkit-scrollbar-track {
    background: transparent;
  }

  .leaderboard-item {
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    gap: 8px;
    min-width: 320px;
    padding: 10px;
  }

  .rank {
    font-size: 0.875rem;
    width: 36px;
  }

  .rank i {
    font-size: 0.75rem;
  }

  .leaderboard-item img,
  .leaderboard-item .w-10 {
    height: 32px;
    width: 32px;
  }

  .leaderboard-item .max-width-200px {
    font-size: 0.875rem;
    max-width: 180px;
  }

  .balance {
    font-size: 0.75rem;
    white-space: nowrap;
  }
}

@media (min-width: 769px) {
  .main-content {
    min-height: 100vh;
    outline: none;
    padding: 24px;
    padding-bottom: 80px;
  }

  .crystal-card {
    padding: 24px;
  }

  .section-title {
    font-size: 2rem;
  }

  .leaderboard-container {
    overflow-x: hidden;
  }

  .leaderboard-item {
    min-width: 0;
    padding: 16px;
  }

  .rank {
    font-size: 1rem;
    width: 48px;
  }

  .rank i {
    font-size: 0.875rem;
  }

  .leaderboard-item img,
  .leaderboard-item .w-10 {
    height: 40px;
    width: 40px;
  }

  .leaderboard-item .max-w-200px {
    font-size: 1rem;
    max-width: 300px;
  }

  .balance {
    font-size: 0.875rem;
  }
}
@keyframes gold-glow {
  0%,100% { filter: drop-shadow(0 0 6px #FFD700) drop-shadow(0 0 12px #FFD700); }
  50% { filter: drop-shadow(0 0 16px #FFD700) drop-shadow(0 0 32px #FFFACD); }
}
    </style>
    
</head>
<body class="bg-gray-100 dark:bg-gray-900 transition-colors duration-300">
  <div id="root"></div>
  <canvas id="threeCanvas"></canvas>

  <script type="text/babel">
    // Initialize 3D scene
    let miningAnimationActive = false;
    let torusKnot;

    function initThreeJS() {
      const canvas = document.getElementById('threeCanvas');
      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(75, 1, 0.1, 1000);
      const renderer = new THREE.WebGLRenderer({
        canvas,
        alpha: true,
        antialias: true
      });
      renderer.setSize(300, 300);

      // Create gold crystal geometry
      const geometry = new THREE.TorusKnotGeometry(1, 0.4, 100, 16);
      const material = new THREE.MeshPhongMaterial({
        color: 0xd4af37,
        emissive: 0x222222,
        specular: 0xffeeaa,
        shininess: 100,
        wireframe: false,
        transparent: true,
        opacity: 0.9
      });

      torusKnot = new THREE.Mesh(geometry, material);
      scene.add(torusKnot);

      // Add lights
      const ambientLight = new THREE.AmbientLight(0x404040);
      scene.add(ambientLight);

      const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
      directionalLight.position.set(1, 1, 1);
      scene.add(directionalLight);

      const pointLight = new THREE.PointLight(0xffcc00, 1, 100);
      pointLight.position.set(5, 5, 5);
      scene.add(pointLight);

      camera.position.z = 3;

      // Animation function
      function animate() {
        requestAnimationFrame(animate);

        if (miningAnimationActive) {
          torusKnot.rotation.x += 0.02;
          torusKnot.rotation.y += 0.02;

          // Pulsing effect when mining
          const scale = 1 + Math.sin(Date.now() * 0.005) * 0.2;
          torusKnot.scale.set(scale, scale, scale);

          // Color shift effect
          const hue = (Date.now() * 0.05) % 360;
          torusKnot.material.color.setHSL(hue / 360, 0.7, 0.5);
        } else {
          torusKnot.rotation.x += 0.005;
          torusKnot.rotation.y += 0.005;
          torusKnot.scale.set(1, 1, 1);
          torusKnot.material.color.setHex(0xd4af37);
        }

        renderer.render(scene, camera);
      }

      animate();

      // Handle window resize
      function handleResize() {
        const size = window.innerWidth < 768 ? 200 : 300;
        renderer.setSize(size, size);
        camera.aspect = 1;
        camera.updateProjectionMatrix();
      }

      window.addEventListener('resize', handleResize);
    }

    // Initialize GSAP ScrollTrigger
    function initScrollAnimations() {
      gsap.registerPlugin(ScrollTrigger);

      gsap.from('.section-title', {
        scrollTrigger: {
          trigger: '.section-title',
          start: 'top 80%',
        },
        opacity: 0,
        y: -100,
        duration: 1.5,
        ease: 'power3.out'
      });

      gsap.from('.about-card', {
        scrollTrigger: {
          trigger: '.about-card',
          start: 'top 80%',
        },
        opacity: 0,
        scale: 0.8,
        stagger: 0.3,
        duration: 1,
        ease: 'back.out(1.7)'
      });

      gsap.from('.timeline-card', {
        scrollTrigger: {
          trigger: '.timeline-card',
          start: 'top 80%',
        },
        opacity: 0,
        x: -100,
        stagger: 0.3,
        duration: 1,
        ease: 'power2.out'
      });

      gsap.from('.product-card', {
        scrollTrigger: {
          trigger: '.product-showcase',
          start: 'top 80%',
        },
        opacity: 0,
        y: 50,
        stagger: 0.3,
        duration: 1,
        ease: 'power3.out'
      });
    }

    // Initialize 3D and animations when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
      initThreeJS();
      initScrollAnimations();
    });

    // Supabase configuration
    const supabaseUrl = 'https://byzbvsrogorhhdbaewft.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ5emJ2c3JvZ29yaGhkYmFld2Z0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDUyNDU0NzAsImV4cCI6MjA2MDgyMTQ3MH0.IRmyupINadjqWq04o-D3WjNqstkyi7TY6nGHWPMs6c0';

// Validasi URL
try {
  new URL(supabaseUrl);
} catch (e) {
  console.error('Invalid Supabase URL:', supabaseUrl, e);
  throw new Error('Please provide a valid Supabase URL in supabaseUrl');
}
const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    

    // Referral utility function
function generateReferralCode() {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
  let code = '';
  for (let i = 0; i < 8; i++) {
    code += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return code;
}

// Main App Component
function App() {
  const [user, setUser] = React.useState(null);
  const [activeTab, setActiveTab] = React.useState('dashboard');
  const [session, setSession] = React.useState(null);
  const [isMobileMenuOpen, setIsMobileMenuOpen] = React.useState(false);
  const [darkMode, setDarkMode] = React.useState(false);
  const [language, setLanguage] = React.useState('en');
  const [isLoading, setIsLoading] = React.useState(true);
  const [error, setError] = React.useState('');
  const [profile, setProfile] = React.useState({
    full_name: '',
    phone_number: '',
    profile_photo: null,
    profile_photo_url: '',
    email: '',
    referral_code: '',
    referred_by: null,
  });

  const [miningState, setMiningState] = React.useState({
    status: 'stopped',
    hashRate: 0,
    btcMined: 0,
    networkSpeed: 0,
    sessionId: null,
    lastUpdate: null,
  });

  const translations = {
    en: {
      welcome: 'Home',
      mining: 'Mining',
      dashboard: 'Dashboard',
      profile: 'Profile',
      wallet: 'Wallet',
      leaderboard: 'Leaderboard',
      settings: 'Settings',
      logout: 'Logout',
      startMining: 'Start Mining',
      stopMining: 'Stop Mining',
      btcMined: '₿Ǥɱ Mined',
      hashRate: 'Hash Rate',
      networkSpeed: 'Network Speed',
      miningHistory: 'Mining History',
      refresh: 'Refresh',
      signIn: 'Sign In',
      signUp: 'Sign Up',
      email: 'Email',
      password: 'Password',
      fullName: 'Full Name',
      forgotPassword: 'Forgot Password?',
      needAccount: 'Need an account? Sign up',
      haveAccount: 'Already have an account? Sign in',
      orContinueWith: 'Or continue with',
      transactions: 'Transactions',
      balance: 'Balance',
      rank: 'Rank',
      miner: 'Miner',
      totalBtc: 'Total ₿Ǥɱ',
      sessions: 'Sessions',
      darkMode: 'Dark Mode',
      notifications: 'Notifications',
      about: 'About',
      version: 'Version 1.0.0',
      referralCode: 'Referral Code',
      copyReferralLink: 'Copy Referral Link',
      address: 'Address',
    disabled: 'Disabled',
    Connect: 'Connect',
    Disconnect: 'Disconnect',
    selectWallet: 'Select Wallet',
    walletConnected: 'Wallet Connected',
    connectedWallets: 'Connected Wallets',
    noConnectedWallets: 'No connected wallets',
    close: 'Close',
    processing: 'Processing...',
    cancel: 'Cancel',
    preview: 'Preview',
    editProfile: 'Edit Profile',
    save: 'Save',
    saving: 'Saving...',
    enterFullName: 'Enter full name',
    notSet: 'Not set',
    phoneNumber: 'Phone Number',
    enterPhoneNumber: 'Enter phone number',
    profileUpdated: 'Profile updated successfully!',
    loading: 'Loading...',
    noTransactions: 'No transactions found',
    date: 'Date',
    type: 'Type',
    amount: 'Amount',
    description: 'Description',
    noData: 'No data available',
    'Top Miners': 'Top Miners',
    networkError: 'Network error, please check your connection',
    darkModeDescription: 'Toggle between light and dark themes',
    notificationsDescription: 'Manage your notification preferences',
    emailNotifications: 'Email notifications',
    pushNotifications: 'Push notifications',
    sending: 'Sending...',
    sendNotification: 'Send Notification',
    appUpdate: 'App Update',
    updateMessage: 'There is a new update in your app!',
    invalidEmail: 'Invalid email address.',
    updateMessageEmail: 'Hello, there is a new update in your app. Check your settings!',
    emailNotificationFailed: 'Failed to send email notification.',
    userNotAuthenticated: 'User not authenticated.',
    emailNotSet: 'Email address not set in profile. Please update your profile.',
    enableNotificationsGuide: 'To enable notifications, go to your browser settings and allow notifications for this site.',
    userNotFoundGuide: 'User profile not found. Please ensure your profile is set up correctly.',
    invalidEmailGuide: 'The email address is invalid. Please update your profile with a valid email address.',
    emailNotificationGuide: 'Unable to send email. Please ensure your email address is correct in your profile and try again.',
    fileTooLarge: 'File too large. Max 5MB.',
    metaMaskNotFound: 'MetaMask not found! Please install MetaMask.',
    metaMaskNoAccounts: 'No accounts found in MetaMask.',
    phantomNotFound: 'Phantom wallet not found! Please install Phantom.',
    phantomNoPublicKey: 'No public key found in Phantom.',
    okxNotFound: 'OKX Wallet not found! Please install OKX Wallet.',
    okxNoAccounts: 'No accounts found in OKX Wallet.',
    walletAddressInUse: 'This wallet address is already used by another user.',
    invalidWalletType: 'Invalid wallet type selected.',
    },
    id: {
      welcome: 'Beranda',
      mining: 'Penambangan',
      dashboard: 'Dasbor',
      profile: 'Profil',
      wallet: 'Dompet',
      leaderboard: 'Papan Peringkat',
      settings: 'Pengaturan',
      logout: 'Keluar',
      startMining: 'Mulai Menambang',
      stopMining: 'Berhenti Menambang',
      btcMined: '₿Ǥɱ Ditambang',
      hashRate: 'Tingkat Hash',
      networkSpeed: 'Kecepatan Jaringan',
      miningHistory: 'Riwayat Penambangan',
      refresh: 'Muat Ulang',
      signIn: 'Masuk',
      signUp: 'Daftar',
      email: 'Email',
      password: 'Kata Sandi',
      fullName: 'Nama Lengkap',
      forgotPassword: 'Lupa Kata Sandi?',
      needAccount: 'Perlu akun? Daftar',
      haveAccount: 'Sudah punya akun? Masuk',
      orContinueWith: 'Atau lanjutkan dengan',
      transactions: 'Transaksi',
      balance: 'Saldo',
      rank: 'Peringkat',
      miner: 'Penambang',
      totalBtc: 'Total ₿Ǥɱ',
      sessions: 'Sesi',
      darkMode: 'Mode Gelap',
      notifications: 'Notifikasi',
      about: 'Tentang',
      version: 'Versi 1.0.0',
      referralCode: 'Kode Referral',
      copyReferralLink: 'Salin Tautan Referral',
      address: 'Alamat',
    disabled: 'Dinonaktifkan',
    Connect: 'Hubungkan',
    Disconnect: 'Putuskan',
    selectWallet: 'Pilih Wallet',
    walletConnected: 'Wallet Terhubung',
    connectedWallets: 'Wallet Terhubung',
    noConnectedWallets: 'Belum ada wallet terhubung',
    close: 'Tutup',
    processing: 'Memproses...',
    cancel: 'Batal',
    preview: 'Pratinjau',
    editProfile: 'Edit Profil',
    save: 'Simpan',
    saving: 'Menyimpan...',
    enterFullName: 'Masukkan nama lengkap',
    notSet: 'Belum diatur',
    phoneNumber: 'Nomor Telepon',
    enterPhoneNumber: 'Masukkan nomor telepon',
    profileUpdated: 'Profil berhasil diperbarui!',
    loading: 'Memuat...',
    noTransactions: 'Tidak ada transaksi',
    date: 'Tanggal',
    type: 'Tipe',
    amount: 'Jumlah',
    description: 'Deskripsi',
    noData: 'Tidak ada data',
    'Top Miners': 'Penambang Teratas',
    networkError: 'Kesalahan jaringan, periksa koneksi Anda',
    darkModeDescription: 'Beralih antara tema terang dan gelap',
    notificationsDescription: 'Kelola preferensi notifikasi Anda',
    emailNotifications: 'Notifikasi email',
    pushNotifications: 'Notifikasi push',
    sending: 'Mengirim...',
    sendNotification: 'Kirim Notifikasi',
    appUpdate: 'Pembaruan Aplikasi',
    updateMessage: 'Ada pembaruan baru di aplikasi Anda!',
    invalidEmail: 'Alamat email tidak valid.',
    updateMessageEmail: 'Halo, ada pembaruan baru di aplikasi Anda. Periksa pengaturan Anda!',
    emailNotificationFailed: 'Gagal mengirim notifikasi email.',
    userNotAuthenticated: 'Pengguna belum terautentikasi.',
    emailNotSet: 'Alamat email belum diatur di profil. Silakan perbarui profil Anda.',
    enableNotificationsGuide: 'Untuk mengaktifkan notifikasi, buka pengaturan browser dan izinkan notifikasi untuk situs ini.',
    userNotFoundGuide: 'Profil pengguna tidak ditemukan. Pastikan profil Anda sudah benar.',
    invalidEmailGuide: 'Alamat email tidak valid. Perbarui profil Anda dengan email yang benar.',
    emailNotificationGuide: 'Tidak dapat mengirim email. Pastikan alamat email Anda benar di profil dan coba lagi.',
    fileTooLarge: 'Ukuran file terlalu besar. Maksimal 5MB.',
    metaMaskNotFound: 'MetaMask tidak ditemukan! Silakan instal MetaMask.',
    metaMaskNoAccounts: 'Tidak ada akun di MetaMask.',
    phantomNotFound: 'Wallet Phantom tidak ditemukan! Silakan instal Phantom.',
    phantomNoPublicKey: 'Tidak ada public key di Phantom.',
    okxNotFound: 'OKX Wallet tidak ditemukan! Silakan instal OKX Wallet.',
    okxNoAccounts: 'Tidak ada akun di OKX Wallet.',
    walletAddressInUse: 'Alamat wallet ini sudah digunakan oleh pengguna lain.',
    invalidWalletType: 'Tipe wallet tidak valid.',
    },
  };

  const t = (key) => translations[language][key] || key;

  React.useEffect(() => {
    const savedDarkMode = localStorage.getItem('darkMode') === 'true';
    setDarkMode(savedDarkMode);
    if (savedDarkMode) {
      document.documentElement.classList.add('dark');
    }

    const getSession = async () => {
      setIsLoading(true);
      try {
        const { data, error } = await supabase.auth.getSession();
        if (error) throw error;
        console.log('App: Session data:', data);
        if (data.session && data.session.user) {
          setSession(data.session);
          setUser(data.session.user);
          console.log('App: User authenticated:', data.session.user.id);
          await ensureProfileAndWallet(data.session.user);
          await Promise.all([
            fetchUserProfile(data.session.user.id),
            restoreMiningState(data.session.user.id),
          ]);
        } else {
          console.log('App: No active session found');
          setUser(null);
          setSession(null);
          setMiningState({
            status: 'stopped',
            hashRate: 0,
            btcMined: 0,
            networkSpeed: 0,
            sessionId: null,
            lastUpdate: null,
          });
        }
      } catch (err) {
        console.error('App: Session restore error:', err);
        setError(`Failed to restore session: ${err.message}`);
      } finally {
        setIsLoading(false);
      }
    };
    getSession();

    const { data: authListener } = supabase.auth.onAuthStateChange(async (event, session) => {
      console.log('App: Auth state changed:', event, session);
      setSession(session);
      setUser(session?.user ?? null);
      if (session?.user) {
        await ensureProfileAndWallet(session.user);
        await Promise.all([
          fetchUserProfile(session.user.id),
          restoreMiningState(session.user.id),
        ]);
      } else {
        console.log('App: Resetting mining state due to logout');
        setMiningState({
          status: 'stopped',
          hashRate: 0,
          btcMined: 0,
          networkSpeed: 0,
          sessionId: null,
          lastUpdate: null,
        });
        miningAnimationActive = false;
      }
    });

    return () => {
      authListener?.subscription.unsubscribe();
    };
  }, []);

  const ensureProfileAndWallet = async (user) => {
    try {
      // Pastikan profil ada
      const { data: profileData, error: profileError } = await supabase
        .from('profiles')
        .select('id, referral_code')
        .eq('id', user.id)
        .maybeSingle();

      if (profileError && profileError.code !== 'PGRST116') {
        throw profileError;
      }

      if (!profileData) {
        console.log('ensureProfileAndWallet: Creating profile for user:', user.id);
        const referralCode = generateReferralCode(); // Gunakan fungsi global
        const { error: insertProfileError } = await supabase.from('profiles').insert({
          id: user.id,
          email: user.email,
          full_name: user.user_metadata?.full_name || '',
          phone_number: '',
          profile_photo: '',
          referral_code: referralCode,
          created_at: new Date().toISOString(),
        });
        if (insertProfileError) throw insertProfileError;
      } else if (!profileData.referral_code) {
        console.log('ensureProfileAndWallet: Updating referral code for user:', user.id);
        const referralCode = generateReferralCode(); // Gunakan fungsi global
        const { error: updateProfileError } = await supabase
          .from('profiles')
          .update({ referral_code: referralCode })
          .eq('id', user.id);
        if (updateProfileError) throw updateProfileError;
      }

      // Pastikan wallet ada
      const { data: walletData, error: walletError } = await supabase
        .from('wallet')
        .select('user_id')
        .eq('user_id', user.id)
        .maybeSingle();

      if (walletError && walletError.code !== 'PGRST116') {
        throw walletError;
      }

      if (!walletData) {
        console.log('ensureProfileAndWallet: Creating wallet for user:', user.id);
        const { error: insertWalletError } = await supabase.from('wallet').insert({
          user_id: user.id,
          balance: 0,
          last_updated: new Date().toISOString(),
        });
        if (insertWalletError) throw insertWalletError;
      }
    } catch (err) {
      console.error('ensureProfileAndWallet: Error:', err);
      setError(`Failed to ensure profile or wallet: ${err.message}`);
    }
  };

  const fetchUserProfile = async (userId) => {
    try {
      console.log('fetchUserProfile: Fetching profile for user:', userId);
      const { data, error } = await supabase
        .from('profiles')
        .select('full_name, phone_number, profile_photo, email, referral_code, referred_by')
        .eq('id', userId)
        .single();

      if (error) {
        if (error.code === 'PGRST116') {
          const referralCode = generateReferralCode(); // Gunakan fungsi global
          console.log('fetchUserProfile: Creating profile for user:', userId);
          const { error: insertError } = await supabase.from('profiles').insert({
            id: userId,
            full_name: '',
            phone_number: '',
            profile_photo: '',
            email: user?.email || '',
            referral_code: referralCode,
            created_at: new Date().toISOString(),
          });
          if (insertError) throw insertError;
          setProfile({
            full_name: '',
            phone_number: '',
            profile_photo: null,
            profile_photo_url: '',
            email: user?.email || '',
            referral_code: referralCode,
            referred_by: null,
          });
        } else {
          throw error;
        }
      } else {
        console.log('fetchUserProfile: Profile data:', data);
        setProfile({
          full_name: data.full_name || '',
          phone_number: data.phone_number || '',
          profile_photo: null,
          profile_photo_url: data.profile_photo || '',
          email: data.email || user?.email || '',
          referral_code: data.referral_code || generateReferralCode(),
          referred_by: data.referred_by || null,
        });
      }
    } catch (err) {
      console.error('fetchUserProfile: Error:', err);
      setError(`Failed to fetch profile: ${err.message}`);
    }
  };

  const restoreMiningState = async (userId) => {
    try {
      console.log('restoreMiningState: Restoring mining state for user:', userId);
      // Bersihkan sesi duplikat
      const { data: activeSessions, error: fetchError } = await supabase
        .from('mining_sessions')
        .select('id')
        .eq('user_id', userId)
        .is('end_time', null);

      if (fetchError) {
        console.error('restoreMiningState: Failed to fetch active sessions:', fetchError);
        throw fetchError;
      }

      if (activeSessions && activeSessions.length > 1) {
        console.log('restoreMiningState: Cleaning up duplicate sessions for user:', userId);
        const sessionIdsToDelete = activeSessions.slice(1).map((session) => session.id);
        const { error: deleteError } = await supabase
          .from('mining_sessions')
          .delete()
          .in('id', sessionIdsToDelete);
        if (deleteError) {
          console.error('restoreMiningState: Failed to delete duplicate sessions:', deleteError);
          throw deleteError;
        }
      }

      // Ambil sesi aktif
      const { data, error } = await supabase
        .from('mining_sessions')
        .select('*')
        .eq('user_id', userId)
        .is('end_time', null)
        .limit(1)
        .maybeSingle();

      if (error) {
        console.error('restoreMiningState: Failed to restore mining state:', error);
        throw new Error(`Failed to restore mining state: ${error.message}`);
      }

      if (data) {
        console.log('restoreMiningState: Restored mining session:', data.id);
        setMiningState({
          status: 'mining',
          hashRate: data.hash_rate || 0,
          btcMined: data.btc_mined || 0,
          networkSpeed: data.network_speed || 0,
          sessionId: data.id,
          lastUpdate: new Date().toISOString(),
        });
        miningAnimationActive = true;
      } else {
        console.log('restoreMiningState: No active mining session found');
        // Periksa localStorage untuk pemulihan
        const savedState = localStorage.getItem('miningState');
        if (savedState) {
          const parsedState = JSON.parse(savedState);
          if (parsedState.userId === userId && parsedState.sessionId) {
            console.log('restoreMiningState: Restoring from localStorage:', parsedState);
            const { data: sessionData, error: sessionError } = await supabase
              .from('mining_sessions')
              .select('id, btc_mined')
              .eq('id', parsedState.sessionId)
              .eq('user_id', userId)
              .single();
            if (sessionError || !sessionData) {
              console.error('restoreMiningState: Invalid session in localStorage:', sessionError);
              localStorage.removeItem('miningState');
              setMiningState({
                status: 'stopped',
                hashRate: 0,
                btcMined: 0,
                networkSpeed: 0,
                sessionId: null,
                lastUpdate: null,
              });
              return;
            }

            // Simpan BTC yang ditambang ke wallet
            const { data: walletData, error: walletError } = await supabase
              .from('wallet')
              .select('balance')
              .eq('user_id', userId)
              .maybeSingle();
            if (walletError && walletError.code !== 'PGRST116') throw walletError;

            const newBalance = (walletData?.balance || 0) + parsedState.btc_mined;
            const { error: updateWalletError } = await supabase
              .from('wallet')
              .upsert({
                user_id: userId,
                balance: newBalance,
                last_updated: new Date().toISOString(),
              });
            if (updateWalletError) throw updateWalletError;

            // Tandai sesi sebagai selesai
            const { error: updateSessionError } = await supabase
              .from('mining_sessions')
              .update({
                btc_mined: parsedState.btc_mined,
                end_time: new Date().toISOString(),
              })
              .eq('id', parsedState.sessionId)
              .eq('user_id', userId);
            if (updateSessionError) throw updateSessionError;

            // Catat transaksi
            const { error: transactionError } = await supabase
              .from('transactions')
              .insert([
                {
                  user_id: userId,
                  type: 'mining',
                  amount: parsedState.btc_mined,
                  description: 'Mining session restored from localStorage',
                  created_at: new Date().toISOString(),
                },
              ]);
            if (transactionError) throw transactionError;

            localStorage.removeItem('miningState');
            console.log('restoreMiningState: Successfully restored and saved mining data');
          } else {
            localStorage.removeItem('miningState');
          }
        }
        setMiningState({
          status: 'stopped',
          hashRate: 0,
          btcMined: 0,
          networkSpeed: 0,
          sessionId: null,
          lastUpdate: null,
        });
      }
    } catch (err) {
      console.error('restoreMiningState: Error:', err);
      setError(`Failed to restore mining state: ${err.message}`);
    }
  };

  const handleLogout = async () => {
    try {
      const { error } = await supabase.auth.signOut();
      if (error) throw error;
      setUser(null);
      setSession(null);
      setActiveTab('home');
      setProfile({
        full_name: '',
        phone_number: '',
        profile_photo: null,
        profile_photo_url: '',
        email: '',
        referral_code: '',
        referred_by: null,
      });
      setMiningState({
        status: 'stopped',
        hashRate: 0,
        btcMined: 0,
        networkSpeed: 0,
        sessionId: null,
        lastUpdate: null,
      });
      miningAnimationActive = false;
      localStorage.removeItem('miningState');
    } catch (err) {
      setError(`Failed to logout: ${err.message}`);
    }
  };

  const toggleDarkMode = () => {
    const newMode = !darkMode;
    setDarkMode(newMode);
    localStorage.setItem('darkMode', newMode);
    if (newMode) {
      document.documentElement.classList.add('dark');
    } else {
      document.documentElement.classList.remove('dark');
    }
  };

  const changeLanguage = (lang) => {
    setLanguage(lang);
  };

  if (isLoading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <i className="bi bi-arrow-repeat animate-spin text-4xl text-gold-600"></i>
      </div>
    );
  }

  if (!user) {
    return (
      <AuthPage
        setActiveTab={setActiveTab}
        t={t}
        language={language}
        changeLanguage={changeLanguage}
        setUser={setUser}
        setSession={setSession}
      />
    );
  }

  return (
    <div className={`min-h-screen flex flex-col md:flex-row ${darkMode ? 'dark' : ''}`}>
      {error && (
        <div className="fixed top-4 right-4 bg-red-100 dark:bg-red-900 border border-red-400 dark:border-red-700 text-red-700 dark:text-red-100 px-4 py-3 rounded shadow-lg z-50">
          {error}
          <button
            onClick={() => setError('')}
            className="ml-2 text-red-700 dark:text-red-100 hover:text-red-900 dark:hover:text-red-300"
          >
            <i className="bi bi-x"></i>
          </button>
        </div>
      )}
      <Sidebar
  activeTab={activeTab}
  setActiveTab={setActiveTab}
  isMobileMenuOpen={isMobileMenuOpen}
  profilePhoto={profile.profile_photo_url}
  t={t}
  setIsMobileMenuOpen={setIsMobileMenuOpen}
  handleLogout={handleLogout}
      />
      <div className="flex-1 flex flex-col">
        <TopNavbar
  handleLogout={handleLogout} // <-- Penting!
  isMobileMenuOpen={isMobileMenuOpen}
  setIsMobileMenuOpen={setIsMobileMenuOpen}
  profilePhoto={profile.profile_photo_url}
  darkMode={darkMode}
  toggleDarkMode={toggleDarkMode}
  t={t}
  language={language}
  changeLanguage={changeLanguage}
/>
        <main className="flex-grow p-4 md:p-6 main-content">
  {activeTab === 'home' && <HomePage t={t} user={user} />} {/* Tambahkan user di sini */}
  {activeTab === 'dashboard' && (
    <DashboardPage
      user={user}
      t={t}
      miningState={miningState}
      setMiningState={setMiningState}
      profile={profile}
    />
  )}
  {activeTab === 'profile' && (
    <ProfilePage
      profile={profile}
      setProfile={setProfile}
      userId={user.id}
      fetchUserProfile={fetchUserProfile}
      t={t}
    />
  )}
  {activeTab === 'wallet' && <WalletPage user={user} t={t} />}
  {activeTab === 'leaderboard' && <LeaderboardPage user={user} t={t} />}
  {activeTab === 'settings' && (
    <SettingsPage darkMode={darkMode} toggleDarkMode={toggleDarkMode} t={t} />
  )}
</main>s
        <MobileBottomNav activeTab={activeTab} setActiveTab={setActiveTab} t={t} />
      </div>
    </div>
  );
}
function Sidebar({ activeTab, setActiveTab, isMobileMenuOpen, profilePhoto, t, setIsMobileMenuOpen, handleLogout }) {
  const navItems = [
    { id: 'home', icon: 'bi-house', label: t('welcome') },
    { id: 'dashboard', icon: 'bi-speedometer2', label: t('dashboard') },
    { id: 'profile', icon: 'bi-person', label: t('profile') },
    { id: 'wallet', icon: 'bi-wallet', label: t('wallet') },
    { id: 'leaderboard', icon: 'bi-trophy', label: t('leaderboard') },
    { id: 'settings', icon: 'bi-gear', label: t('settings') },
  ];

  return (
    <>
      <div
        className={`sidebar-overlay ${isMobileMenuOpen ? 'sidebar-open' : ''}`}
        onClick={() => setIsMobileMenuOpen(false)}
      />
      <div
        className={`sidebar ${isMobileMenuOpen ? 'sidebar-open' : ''} w-96 bg-gray-800 text-white shadow-lg fixed top-0 left-0 h-screen z-20 flex flex-col`}
      >
        {isMobileMenuOpen && (
          <button
            className="sidebar-close-btn md:hidden p-4"
            onClick={() => setIsMobileMenuOpen(false)}
          >
            <i className="bi bi-x-lg text-xl text-white"></i>
          </button>
        )}
        <div className="p-6 flex items-center border-b border-gray-700 gold-gradient">
          <i className="bi bi-currency-bitcoin text-white text-3xl mr-3"></i>
          <span className="text-2xl font-semibold text-white">Gold Miner</span>
        </div>
        <div className="flex-grow overflow-y-auto p-6">
          {navItems.map((item) => (
            <button
              key={item.id}
              onClick={() => {
                setActiveTab(item.id);
                setIsMobileMenuOpen(false);
              }}
              className={`w-full px-4 py-3 rounded-lg text-base font-medium flex items-center mb-3 transition-all ${
                activeTab === item.id
                  ? 'bg-gray-900 text-gold-600 text-lg font-bold gold-gradient'
                  : 'text-gray-300 hover:bg-gray-700 hover:text-white'
              }`}
            >
              <i
                className={`bi ${item.icon} mr-4 text-xl ${
                  activeTab === item.id ? 'text-white' : 'text-gold-400'
                }`}
              ></i>
              {item.label}
            </button>
          ))}
        </div>
        <div className="p-6 border-t border-gray-700">
          <div className="flex items-center mb-4">
            {profilePhoto ? (
              <img className="h-10 w-10 rounded-full mr-4 border-2 border-gold-400" src={profilePhoto} alt="Profile" />
            ) : (
              <i className="bi bi-person-circle text-3xl mr-4 text-gold-400"></i>
            )}
            <span className="text-base text-gold-200">{t('welcome')}, Miner</span>
          </div>
          <button
            onClick={handleLogout}
            className="w-full mt-2 bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-md font-medium flex items-center justify-center transition-colors duration-300"
          >
            <i className="bi bi-box-arrow-right mr-2"></i> {t('logout')}
          </button>
        </div>
      </div>
    </>
  );
}


// Top Navbar Component
function TopNavbar({
  handleLogout,
  isMobileMenuOpen,
  setIsMobileMenuOpen,
  profilePhoto,
  darkMode,
  toggleDarkMode,
  t,
  language,
  changeLanguage,
}) {
  return (
    <nav className="bg-gray-800 text-white shadow-lg md:hidden">
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div className="flex justify-between h-16">
          <div className="flex items-center">
            <button
              onClick={() => setIsMobileMenuOpen(!isMobileMenuOpen)}
              className="inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-white hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-white"
            >
              <span className="sr-only">Open menu</span>
              <i className={`bi ${isMobileMenuOpen ? 'bi-x' : 'bi-list'} text-2xl`}></i>
            </button>
          </div>
          <div className="flex items-center space-x-4">
            <div className="language-selector relative">
              <button className="flex items-center text-sm text-gold-300">
                <i className="bi bi-translate mr-1"></i>
                {language === 'en' ? 'EN' : 'ID'}
              </button>
              <div className="language-dropdown bg-gray-800 rounded-md shadow-lg py-1">
                <button
                  onClick={() => changeLanguage('en')}
                  className="w-full text-left px-4 py-2 text-sm text-white hover:bg-gray-700 flex items-center"
                >
                  <i className="bi bi-check-lg mr-2 opacity-0"></i>
                  English
                  {language === 'en' && <i className="bi bi-check-lg ml-2 text-gold-400"></i>}
                </button>
                <button
                  onClick={() => changeLanguage('id')}
                  className="w-full text-left px-4 py-2 text-sm text-white hover:bg-gray-700 flex items-center"
                >
                  <i className="bi bi-check-lg mr-2 opacity-0"></i>
                  Bahasa Indonesia
                  {language === 'id' && <i className="bi bi-check-lg ml-2 text-gold-400"></i>}
                </button>
              </div>
            </div>
            <button
              onClick={toggleDarkMode}
              className="p-2 rounded-md text-gray-400 hover:text-white hover:bg-gray-700"
            >
              <i className={`bi ${darkMode ? 'bi-sun' : 'bi-moon'} text-xl`}></i>
            </button>
            <div className="ml-4 relative">
              <div className="flex items-center">
                {profilePhoto ? (
                  <img className="h-8 w-8 rounded-full" src={profilePhoto} alt="Profile" />
                ) : (
                  <i className="bi bi-person-circle text-2xl text-gold-400"></i>
                )}
                <button
                  onClick={handleLogout}
                  className="ml-4 px-3 py-2 rounded-md text-sm font-medium text-gray-300 hover:bg-gray-700 hover:text-white flex items-center"
                >
                  <i className="bi bi-box-arrow-right mr-1"></i> {t('logout')}
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </nav>
  );
}

// Mobile Bottom Navigation Component
function MobileBottomNav({ activeTab, setActiveTab, t }) {
  const navItems = [
    { id: 'home', icon: 'bi-house', label: t('welcome') },
    { id: 'dashboard', icon: 'bi-speedometer2', label: t('mining') },
    { id: 'profile', icon: 'bi-person', label: t('profile') },
    { id: 'wallet', icon: 'bi-wallet', label: t('wallet') },
  ];

  return (
    <div className="md:hidden fixed bottom-0 left-0 right-0 bg-gray-800 text-white shadow-lg-t z-10">
      <div className="flex justify-around items-center h-16">
        {navItems.map((item) => (
          <button
            key={item.id}
            onClick={() => setActiveTab(item.id)}
            className={`flex flex-col items-center justify-center w-full h-full transition-all ${
              activeTab === item.id ? 'text-gold-400 scale-110' : 'text-gray-300'
            }`}
          >
            <i className={`bi ${item.icon} text-xl mobile-icon`}></i>
            <span className="text-xs mt-1">{item.label}</span>
          </button>
        ))}
      </div>
    </div>
  );
}

function AuthPage({ setActiveTab, t, language, changeLanguage, setUser, setSession }) {
  const [email, setEmail] = React.useState('');
  const [password, setPassword] = React.useState('');
  const [fullName, setFullName] = React.useState('');
  const [referralCode, setReferralCode] = React.useState('');
  const [isLogin, setIsLogin] = React.useState(true);
  const [error, setError] = React.useState('');
  const [success, setSuccess] = React.useState('');
  const [isLoading, setIsLoading] = React.useState(false);

  // Check for referral code in URL
  React.useEffect(() => {
    const urlParams = new URLSearchParams(window.location.search);
    const refCode = urlParams.get('ref');
    if (refCode) {
      setReferralCode(refCode);
    }
  }, []);

  const handleAuth = async (e) => {
    e.preventDefault();
    setIsLoading(true);
    setError('');
    setSuccess('');

    try {
      if (isLogin) {
        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) throw error;
        if (data.user && data.session) {
          setUser(data.user);
          setSession(data.session);
          setActiveTab('dashboard');
        }
      } else {
        const newReferralCode = generateReferralCode(); // Gunakan fungsi global
        const { data, error: signUpError } = await supabase.auth.signUp({
          email,
          password,
          options: {
            data: {
              full_name: fullName,
              referral_code: newReferralCode,
            },
          },
        });

        if (signUpError) {
          console.error('handleAuth: Sign-up error:', signUpError);
          if (signUpError.status === 429) {
            throw new Error('Too many requests. Please wait a moment and try again.');
          }
          throw new Error(signUpError.message);
        }

        if (data.user) {
          let referredBy = null;
          if (referralCode) {
            const { data: referrer, error: referrerError } = await supabase
              .from('profiles')
              .select('id')
              .eq('referral_code', referralCode)
              .single();
            if (referrerError || !referrer) {
              console.warn('Invalid referral code:', referralCode);
            } else {
              referredBy = referrer.id;
            }
          }

          // Pastikan sesi aktif sebelum INSERT
          if (data.session) {
            await supabase.auth.setSession(data.session);
            const { error: profileError } = await supabase.from('profiles').upsert({
              id: data.user.id,
              email: data.user.email,
              full_name: fullName,
              phone_number: '',
              profile_photo: '',
              referral_code: newReferralCode,
              referred_by: referredBy,
              created_at: new Date().toISOString(),
            });

            if (profileError) {
              console.error('handleAuth: Profile creation error:', profileError);
              throw new Error(profileError.message);
            }

            const { error: walletError } = await supabase.from('wallet').upsert({
              user_id: data.user.id,
              balance: 0,
              last_updated: new Date().toISOString(),
            });

            if (walletError) {
              console.error('handleAuth: Wallet creation error:', walletError);
              throw new Error(walletError.message);
            }
          }

          setSuccess('Registration successful! Please check your email for confirmation.');
          setIsLogin(true);
        } else {
          throw new Error('No user returned after sign-up');
        }
      }
    } catch (err) {
      console.error('handleAuth: Error:', err);
      let errorMessage = `Authentication failed: ${err.message}`;
      if (err.message.includes('Too many requests')) {
        errorMessage = 'Too many requests. Retrying in 10 seconds...';
        setTimeout(() => handleAuth(e), 10000); // Retry setelah 10 detik
      }
      setError(errorMessage);
    } finally {
      setIsLoading(false);
    }
  };

  const handleOAuthLogin = async (provider) => {
    setIsLoading(true);
    setError('');
    console.log('handleOAuthLogin: Initiating OAuth login with provider:', provider);
    try {
      const { error } = await supabase.auth.signInWithOAuth({
        provider,
        options: {
          redirectTo: window.location.origin, // Pastikan redirect kembali ke aplikasi
        },
      });
      if (error) {
        console.error('handleOAuthLogin: OAuth error:', error);
        throw error;
      }
      console.log('handleOAuthLogin: OAuth request initiated, awaiting redirect');
    } catch (err) {
      console.error('handleOAuthLogin: Error:', err);
      setError(t('oauthLoginFailed') || 'Failed to login with OAuth. Please try again.');
    } finally {
      setIsLoading(false);
    }
  };

  const handlePasswordReset = async () => {
    if (!email) {
      setError('Please enter your email to reset password');
      return;
    }

    setIsLoading(true);
    setError('');

    try {
      const { error } = await supabase.auth.resetPasswordForEmail(email);
      if (error) throw error;
      setSuccess('Password reset link sent to your email');
    } catch (err) {
      setError(`Password reset failed: ${err.message}`);
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50 dark:bg-gray-900 py-12 px-4 sm:px-6 lg:px-8 transition-colors duration-300">
      {isLoading && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="flex flex-col items-center">
            <i className="bi bi-arrow-repeat animate-spin text-4xl text-gold-600 mb-2"></i>
            <p className="text-white text-lg">{t('loggingIn') || 'Logging in...'}</p>
          </div>
        </div>
      )}
      <div className="max-w-md w-full space-y-8 bg-white dark:bg-gray-800 p-8 rounded-lg shadow-md crystal-card transition-colors duration-300">
        <div className="text-center">
          <i className="bi bi-currency-bitcoin text-5xl text-gold-600 mb-4"></i>
          <h2 className="mt-6 text-3xl font-extrabold text-gray-900 dark:text-white gold-text-gradient">
            {isLogin ? t('signIn') : t('signUp')}
          </h2>
        </div>

        {error && (
          <div
            className="bg-red-100 dark:bg-red-900 border border-red-400 dark:border-red-700 text-red-700 dark:text-red-100 px-4 py-3 rounded relative"
            role="alert"
          >
            <span className="block sm:inline">{error}</span>
            <button
              onClick={() => setError('')}
              className="ml-2 text-red-700 dark:text-red-100 hover:text-red-900 dark:hover:text-red-300"
            >
              <i className="bi bi-x"></i>
            </button>
          </div>
        )}

        {success && (
          <div
            className="bg-green-100 dark:bg-green-900 border border-green-400 dark:border-green-700 text-green-700 dark:text-green-100 px-4 py-3 rounded relative"
            role="alert"
          >
            <span className="block sm:inline">{success}</span>
          </div>
        )}

        <form className="mt-8 space-y-6" onSubmit={handleAuth}>
          <div className="rounded-md shadow-sm space-y-4">
            {!isLogin && (
              <>
                <div>
                  <label htmlFor="full-name" className="sr-only">
                    {t('fullName')}
                  </label>
                  <input
                    id="full-name"
                    name="full-name"
                    type="text"
                    required
                    className="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 placeholder-gray-500 dark:placeholder-gray-400 text-gray-900 dark:text-white rounded-t-md focus:outline-none focus:ring-gold-500 focus:border-gold-500 focus:z-10 sm:text-sm bg-white dark:bg-gray-700"
                    placeholder={t('fullName')}
                    value={fullName}
                    onChange={(e) => setFullName(e.target.value)}
                  />
                </div>
                <div>
                  <label htmlFor="referral-code" className="sr-only">
                    Referral Code
                  </label>
                  <input
                    id="referral-code"
                    name="referral-code"
                    type="text"
                    className="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 placeholder-gray-500 dark:placeholder-gray-400 text-gray-900 dark:text-white focus:outline-none focus:ring-gold-500 focus:border-gold-500 focus:z-10 sm:text-sm bg-white dark:bg-gray-700"
                    placeholder="Referral Code (optional)"
                    value={referralCode}
                    onChange={(e) => setReferralCode(e.target.value)}
                  />
                </div>
              </>
            )}
            <div>
              <label htmlFor="email-address" className="sr-only">
                {t('email')}
              </label>
              <input
                id="email-address"
                name="email"
                type="email"
                autoComplete="email"
                required
                className="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 placeholder-gray-500 dark:placeholder-gray-400 text-gray-900 dark:text-white focus:outline-none focus:ring-gold-500 focus:border-gold-500 focus:z-10 sm:text-sm bg-white dark:bg-gray-700"
                placeholder={t('email')}
                value={email}
                onChange={(e) => setEmail(e.target.value)}
              />
            </div>
            <div>
              <label htmlFor="password" className="sr-only">
                {t('password')}
              </label>
              <input
                id="password"
                name="password"
                type="password"
                autoComplete="current-password"
                required
                className="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 placeholder-gray-500 dark:placeholder-gray-400 text-gray-900 dark:text-white rounded-b-md focus:outline-none focus:ring-gold-500 focus:border-gold-500 focus:z-10 sm:text-sm bg-white dark:bg-gray-700"
                placeholder={t('password')}
                value={password}
                onChange={(e) => setPassword(e.target.value)}
              />
            </div>
          </div>

          <div className="flex items-center justify-between">
            {isLogin && (
              <div className="text-sm">
                <button
                  type="button"
                  onClick={handlePasswordReset}
                  className="font-medium text-gold-600 hover:text-gold-500 dark:text-gold-400 dark:hover:text-gold-300"
                >
                  {t('forgotPassword')}
                </button>
              </div>
            )}
            <div className="text-sm">
              <button
                type="button"
                onClick={() => setIsLogin(!isLogin)}
                className="font-medium text-gold-600 hover:text-gold-500 dark:text-gold-400 dark:hover:text-gold-300"
              >
                {isLogin ? t('needAccount') : t('haveAccount')}
              </button>
            </div>
          </div>

          <div>
            <button
              type="submit"
              disabled={isLoading}
              className="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-gold-600 hover:bg-gold-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gold-500 disabled:opacity-50"
            >
              {isLoading ? (
                <span className="flex items-center">
                  <i className="bi bi-arrow-repeat animate-spin mr-2"></i>
                  Processing...
                </span>
              ) : isLogin ? t('signIn') : t('signUp')}
            </button>
          </div>
        </form>

        <div className="mt-6">
          <div className="relative">
            <div className="absolute inset-0 flex items-center">
              <div className="w-full border-t border-gray-300 dark:border-gray-600"></div>
            </div>
            <div className="relative flex justify-center text-sm">
              <span className="px-2 bg-white dark:bg-gray-800 text-gray-500 dark:text-gray-400">
                {t('orContinueWith')}
              </span>
            </div>
          </div>

          <div className="mt-6 grid grid-cols-2 gap-3">
            <button
              onClick={() => handleOAuthLogin('github')}
              disabled={isLoading}
              className="w-full inline-flex justify-center py-2 px-4 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-sm font-medium text-gray-500 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-600 disabled:opacity-50"
            >
              <i className="bi bi-github mr-2"></i> GitHub
            </button>
            <button
              onClick={() => handleOAuthLogin('google')}
              disabled={isLoading}
              className="w-full inline-flex justify-center py-2 px-4 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm bg-white dark:bg-gray-700 text-sm font-medium text-gray-500 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-600 disabled:opacity-50"
            >
              <i className="bi bi-google mr-2"></i> Google
            </button>
          </div>
        </div>

        <div className="mt-4 flex justify-center">
          <div className="language-selector relative">
            <button className="flex items-center text-sm text-gold-600 dark:text-gold-400">
              <i className="bi bi-translate mr-1"></i>
              {language === 'en' ? 'English' : 'Bahasa Indonesia'}
            </button>
            <div className="language-dropdown bg-white dark:bg-gray-800 rounded-md shadow-lg py-1 border border-gray-200 dark:border-gray-700">
              <button
                onClick={() => changeLanguage('en')}
                className="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center"
              >
                <i className="bi bi-check-lg mr-2 opacity-0"></i>
                English
                {language === 'en' && (
                  <i className="bi bi-check-lg ml-2 text-gold-600 dark:text-gold-400"></i>
                )}
              </button>
              <button
                onClick={() => changeLanguage('id')}
                className="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center"
              >
                <i className="bi bi-check-lg mr-2 opacity-0"></i>
                Bahasa Indonesia
                {language === 'id' && (
                  <i className="bi bi-check-lg ml-2 text-gold-600 dark:text-gold-400"></i>
                )}
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

function HomePage({ t, user }) {
  const [tasks, setTasks] = React.useState([]);
  const [userTasks, setUserTasks] = React.useState([]);
  const [isLoading, setIsLoading] = React.useState(false);
  const [isAuthLoading, setIsAuthLoading] = React.useState(true);
  const [error, setError] = React.useState('');
  const [taskLoading, setTaskLoading] = React.useState({});
  const [hasActiveBooster, setHasActiveBooster] = React.useState(false); // Added: Track active booster

  // Fetch tasks and user task completions
  const fetchTasks = async () => {
    setIsLoading(true);
    try {
      console.log('Fetching tasks, user:', user);
      // Fetch all tasks
      const { data: tasksData, error: tasksError } = await supabase
        .from('tasks')
        .select('*');

      if (tasksError) throw new Error(`Gagal mengambil tugas: ${tasksError.message}`);
      console.log('Tasks fetched:', tasksData);

      // Filter duplicates by name
      const uniqueTasks = [];
      const taskNames = new Set();
      for (const task of tasksData) {
        if (!taskNames.has(task.name)) {
          taskNames.add(task.name);
          uniqueTasks.push(task);
        }
      }
      setTasks(uniqueTasks);

      if (user?.id) {
        // Ensure user profile exists
        const { data: profileData, error: profileError } = await supabase
          .from('profiles')
          .select('id')
          .eq('id', user.id)
          .single();

        if (profileError && profileError.code !== 'PGRST116') {
          throw new Error(`Gagal memeriksa profil: ${profileError.message}`);
        }
        if (!profileData) {
          console.log('No profile found, creating one for user:', user.id);
          const { error: insertProfileError } = await supabase
            .from('profiles')
            .insert({
              id: user.id,
              username: user.email || `user_${user.id.slice(0, 8)}`,
              created_at: new Date().toISOString(),
              updated_at: new Date().toISOString(),
            });

          if (insertProfileError) throw new Error(`Gagal membuat profil: ${insertProfileError.message}`);
          console.log('Profile created for user:', user.id);
        } else {
          console.log('Profile fetched:', profileData);
        }

        // Fetch user task completions
        const { data: userTasksData, error: userTasksError } = await supabase
          .from('user_tasks')
          .select('task_id, completed_at')
          .eq('user_id', user.id);

        if (userTasksError) throw new Error(`Gagal mengambil tugas pengguna: ${userTasksError.message}`);
        console.log('User tasks fetched:', userTasksData);
        setUserTasks(userTasksData || []);

        // Check for active booster purchases
        const { data: purchasesData, error: purchasesError } = await supabase
  .from('user_boost_purchases')
  .select('id, purchased_at, expires_at')
  .eq('user_id', user.id)
  .gte('expires_at', new Date().toISOString());

if (purchasesError) throw new Error(`Gagal mengambil pembelian booster: ${purchasesError.message}`);
console.log('Booster purchases:', purchasesData);
setHasActiveBooster((purchasesData || []).length > 0);

        if (purchasesError) throw new Error(`Gagal mengambil pembelian booster: ${purchasesError.message}`);
        console.log('Booster purchases:', purchasesData);
        setHasActiveBooster((purchasesData || []).length > 0);
      } else {
        console.log('No user, skipping user tasks fetch');
      }
    } catch (err) {
      setError(err.message || 'Gagal mengambil data tugas');
      console.error('Fetch tasks error:', err);
    } finally {
      setIsLoading(false);
    }
  };

  // Complete a task and update wallet
  const completeTask = async (task, completedAt = new Date().toISOString()) => {
    if (!task?.id) {
      setError('Tugas tidak valid');
      console.error('Invalid task:', task);
      return;
    }
    if (!user?.id) {
      setError('Silakan login untuk menyelesaikan tugas');
      console.log('No user logged in');
      window.location.href = '/login';
      return;
    }
    if (task.type === 'purchase' && !hasActiveBooster) {
      setError('Beli booster terlebih dahulu untuk menyelesaikan tugas ini');
      console.log('No active booster for Buy Booster task');
      return;
    }

    setTaskLoading((prev) => ({ ...prev, [task.id]: true }));
    try {
      // Ensure user profile exists
      const { data: profileData, error: profileError } = await supabase
        .from('profiles')
        .select('id')
        .eq('id', user.id)
        .single();

      if (profileError && profileError.code !== 'PGRST116') {
        throw new Error(`Gagal memeriksa profil: ${profileError.message}`);
      }
      if (!profileData) {
        console.log('No profile found, creating one for user:', user.id);
        const { error: insertProfileError } = await supabase
          .from('profiles')
          .insert({
            id: user.id,
            username: user.email || `user_${user.id.slice(0, 8)}`,
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString(),
          });

        if (insertProfileError) throw new Error(`Gagal membuat profil: ${insertProfileError.message}`);
        console.log('Profile created for user:', user.id);
      }

      // Check if task is already completed
      const { data: existingTask, error: checkError } = await supabase
        .from('user_tasks')
        .select('id')
        .eq('user_id', user.id)
        .eq('task_id', task.id)
        .maybeSingle();

      if (checkError && checkError.code !== 'PGRST116') {
        throw new Error(`Gagal memeriksa tugas: ${checkError.message}`);
      }
      if (existingTask) {
        setError('Tugas ini sudah selesai');
        console.log('Task already completed:', existingTask);
        return;
      }

      // Insert new task completion
      const { error: taskError } = await supabase
        .from('user_tasks')
        .insert({
          id: crypto.randomUUID(),
          user_id: user.id,
          task_id: task.id,
          completed_at: completedAt,
        });

      if (taskError) throw new Error(`Gagal menyelesaikan tugas: ${taskError.message}`);
      console.log('Task completion inserted');

      // Update wallet balance
      const { data: walletData, error: walletError } = await supabase
        .from('wallet')
        .select('balance')
        .eq('user_id', user.id)
        .maybeSingle();

      if (walletError && walletError.code !== 'PGRST116') throw new Error(`Gagal mengambil dompet: ${walletError.message}`);

      const newBalance = (walletData?.balance || 0) + task.reward;
      const { error: updateWalletError } = await supabase
        .from('wallet')
        .upsert({
          user_id: user.id,
          balance: newBalance,
          last_updated: new Date().toISOString(),
        });

      if (updateWalletError) throw new Error(`Gagal memperbarui dompet: ${updateWalletError.message}`);
      console.log('Wallet updated, new balance:', newBalance);

      // Log transaction
      const { error: transactionError } = await supabase
        .from('transactions')
        .insert({
          user_id: user.id,
          type: 'task_reward',
          amount: task.reward,
          description: `Reward dari tugas: ${task.name}`,
          created_at: new Date().toISOString(),
        });

      if (transactionError) {
        console.error('Failed to log transaction:', transactionError);
      } else {
        console.log('Transaction logged');
      }

      // Refresh user tasks
      const { data: userTasksData, error: userTasksError } = await supabase
        .from('user_tasks')
        .select('task_id, completed_at')
        .eq('user_id', user.id);

      if (userTasksError) throw new Error(`Gagal memperbarui tugas pengguna: ${userTasksError.message}`);
      setUserTasks(userTasksData || []);
      setError('');
    } catch (err) {
      setError(err.message || 'Gagal menyelesaikan tugas');
      console.error('Complete task error:', err);
    } finally {
      setTaskLoading((prev) => ({ ...prev, [task.id]: false }));
    }
  };

  // Check auth status and fetch tasks
  React.useEffect(() => {
    const checkAuth = async () => {
      console.log('Checking auth, user:', user);
      setIsAuthLoading(true);
      try {
        const { data: { session } } = await supabase.auth.getSession();
        console.log('Session check:', session);
        if (session?.user) {
          await fetchTasks();
        }
      } catch (err) {
        console.error('Auth check error:', err);
        setError('Gagal memeriksa autentikasi');
      } finally {
        setIsAuthLoading(false);
      }
    };

    checkAuth();
  }, [user]);

  if (isAuthLoading) {
    return (
      <div className="flex justify-center items-center h-screen">
        {/* Spinner dengan efek gradasi dan glow */}
        <div className="relative w-12 h-12">
                                <div className="absolute inset-0 border-4 border-t-transparent border-gold-400 rounded-full animate-spin [animation-duration:1.2s] bg-gradient-to-r from-gold-300/30 to-transparent opacity-50 blur-sm"></div>
                                <div className="absolute inset-0 border-4 border-t-gold-500 border-gold-200/50 rounded-full animate-spin [animation-duration:1.2s]"></div>
                                {/* Inner glow untuk kesan premium */}
                                <div className="absolute inset-2 bg-gold-500/10 rounded-full animate-pulse"></div>
                              </div>
                              {/* Teks dengan efek pulsating */}
                              <span className="ml-4 text-lg font-light text-gray-700 dark:text-gray-200 animate-[pulse_2s_ease-in-out_infinite]">
                                
                              </span>
      </div>
    );
  }

  return (
    <div className="ml-0 md:ml-96 px-4 md:px-6 max-w-full md:max-w-[calc(100%-384px)]">
      <style>
        {`
          .task-card {
            background: linear-gradient(135deg, #f3e7ff 0%, #e8d4ff 100%);
            border: 1px solid #d1c4e9;
            transition: transform 0.3s, box-shadow 0.3s;
          }
          .task-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
          }
          .task-button {
            background: linear-gradient(135deg, #7e57c2 0%, #ab47bc 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background 0.3s;
          }
          .task-button:hover {
            background: linear-gradient(135deg, #9575cd 0%, #ba68c8 100%);
          }
          .task-button:disabled {
            background: #bdbdbd;
            cursor: not-allowed;
          }
          .error-message {
            z-index: 1000;
            position: relative;
          }
        `}
      </style>

      {error && (
        <div className="bg-red-100 dark:bg-red-900 border border-red-400 dark:border-red-700 text-red-700 dark:text-red-100 px-4 py-3 rounded mb-4 error-message">
          {error}
        </div>
      )}

      <div className="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-8 crystal-card transition-colors duration-300 animate-slide-in">
        <h1 className="text-3xl font-bold text-gray-900 dark:text-white mb-6 section-title gold-text-gradient">
          {t('welcome')}
        </h1>
        <p className="text-gray-600 dark:text-gray-300 mb-6 text-lg leading-relaxed">
          Experience the thrill of Bitcoin mining without the expensive hardware! Our simulator lets you
          mine virtual Bitcoin based on your network speed and performance.
        </p>

        <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
          <div className="bg-indigo-50 dark:bg-indigo-900 p-6 rounded-lg about-card transition-transform duration-300 hover:scale-105 hover:shadow-xl">
            <div className="flex items-center mb-3">
              <i className="bi bi-speedometer2 text-indigo-600 dark:text-indigo-300 text-2xl mr-3"></i>
              <h3 className="font-semibold text-indigo-800 dark:text-indigo-200 text-lg">
                Real-time Mining
              </h3>
            </div>
            <p className="text-gray-700 dark:text-gray-300 text-sm leading-relaxed">
              Start and stop mining anytime. Watch your hashrate adjust based on your network speed.
            </p>
          </div>

          <div className="bg-green-50 dark:bg-green-900 p-6 rounded-lg about-card transition-transform duration-300 hover:scale-105 hover:shadow-xl">
            <div className="flex items-center mb-3">
              <i className="bi bi-wallet text-green-600 dark:text-green-300 text-2xl mr-3"></i>
              <h3 className="font-semibold text-green-800 dark:text-green-200 text-lg">
                Track Earnings
              </h3>
            </div>
            <p className="text-gray-700 dark:text-gray-300 text-sm leading-relaxed">
              See your accumulated Bitcoin in your wallet and track your mining history.
            </p>
          </div>

          <div className="bg-yellow-50 dark:bg-yellow-900 p-6 rounded-lg about-card transition-transform duration-300 hover:scale-105 hover:shadow-xl">
            <div className="flex items-center mb-3">
              <i className="bi bi-trophy text-yellow-600 dark:text-yellow-300 text-2xl mr-3"></i>
              <h3 className="font-semibold text-yellow-800 dark:text-yellow-200 text-lg">
                Compete
              </h3>
            </div>
            <p className="text-gray-700 dark:text-gray-300 text-sm leading-relaxed">
              Compare your mining performance with others on the leaderboard.
            </p>
          </div>
        </div>

        <div className="bg-gray-50 dark:bg-gray-700 p-6 rounded-lg border border-gray-200 dark:border-gray-600 mb-8">
          <h3 className="font-semibold text-gray-800 dark:text-gray-200 text-lg mb-3">
            How it works:
          </h3>
          <ol className="list-decimal list-inside text-gray-700 dark:text-gray-300 space-y-3 text-sm">
            <li>Go to the Dashboard to start mining</li>
            <li>Your mining speed depends on your network connection</li>
            <li>Earn virtual Bitcoin based on your hashrate</li>
            <li>Track your earnings in your Wallet</li>
            <li>See how you rank against others on the Leaderboard</li>
          </ol>
        </div>

        <div className="bg-gray-50 dark:bg-gray-700 p-6 rounded-lg border border-gray-200 dark:border-gray-600">
          <h3 className="font-semibold text-gray-800 dark:text-gray-200 text-lg mb-4">
            Tasks - Earn More ₿Ǥɱ
          </h3>
          {tasks.length === 0 ? (
            <p className="text-gray-500 dark:text-gray-400">Tidak ada tugas tersedia.</p>
          ) : (
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              {tasks.map((task) => {
                const isCompleted = userTasks.some((ut) => ut.task_id === task.id);
                const isTaskLoading = taskLoading[task.id] || false;
                console.log(`Task: ${task.name}, isCompleted: ${isCompleted}, isLoading: ${isTaskLoading}, user: ${user ? user.id : 'none'}`);
                return (
                  <div
                    key={task.id}
                    className="task-card p-4 rounded-lg"
                  >
                    <div className="flex items-center mb-2">
                      <i
                        className={`bi ${
                          task.name.includes('Facebook')
                            ? 'bi-facebook'
                            : task.name.includes('Twitter')
                            ? 'bi-twitter'
                            : task.name.includes('Instagram')
                            ? 'bi-instagram'
                            : task.name.includes('YouTube')
                            ? 'bi-youtube'
                            : 'bi-lightning-charge-fill'
                        } text-purple-600 dark:text-purple-300 text-xl mr-2`}
                      ></i>
                      <h4 className="font-semibold text-purple-800 dark:text-purple-200">
                        {task.name}
                      </h4>
                    </div>
                    <p className="text-gray-700 dark:text-gray-300 text-sm mb-2">
                      {task.description}
                    </p>
                    <p className="text-gray-700 dark:text-gray-300 text-sm mb-3">
                      Reward: <span className="font-bold text-gold-600">{task.reward.toFixed(4)} ₿Ǥɱ</span>
                    </p>
                    <button
                      onClick={() => {
                        console.log('Complete Task button clicked for:', task.name);
                        completeTask(task);
                      }}
                      disabled={
                        isCompleted ||
                        isTaskLoading ||
                        !user ||
                        (task.type === 'purchase' && !hasActiveBooster)
                      }
                      className="task-button"
                    >
                      {isTaskLoading ? (
                        <span className="flex items-center">
                          <i className="bi bi-arrow-repeat animate-spin mr-2"></i>
                          Memproses...
                        </span>
                      ) : isCompleted ? (
                        'Selesai'
                      ) : !user ? (
                        'Login Diperlukan'
                      ) : task.type === 'purchase' && !hasActiveBooster ? (
                        'Beli booster dulu'
                      ) : (
                        'Complete Task'
                      )}
                    </button>
                  </div>
                );
              })}
            </div>
          )}
        </div>
      </div>
    </div>
  );
}

const DashboardPage = ({ user, t, miningState, setMiningState, profile }) => {
  const [miningHistory, setMiningHistory] = React.useState([]);
  const [isLoading, setIsLoading] = React.useState(false);
  const [error, setError] = React.useState('');
  const [wallet, setWallet] = React.useState({ balance: 0 });
  const [items, setItems] = React.useState([]);
  const [userItems, setUserItems] = React.useState([]);
  const [dailyMiningData, setDailyMiningData] = React.useState({ labels: [], values: [], boosterValues: [] });
  const [flipStates, setFlipStates] = React.useState({});

  // Toggle flip state on touch for mobile devices
  const handleTouchStart = (itemId) => {
    setFlipStates((prev) => ({
      ...prev,
      [itemId]: !prev[itemId],
    }));
  };

  // Fetch mining history
  const fetchMiningHistory = async () => {
    setIsLoading(true);
    try {
      const { data, error } = await supabase
        .from('mining_sessions')
        .select('*')
        .eq('user_id', user.id)
        .order('start_time', { ascending: false })
        .limit(10);

      if (error) throw error;
      setMiningHistory(data || []);
    } catch (err) {
      setError(`Gagal mengambil riwayat mining: ${err.message}`);
    } finally {
      setIsLoading(false);
    }
  };

  // Fetch daily mining data + booster bonus
  const fetchDailyMiningData = async () => {
    try {
      // Ambil sesi mining 7 hari terakhir
      const { data, error } = await supabase
        .from('mining_sessions')
        .select('start_time, btc_mined, id')
        .eq('user_id', user.id)
        .gte('start_time', new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString());

      if (error) throw error;

      // Ambil booster aktif user
      const { data: purchases } = await supabase
        .from('user_boost_purchases')
        .select('item_id, purchased_at, expires_at')
        .eq('user_id', user.id);

      // Ambil data item booster
      const { data: boostItems } = await supabase
        .from('boost_items')
        .select('id, boost');

      // Hitung hasil harian dan bonus booster
      const dailyData = {};
      const boosterData = {};

      data.forEach((session) => {
        const date = new Date(session.start_time).toLocaleDateString('id-ID', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric',
        });
        dailyData[date] = (dailyData[date] || 0) + (session.btc_mined || 0);

        // Hitung bonus booster
        let boosterBonus = 0;
        if (purchases && boostItems) {
          purchases.forEach((purchase) => {
            const item = boostItems.find((i) => i.id === purchase.item_id);
            if (
              item &&
              new Date(session.start_time) >= new Date(purchase.purchased_at) &&
              new Date(session.start_time) <= new Date(purchase.expires_at)
            ) {
              boosterBonus += ((item.boost - 1) * (session.btc_mined || 0));
            }
          });
        }
        boosterData[date] = (boosterData[date] || 0) + boosterBonus;
      });

      const labels = [];
      const values = [];
      const boosterValues = [];
      for (let i = 6; i >= 0; i--) {
        const date = new Date(Date.now() - i * 24 * 60 * 60 * 1000);
        const dateStr = date.toLocaleDateString('id-ID', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric',
        });
        labels.push(dateStr);
        values.push(dailyData[dateStr] || 0);
        boosterValues.push(boosterData[dateStr] || 0);
      }

      setDailyMiningData({ labels, values, boosterValues });
    } catch (err) {
      setError(`Gagal mengambil data mining harian: ${err.message}`);
    }
  };

  // Fetch available boost items
  const fetchItems = async () => {
    try {
      const { data: availableItems, error: itemsError } = await supabase
        .from('boost_items')
        .select('*');
      if (itemsError) throw itemsError;
      setItems(availableItems || []);

      const { data: purchasedItems, error: purchaseError } = await supabase
        .from('user_boost_purchases')
        .select('*')
        .eq('user_id', user.id)
        .gte('expires_at', new Date().toISOString());
      if (purchaseError) throw purchaseError;
      setUserItems(purchasedItems || []);
    } catch (err) {
      setError(`Gagal mengambil data item: ${err.message}`);
    }
  };

  // Test network speed
  const testNetworkSpeed = async () => {
    const startTime = performance.now();
    try {
      const response = await fetch('https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js', {
        method: 'GET',
        mode: 'cors',
        cache: 'no-store',
      });
      const data = await response.arrayBuffer();
      const endTime = performance.now();
      const duration = (endTime - startTime) / 1000;
      const bitsLoaded = data.byteLength * 8;
      const speedBps = bitsLoaded / duration;
      const speedMbps = speedBps / (1024 * 1024);
      return Math.max(speedMbps, 1);
    } catch (err) {
      try {
        const localResponse = await fetch('/assets/testfile.bin');
        const localData = await localResponse.arrayBuffer();
        const endTime = performance.now();
        const duration = (endTime - startTime) / 1000;
        const bitsLoaded = localData.byteLength * 8;
        const speedBps = bitsLoaded / duration;
        const speedMbps = speedBps / (1024 * 1024);
        return Math.max(speedMbps, 1);
      } catch {
        return 1;
      }
    }
  };

  // Calculate hash rate based on network speed and boosts
  const calculateHashRate = (speedMbps) => {
    const baseHashRate = 10;
    const additional = Math.min(speedMbps * 5, 90);
    const randomFactor = 1 + Math.random() * 0.2;

    let totalBoost = 1;
    userItems.forEach((purchase) => {
      const item = items.find((i) => i.id === purchase.item_id);
      if (item && purchase.expires_at > new Date().toISOString()) {
        totalBoost *= item.boost;
      }
    });

    const hashRate = (baseHashRate + additional) * randomFactor * totalBoost;
    return Math.min(hashRate, 1000);
  };

  // Purchase item function
  const purchaseItem = async (item) => {
    if (!window.ethereum) {
      setError('Silakan instal MetaMask untuk melakukan pembelian');
      return;
    }

    setIsLoading(true);
    try {
      const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
      if (!accounts || accounts.length === 0) {
        throw new Error('Tidak ada akun MetaMask yang ditemukan');
      }

      const value = (item.price * 1e18).toString(16);
      const txHash = await window.ethereum.request({
        method: 'eth_sendTransaction',
        params: [
          {
            from: accounts[0],
            to: '0x597c2c69f5a3538e9809f563274a8f5168bc9907',
            value: '0x' + value,
            gas: '0x5208',
          },
        ],
      });

      const expiresAt = new Date(Date.now() + item.duration).toISOString();
      const { error: purchaseError } = await supabase
        .from('user_boost_purchases')
        .insert({
          id: crypto.randomUUID(),
          user_id: user.id,
          item_id: item.id,
          purchased_at: new Date().toISOString(),
          expires_at: expiresAt,
          transaction_hash: txHash,
        });

      if (purchaseError) {
        throw new Error(`Gagal menyimpan pembelian: ${purchaseError.message}`);
      }

      await fetchItems();
      setError('');
    } catch (err) {
      const errorMessage = err.message || 'Terjadi kesalahan saat membeli item';
      setError(`Gagal membeli item: ${errorMessage}`);
    } finally {
      setIsLoading(false);
    }
  };

  let miningInterval = null;

  // Clear mining interval
  const clearMiningInterval = () => {
    if (miningInterval) {
      clearInterval(miningInterval);
      miningInterval = null;
    }
  };

  // Start mining session
  const startMining = async () => {
    setIsLoading(true);
    setError('');

    try {
      if (!user || !user.id) {
        throw new Error('Pengguna tidak terautentikasi');
      }

      const speedMbps = await testNetworkSpeed();
      const initialHashRate = calculateHashRate(speedMbps);

      const { data, error } = await supabase
        .from('mining_sessions')
        .insert([
          {
            user_id: user.id,
            start_time: new Date().toISOString(),
            network_speed: speedMbps,
            btc_mined: 0,
            hash_rate: initialHashRate,
          },
        ])
        .select()
        .single();

      if (error) throw new Error(`Gagal membuat sesi mining: ${error.message}`);
      if (!data || !data.id) throw new Error('Tidak ada ID sesi dari database');

      setMiningState({
        status: 'mining',
        hashRate: initialHashRate,
        btcMined: 0,
        networkSpeed: speedMbps,
        sessionId: data.id,
        lastUpdate: new Date().toISOString(),
      });
    } catch (err) {
      setError(`Gagal memulai mining: ${err.message}`);
      setMiningState({
        status: 'stopped',
        hashRate: 0,
        btcMined: 0,
        networkSpeed: 0,
        sessionId: null,
        lastUpdate: null,
      });
    } finally {
      setIsLoading(false);
    }
  };

  // Stop mining session
  const stopMining = async () => {
    setIsLoading(true);
    setError('');

    try {
      if (!miningState.sessionId || !user || !user.id) {
        throw new Error('Tidak ada sesi mining aktif atau pengguna tidak valid');
      }

      // Perbarui mining_sessions
      const { error: sessionError } = await supabase
        .from('mining_sessions')
        .update({
          end_time: new Date().toISOString(),
          btc_mined: miningState.btcMined,
          hash_rate: miningState.hashRate,
          network_speed: miningState.networkSpeed,
        })
        .eq('id', miningState.sessionId)
        .eq('user_id', user.id);

      if (sessionError) throw new Error(`Gagal menghentikan sesi mining: ${sessionError.message}`);

      // Perbarui wallet
      const { data: walletData, error: walletError } = await supabase
        .from('wallet')
        .select('balance')
        .eq('user_id', user.id)
        .maybeSingle();

      if (walletError && walletError.code !== 'PGRST116') {
        throw new Error(`Gagal mengambil wallet: ${walletError.message}`);
      }

      const currentBalance = walletData?.balance || 0;
      const newBalance = currentBalance + (miningState.btcMined || 0);

      const { error: updateWalletError } = await supabase
        .from('wallet')
        .upsert({
          user_id: user.id,
          balance: newBalance,
          last_updated: new Date().toISOString(),
        });

      if (updateWalletError) throw new Error(`Gagal memperbarui wallet: ${updateWalletError.message}`);

      // Catat transaksi
      if (miningState.btcMined > 0) {
        await supabase
          .from('transactions')
          .insert([{
            user_id: user.id,
            type: 'mining',
            amount: miningState.btcMined,
            description: 'Sesi mining selesai',
            created_at: new Date().toISOString(),
          }]);
      }

      setMiningState({
        status: 'stopped',
        hashRate: 0,
        btcMined: 0,
        networkSpeed: 0,
        sessionId: null,
        lastUpdate: null,
      });
      localStorage.removeItem('miningState');
      setWallet({ balance: newBalance });
      await fetchMiningHistory();
      await fetchDailyMiningData();
    } catch (err) {
      setError(`Gagal menghentikan mining: ${err.message}`);
    } finally {
      setIsLoading(false);
      clearMiningInterval();
    }
  };

  // Start mining interval
  const startMiningInterval = () => {
    clearMiningInterval();

    if (!miningState.sessionId || !user || !user.id) {
      setError('Tidak dapat memulai interval mining: ID sesi atau pengguna tidak valid');
      setMiningState((prev) => ({
        ...prev,
        status: 'stopped',
        sessionId: null,
      }));
      return;
    }

    let lastSaved = Date.now();

    miningInterval = setInterval(async () => {
      try {
        const newBtcMined = miningState.btcMined + (miningState.hashRate * 0.00001);

        setMiningState((prev) => {
          const updatedState = {
            ...prev,
            btcMined: newBtcMined,
            lastUpdate: new Date().toISOString(),
          };
          localStorage.setItem(
            'miningState',
            JSON.stringify({
              sessionId: prev.sessionId,
              btcMined: newBtcMined,
              lastUpdate: updatedState.lastUpdate,
              userId: user.id,
            })
          );
          return updatedState;
        });

        const now = Date.now();
        if (now - lastSaved >= 10000) {
          // Update mining_sessions dan wallet
          const { data: finishedSessions } = await supabase
            .from('mining_sessions')
            .select('btc_mined')
            .eq('user_id', user.id)
            .not('end_time', 'is', null);

          const { data: activeSession } = await supabase
            .from('mining_sessions')
            .select('btc_mined')
            .eq('id', miningState.sessionId)
            .eq('user_id', user.id)
            .is('end_time', null)
            .maybeSingle();

          let totalMined = 0;
          if (finishedSessions) {
            totalMined += finishedSessions.reduce((sum, s) => sum + (s.btc_mined || 0), 0);
          }
          if (activeSession) {
            totalMined += activeSession.btc_mined || 0;
          }

          await supabase
            .from('wallet')
            .update({
              balance: totalMined,
              last_updated: new Date().toISOString(),
            })
            .eq('user_id', user.id);

          setWallet({ balance: totalMined });
        }

        // Perbarui network speed setiap 10 detik
        const lastUpdateTime = miningState.lastUpdate ? new Date(miningState.lastUpdate).getTime() : 0;
        if (!miningState.lastUpdate || now - lastUpdateTime >= 10000) {
          const newSpeed = await testNetworkSpeed();
          const newHashRate = calculateHashRate(newSpeed);
          setMiningState((prev) => ({
            ...prev,
            networkSpeed: newSpeed,
            hashRate: newHashRate,
            lastUpdate: new Date().toISOString(),
          }));
        }
      } catch (error) {
        setError(`Peringatan mining: ${error.message || error}`);
      }
    }, 1000);
  };

  // Effects
  React.useEffect(() => {
    if (miningState.status === 'mining' && miningState.sessionId) {
      startMiningInterval();
    }
    return () => clearMiningInterval();
  }, [miningState]);

  React.useEffect(() => {
    if (user) {
      fetchMiningHistory();
      fetchItems();
      fetchDailyMiningData();
      const fetchWallet = async () => {
        try {
          const { data: walletData, error: walletError } = await supabase
            .from('wallet')
            .select('balance')
            .eq('user_id', user.id)
            .maybeSingle();
          if (walletError && walletError.code !== 'PGRST116') throw walletError;
          setWallet({ balance: walletData?.balance || 0 });
        } catch (err) {
          setError(`Gagal mengambil wallet: ${err.message}`);
        }
      };
      fetchWallet();
    }
    return () => clearMiningInterval();
  }, [user]);

  React.useEffect(() => {
    const handleBeforeUnload = () => {
      if (miningState.status === 'mining' && miningState.sessionId && user?.id) {
        try {
          localStorage.setItem(
            'miningState',
            JSON.stringify({
              sessionId: miningState.sessionId,
              btcMined: miningState.btcMined,
              lastUpdate: new Date().toISOString(),
              userId: user.id,
            })
          );
        } catch {}
      }
    };

    window.addEventListener('beforeunload', handleBeforeUnload);
    return () => {
      window.removeEventListener('beforeunload', handleBeforeUnload);
      clearMiningInterval();
    };
  }, [miningState.sessionId, miningState.status, miningState.btcMined, user]);

  React.useEffect(() => {
    if (dailyMiningData.labels && dailyMiningData.labels.length > 0) {
      const ctx = document.getElementById('miningChart')?.getContext('2d');
      if (ctx) {
        const existingChart = Chart.getChart(ctx);
        if (existingChart) {
          existingChart.destroy();
        }

        // Cek apakah user punya booster aktif (ada nilai > 0 di boosterValues)
        const hasBooster = dailyMiningData.boosterValues && dailyMiningData.boosterValues.some(v => v > 0);

        // Dataset selalu 1 (kuning), dan tambah hijau jika user punya booster aktif
        const datasets = [
          {
            label: '₿Ǥɱ Ditambang',
            data: dailyMiningData.values,
            backgroundColor: 'rgba(255, 215, 0, 0.6)',
            borderColor: 'rgba(255, 215, 0, 1)',
            borderWidth: 1,
          },
        ];
        if (hasBooster) {
          datasets.push({
            label: 'Bonus Booster',
            data: dailyMiningData.boosterValues,
            backgroundColor: 'rgba(0, 200, 83, 0.4)',
            borderColor: 'rgba(0, 200, 83, 1)',
            borderWidth: 1,
          });
        }

        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: dailyMiningData.labels,
            datasets,
          },
          options: {
            scales: {
              y: {
                beginAtZero: true,
                title: {
                  display: true,
                  text: '₿Ǥɱ',
                },
              },
              x: {
                title: {
                  display: true,
                  text: 'Tanggal',
                },
              },
            },
            plugins: {
              legend: {
                display: true,
              },
            },
          },
        });
      }
    }
  }, [dailyMiningData]);

  // Helper functions
  const formatTime = (dateString) => {
    if (!dateString) return 'N/A';
    return new Date(dateString).toLocaleString();
  };

  const formatDuration = (start, end) => {
    if (!start) return 'N/A';
    const startDate = new Date(start);
    const endDate = end ? new Date(end) : new Date();
    const seconds = Math.floor((endDate - startDate) / 1000);
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;
    return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs
      .toString()
      .padStart(2, '0')}`;
  };

  return (
    <div className="ml-0 md:ml-96 px-4 md:px-6 max-w-full md:max-w-[calc(100%-384px)]">
      <style>
        {`
          .booster-card {
            width: 260px;
            height: 160px;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
            perspective: 1000px;
          }

          .booster-card:hover .booster-front,
          .booster-card.touched .booster-front {
            transform: rotateY(-180deg);
            z-index: 1;
          }

          .booster-card:hover .booster-back,
          .booster-card.touched .booster-back {
            transform: rotateY(0deg);
            z-index: 2;
          }

          .booster-card.basic {
            background: linear-gradient(135deg, #2E7D32 0%, #66BB6A 100%);
            border: 1px solid #4CAF50;
          }

          .booster-card.basic::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
              to right,
              rgba(255, 255, 255, 0) 0%,
              rgba(255, 255, 255, 0.2) 50%,
              rgba(255, 255, 255, 0) 100%
            );
            transform: rotate(45deg);
            animation: shine 6s infinite;
            pointer-events: none;
          }

          .booster-card.pro {
            background: linear-gradient(135deg, #1565C0 0%, #42A5F5 100%);
            border: 1px solid #2196F3;
          }

          .booster-card.pro::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
              to right,
              rgba(255, 255, 255, 0) 0%,
              rgba(255, 255, 255, 0.3) 50%,
              rgba(255, 255, 255, 0) 100%
            );
            transform: rotate(45deg);
            animation: shine 5s infinite;
            pointer-events: none;
          }

          .booster-card.elite {
            background: linear-gradient(135deg, #D4AF37 0%, #FFD700 100%);
            border: 2px solid #FFD700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
          }

          .booster-card.elite::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
              to right,
              rgba(255, 255, 255, 0) 0%,
              rgba(255, 255, 255, 0.5) 50%,
              rgba(255, 255, 255, 0) 100%
            );
            transform: rotate(45deg);
            animation: shine 4s infinite;
            pointer-events: none;
          }

          .booster-card.elite::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><path fill="rgba(255,255,255,0.05)" d="M30,10L50,30L70,10L90,30L70,50L90,70L70,90L50,70L30,90L10,70L30,50L10,30L30,10Z"/></svg>');
            background-size: 60px 60px;
            opacity: 0.3;
            pointer-events: none;
          }

          @keyframes shine {
            0% { transform: translateX(-100%) rotate(45deg); }
            100% { transform: translateX(100%) rotate(45deg); }
          }

          .booster-front, .booster-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            transition: transform 0.6s, z-index 0.6s;
            border-radius: 12px;
            overflow: hidden;
          }

          .booster-front {
            transform: rotateY(0deg);
            z-index: 2;
          }

          .booster-back {
            transform: rotateY(180deg);
            z-index: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 16px;
            color: white;
            background: inherit;
          }

          .booster-content {
            position: relative;
            z-index: 2;
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 16px;
            color: white;
          }

          .booster-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
          }

          .booster-title {
            font-size: 1.2rem;
            font-weight: 700;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
          }

          .booster-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
          }

          .basic .booster-badge {
            background: rgba(0, 100, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.3);
          }

          .pro .booster-badge {
            background: rgba(0, 0, 150, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.3);
          }

          .elite .booster-badge {
            background: rgba(120, 100, 0, 0.4);
            border: 1px solid rgba(255, 215, 0, 0.6);
            color: #FFD700;
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
          }

          .booster-details {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
          }

          .booster-description {
            font-size: 0.85rem;
            margin-bottom: 12px;
            line-height: 1.4;
          }

          .booster-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            margin-bottom: 12px;
          }

          .booster-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
          }

          .booster-stat-value {
            font-weight: 700;
            font-size: 1.1rem;
          }

          .booster-stat-label {
            font-size: 0.7rem;
            opacity: 0.8;
          }

          .booster-button {
            width: 100%;
            padding: 8px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
          }

          .basic .booster-button {
            background: rgba(255, 255, 255, 0.2);
            color: white;
          }

          .basic .booster-button:hover {
            background: rgba(255, 255, 255, 0.3);
          }

          .pro .booster-button {
            background: rgba(255, 255, 255, 0.25);
            color: white;
          }

          .pro .booster-button:hover {
            background: rgba(255, 255, 255, 0.35);
          }

          .elite .booster-button {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.7) 0%, rgba(212, 175, 55, 0.7) 100%);
            color: #111;
            font-weight: 700;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
          }

          .elite .booster-button:hover {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.9) 0%, rgba(212, 175, 55, 0.9) 100%);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
          }

          .booster-icon {
            margin-right: 6px;
            font-size: 1rem;
          }

          .booster-back p {
            margin: 5px 0;
            font-size: 0.9rem;
            text-align: center;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
          }

          .booster-grid {
            display: grid;
            grid-template-columns: repeat(3, 280px);
            gap: 20px;
            justify-content: center;
            overflow-x: auto;
          }

          .crystal-card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
          }

          .crystal-card:hover {
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
          }

          .mining-active {
            animation: pulse 2s infinite;
          }

          @keyframes pulse {
            0% {
              box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.4);
            }
            70% {
              box-shadow: 0 0 0 10px rgba(255, 215, 0, 0);
            }
            100% {
              box-shadow: 0 0 0 0 rgba(255, 215, 0, 0);
            }
          }

          .text-gold-600 {
            color: #D4AF37;
          }
        `}
      </style>

      {error && (
        <div className="bg-red-100 dark:bg-red-900 border border-red-400 dark:border-red-700 text-red-700 dark:text-red-100 px-4 py-3 rounded mb-4">
          {error}
        </div>
      )}

      <h1 className="text-2xl font-bold text-gray-900 dark:text-white mb-6">Dashboard</h1>

      {/* Wallet Balance Card */}
      <div className="crystal-card">
  <h2 className="text-lg font-semibold text-gray-800 dark:text-white mb-4">Saldo Wallet</h2>
  <div className="flex items-end">
    <p className="text-3xl font-bold text-gold-600">
      {(wallet.balance + miningState.btcMined).toFixed(8)}
    </p>
    <span className="ml-2 text-xl text-gray-500 dark:text-gray-400">₿Ǥɱ</span>
  </div>
  <p className="text-sm text-gray-500 dark:text-gray-400 mt-2">
    ≈ ${((wallet.balance + miningState.btcMined) * 50000).toFixed(2)} ₿Ǥɱ (Poin)
  </p>
</div>

      {/* Mining Boosters Section */}
<div className="crystal-card">
  <h2 className="text-lg font-semibold text-gray-800 dark:text-white mb-4">Mining Boosters</h2>
  {/* Tambahkan wrapper overflow-x-auto agar scroll horizontal di mobile */}
  <div className="overflow-x-auto -mx-4 md:mx-0">
    <div
      className="booster-grid px-4 md:px-0"
      style={{
        minWidth: 840, // 3 * 280px, atau lebih jika item lebih banyak
        width: 'max-content',
      }}
    >
      {items.length === 0 ? (
        <p className="text-gray-500 col-span-3 text-center">Tidak ada booster tersedia.</p>
      ) : (
        items.map((item) => (
          <div
            key={item.id}
            className={`booster-card-wrapper booster-card ${item.level?.toLowerCase() || 'basic'} ${
              flipStates[item.id] ? 'touched' : ''
            }`}
            onTouchStart={() => handleTouchStart(item.id)}
          >
            <div className="booster-front">
              <div className="booster-content">
                <div className="booster-header">
                  <div className="booster-title">{item.name}</div>
                  <div className="booster-badge">{item.level}</div>
                </div>
                <div className="booster-details">
                  <div className="booster-description">
                    Boost mining Anda dengan {item.name} yang kuat!
                  </div>
                  <div className="booster-stats">
                    <div className="booster-stat">
                      <span className="booster-stat-value">{item.boost}x</span>
                      <span className="booster-stat-label">Boost</span>
                    </div>
                    <div className="booster-stat">
                      <span className="booster-stat-value">{item.price} ETH</span>
                      <span className="booster-stat-label">Harga</span>
                    </div>
                    <div className="booster-stat">
                      <span className="booster-stat-value">{item.duration / 86400000}</span>
                      <span className="booster-stat-label">Hari</span>
                    </div>
                  </div>
                </div>
                <button
                  onClick={() => purchaseItem(item)}
                  disabled={isLoading}
                  className="booster-button"
                >
                  <i className="bi bi-lightning-charge-fill booster-icon"></i>
                  {isLoading ? 'Memproses...' : 'Beli Sekarang'}
                </button>
              </div>
            </div>
            <div className="booster-back">
              <p>Boost: {item.boost}x</p>
              <p>Harga: {item.price} ETH</p>
              <p>Durasi: {item.duration / 86400000} hari</p>
              <button
                onClick={() => purchaseItem(item)}
                disabled={isLoading}
                className="booster-button"
              >
                {isLoading ? 'Memproses...' : 'Buy'}
              </button>
            </div>
          </div>
        ))
      )}
    </div>
  </div>
</div>

      {/* Daily Mining Chart */}
      <div className="crystal-card">
        <h2 className="text-lg font-semibold text-gray-800 dark:text-white mb-4">Mining Harian (7 Hari Terakhir)</h2>
        <canvas id="miningChart" className="w-full h-64"></canvas>
      </div>

     {/* Mining Stats Grid */}
<div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
  {/* Mining Status Card */}
  <div
    className={`crystal-card transition-all duration-300 ${
      miningState.status === 'mining' ? 'mining-active border-2 border-gold-500' : ''
    }`}
  >
    <div className="flex items-center justify-between mb-4">
      <h2 className="text-lg font-semibold text-gray-800 dark:text-white">Status Mining</h2>
      <span
        className={`px-2 py-1 rounded-full text-xs font-medium ${
          miningState.status === 'mining'
            ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200'
            : 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'
        }`}
      >
        {miningState.status === 'mining' ? 'AKTIF' : 'BERHENTI'}
      </span>
    </div>
    <div className="space-y-4">
      <div>
        <p className="text-sm text-gray-500 dark:text-gray-400">Hash Rate</p>
        <p className="text-2xl font-bold text-gray-900 dark:text-white">
          {miningState.hashRate.toFixed(1)} <span className="text-sm font-normal">H/s</span>
        </p>
      </div>
      <div>
        <p className="text-sm text-gray-500 dark:text-gray-400">Kecepatan Jaringan</p>
        <p className="text-2xl font-bold text-gray-900 dark:text-white">
          {miningState.networkSpeed.toFixed(2)} <span className="text-sm font-normal">Mbps</span>
        </p>
      </div>
      {/* Booster Aktif */}
      {(() => {
        // Cari booster aktif dengan boost terbesar
        const now = new Date().toISOString();
        let activeBooster = null;
        userItems.forEach((purchase) => {
          const item = items.find((i) => i.id === purchase.item_id);
          if (
            item &&
            purchase.expires_at > now &&
            (!activeBooster || item.boost > activeBooster.boost)
          ) {
            activeBooster = { ...item, expires_at: purchase.expires_at };
          }
        });
        if (activeBooster) {
          return (
            <div className="mt-2">
              <span className="inline-block px-3 py-1 rounded-full bg-green-200 text-green-800 font-semibold text-xs mr-2">
                Paket Aktif: {activeBooster.level || (activeBooster.boost === 1.5 ? 'Basic' : activeBooster.boost === 3 ? 'Pro' : activeBooster.boost === 5 ? 'Elite' : '')} ({activeBooster.boost}x Boost)
              </span>
              <span className="inline-block text-xs text-gray-500">
                Exp: {formatTime(activeBooster.expires_at)}
              </span>
            </div>
          );
        }
        return null;
      })()}
    </div>
  </div>

        {/* BTC Mined Card */}
        <div className="crystal-card">
          <h2 className="text-lg font-semibold text-gray-800 dark:text-white mb-4">₿Ǥɱ Ditambang</h2>
          <div className="flex items-end">
            <p className="text-3xl font-bold text-gold-600">{miningState.btcMined.toFixed(8)}</p>
            <span className="ml-2 text-xl text-gray-500 dark:text-gray-400">₿Ǥɱ</span>
          </div>
          <p className="text-sm text-gray-500 dark:text-gray-400 mt-2">
            ≈ ${(miningState.btcMined * 50000).toFixed(2)} ₿Ǥɱ (Poin)
          </p>
        </div>

        {/* Mining Controls Card */}
        <div className="crystal-card">
          <h2 className="text-lg font-semibold text-gray-800 dark:text-white mb-4">Kontrol Mining</h2>
          <div className="space-y-4">
            {miningState.status === 'stopped' ? (
              <button
                onClick={startMining}
                disabled={isLoading}
                className="w-full bg-gold-600 hover:bg-gold-700 text-white py-3 px-4 rounded-md font-medium flex items-center justify-center transition-colors duration-300"
              >
                {isLoading ? (
                  <span className="flex items-center">
                    <i className="bi bi-arrow-repeat animate-spin mr-2"></i>
                    Memulai...
                  </span>
                ) : (
                  <span className="flex items-center">
                    <i className="bi bi-play-fill mr-2"></i>
                    Mulai Mining
                  </span>
                )}
              </button>
            ) : (
              <button
                onClick={stopMining}
                disabled={isLoading}
                className="w-full bg-red-600 hover:bg-red-700 text-white py-3 px-4 rounded-md font-medium flex items-center justify-center transition-colors duration-300"
              >
                {isLoading ? (
                  <span className="flex items-center">
                    <i className="bi bi-arrow-repeat animate-spin mr-2"></i>
                    Menghentikan...
                  </span>
                ) : (
                  <span className="flex items-center">
                    <i className="bi bi-stop-fill mr-2"></i>
                    Hentikan Mining
                  </span>
                )}
              </button>
            )}
            <div className="text-center text-sm text-gray-500 dark:text-gray-400">
              {miningState.status === 'mining' ? (
                <p>
                  Mining sedang berlangsung... <i className="bi bi-lightning-charge-fill text-gold-500"></i>
                </p>
              ) : (
                <p>Siap untuk memulai mining</p>
              )}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};


function ProfilePage({ profile, setProfile, userId, fetchUserProfile, t }) {
                      const [isEditing, setIsEditing] = React.useState(false);
                      const [formData, setFormData] = React.useState({
                        full_name: profile.full_name || '',
                        phone_number: profile.phone_number || '',
                        profile_photo: null,
                      });
                      const [previewUrl, setPreviewUrl] = React.useState(null);
                      const [error, setError] = React.useState('');
                      const [success, setSuccess] = React.useState('');
                      const [isLoading, setIsLoading] = React.useState(false);
                      const fileInputRef = React.useRef(null);
                    
                      React.useEffect(() => {
                        console.log('ProfilePage: userId:', userId);
                        setFormData({
                          full_name: profile.full_name || '',
                          phone_number: profile.phone_number || '',
                          profile_photo: null,
                        });
                        setPreviewUrl(null);
                      }, [profile, userId]);
                    
                      const handleInputChange = (e) => {
                        const { name, value } = e.target;
                        setFormData((prev) => ({
                          ...prev,
                          [name]: value,
                        }));
                      };
                    
                      const handleFileChange = (e) => {
                        const file = e.target.files[0];
                        if (file) {
                          if (file.size > 5 * 1024 * 1024) {
                            setError(t('fileTooLarge'));
                            return;
                          }
                          setFormData((prev) => ({
                            ...prev,
                            profile_photo: file,
                          }));
                          setPreviewUrl(URL.createObjectURL(file));
                        }
                      };
                    
                      const handleSaveProfile = async () => {
                        setIsLoading(true);
                        setError('');
                        setSuccess('');
                    
                        try {
                          if (!userId) {
                            throw new Error('ID pengguna tidak didefinisikan');
                          }
                    
                          const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
                          if (!uuidRegex.test(userId)) {
                            throw new Error('Format userId tidak valid');
                          }
                    
                          const { data: { user } } = await supabase.auth.getUser();
                          console.log('ID pengguna terautentikasi:', user?.id, 'userId yang diberikan:', userId);
                          if (!user || user.id !== userId) {
                            throw new Error('Tidak diizinkan: ID pengguna tidak cocok');
                          }
                    
                          let profilePhotoUrl = profile.profile_photo_url;
                    
                          if (formData.profile_photo) {
                            const fileExt = formData.profile_photo.name.split('.').pop();
                            const fileName = `${userId}_${Date.now()}.${fileExt}`;
                            const { error: uploadError } = await supabase.storage
                              .from('profile_photos')
                              .upload(fileName, formData.profile_photo);
                    
                            if (uploadError) {
                              console.error('Error unggah:', uploadError);
                              throw new Error(`Gagal mengunggah foto profil: ${uploadError.message}`);
                            }
                    
                            const { data: urlData } = supabase.storage
                              .from('profile_photos')
                              .getPublicUrl(fileName);
                    
                            if (!urlData?.publicUrl) {
                              throw new Error('Gagal mendapatkan URL publik untuk foto profil');
                            }
                            profilePhotoUrl = urlData.publicUrl;
                    
                            if (profile.profile_photo) {
                              const oldFileName = profile.profile_photo.split('/').pop();
                              await supabase.storage.from('profile_photos').remove([oldFileName]);
                            }
                          }
                    
                          console.log('Memperbarui profil untuk userId:', userId);
                          console.log('Data yang dikirim:', {
                            full_name: formData.full_name,
                            phone_number: formData.phone_number,
                            profile_photo: profilePhotoUrl,
                            updated_at: new Date().toISOString(),
                          });
                    
                         // ...existing code...
                    const { error: updateError } = await supabase
                      .from('profiles')
                      .update({
                        full_name: formData.full_name,
                        phone_number: formData.phone_number,
                        profile_photo: profilePhotoUrl,
                        updated_at: new Date().toISOString(),
                      })
                      .eq('id', userId); // Ganti 'user_id' menjadi 'id'
                    // ...existing code...
                    
                          if (updateError) {
                            console.error('Error pembaruan:', updateError);
                            throw new Error(`Gagal memperbarui profil: ${updateError.message}`);
                          }
                    
                          setProfile({
                            ...profile,
                            full_name: formData.full_name,
                            phone_number: formData.phone_number,
                            profile_photo: profilePhotoUrl,
                          });
                          await fetchUserProfile(userId);
                          setSuccess(t('profileUpdated'));
                          setIsEditing(false);
                          setPreviewUrl(null);
                        } catch (err) {
                          console.error('handleSaveProfile: Error:', err);
                          setError(err.message);
                        } finally {
                          setIsLoading(false);
                        }
                      };
                    
                      const handleEditToggle = () => {
                        setIsEditing(!isEditing);
                        setError('');
                        setSuccess('');
                        setPreviewUrl(null);
                        if (!isEditing) {
                          setFormData({
                            full_name: profile.full_name || '',
                            phone_number: profile.phone_number || '',
                            profile_photo: null,
                          });
                        }
                      };
                      const [inviteCount, setInviteCount] = React.useState(0);

React.useEffect(() => {
  if (!userId) return;
  supabase
    .from('profiles')
    .select('id')
    .eq('referred_by', userId)
    .then(({ data }) => setInviteCount(data ? data.length : 0));
}, [userId]);
                    
                      return (
                        <div className="ml-0 md:ml-96 px-4 md:px-6 max-w-full md:max-w-[calc(100%-384px)]">
                          <h1 className="text-2xl font-bold text-gray-900 dark:text-white mb-6 section-title animate-slide-in gold-text-gradient">
                            {t('profile')}
                          </h1>
                          {error && (
  <div
    className="flex items-center bg-red-50 dark:bg-red-800/80 border border-red-200 dark:border-red-700 text-red-600 dark:text-red-100 px-3 py-2 rounded-md mb-3 text-xs shadow-sm animate-fade-in transition-all duration-300"
    style={{ minHeight: 0, maxWidth: 320 }}
  >
    <span className="flex-1 break-words">{error}</span>
    <button
      onClick={() => setError('')}
      className="ml-2 text-red-400 hover:text-red-700 dark:hover:text-white transition-colors duration-200 text-base"
      aria-label="Close"
      type="button"
      style={{ lineHeight: 1 }}
    >
      <i className="bi bi-x"></i>
    </button>
  </div>
)}
{success && (
  <div
    className="flex items-center bg-green-50 dark:bg-green-800/80 border border-green-200 dark:border-green-700 text-green-600 dark:text-green-100 px-3 py-2 rounded-md mb-3 text-xs shadow-sm animate-fade-in transition-all duration-300"
    style={{ minHeight: 0, maxWidth: 320 }}
  >
    <span className="flex-1 break-words">{success}</span>
    <button
      onClick={() => setSuccess('')}
      className="ml-2 text-green-400 hover:text-green-700 dark:hover:text-white transition-colors duration-200 text-base"
      aria-label="Close"
      type="button"
      style={{ lineHeight: 1 }}
    >
      <i className="bi bi-x"></i>
    </button>
  </div>
)}
                          <div className="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 crystal-card animate-slide-in overflow-y-auto pb-16">
                            <div className="flex flex-col md:flex-row items-center md:items-start space-y-6 md:space-y-0 md:space-x-8">
                              <div className="relative flex flex-col items-center">
                                <div className="relative">
                                  
                    <img
                      src={profile.profile_photo_url || 'https://ui-avatars.com/api/?name=User&background=gold&color=fff'}
                      alt="Profile"
                      className="w-32 h-32 rounded-full object-cover border-2 border-gold-500 transition-transform duration-300 hover:scale-105"
                    />
                                  {isLoading && (
                                    <div className="absolute inset-0 flex items-center justify-center bg-black bg-opacity-50 rounded-full">
                                      <div className="w-8 h-8 border-4 border-t-gold-500 border-gray-200 rounded-full animate-spin"></div>
                                    </div>
                                  )}
                                  {isEditing && (
                                    <button
                                      onClick={() => fileInputRef.current.click()}
                                      className="absolute bottom-0 right-0 bg-gold-600 text-white p-2 rounded-full hover:bg-gold-700 transition-colors duration-200"
                                      disabled={isLoading}
                                    >
                                      <i className="bi bi-camera"></i>
                                    </button>
                                  )}
                                </div>
                                {previewUrl && (
                                  <div className="mt-4">
                                    <p className="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2 break-words">{t('preview')}</p>
                                    <img
                                      src={previewUrl}
                                      alt="Preview"
                                      className="w-24 h-24 rounded-full object-cover border-2 border-gold-300 animate-fade-in"
                                    />
                                  </div>
                                )}
                                <input
                                  type="file"
                                  accept="image/*"
                                  ref={fileInputRef}
                                  onChange={handleFileChange}
                                  className="hidden"
                                />
                              </div>
                              <div className="flex-1 w-full">
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                  <div className="relative group">
                                    <label className="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1 transition-colors duration-200 group-hover:text-gold-500 break-words">
                                      <i className="bi bi-person mr-2"></i>
                                      {t('fullName')}
                                    </label>
                                    {isEditing ? (
                                      <input
                                        type="text"
                                        name="full_name"
                                        value={formData.full_name}
                                        onChange={handleInputChange}
                                        className="block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-gold-500 focus:ring focus:ring-gold-500 focus:ring-opacity-50 transition-all duration-200 max-w-full"
                                        placeholder={t('enterFullName')}
                                      />
                                    ) : (
                                      <p className="text-gray-900 dark:text-white py-2 border-b border-gray-200 dark:border-gray-600 break-words">
                                        {profile.full_name || t('notSet')}
                                      </p>
                                    )}
                                  </div>
                                  <div className="relative group">
                                    <label className="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1 transition-colors duration-200 group-hover:text-gold-500 break-words">
                                      <i className="bi bi-phone mr-2"></i>
                                      {t('phoneNumber')}
                                    </label>
                                    {isEditing ? (
                                      <input
                                        type="tel"
                                        name="phone_number"
                                        value={formData.phone_number}
                                        onChange={handleInputChange}
                                        className="block w-full rounded-md border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white shadow-sm focus:border-gold-500 focus:ring focus:ring-gold-500 focus:ring-opacity-50 transition-all duration-200 max-w-full"
                                        placeholder={t('enterPhoneNumber')}
                                      />
                                    ) : (
                                      <p className="text-gray-900 dark:text-white py-2 border-b border-gray-200 dark:border-gray-600 break-words">
                                        {profile.phone_number || t('notSet')}
                                      </p>
                                    )}
                                  </div>
                                  <div className="relative group">
                                    <label className="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1 transition-colors duration-200 group-hover:text-gold-500 break-words">
                                      <i className="bi bi-envelope mr-2"></i>
                                      {t('email')}
                                    </label>
                                    <p className="text-gray-900 dark:text-white py-2 border-b border-gray-200 dark:border-gray-600 break-words">
                                      {profile.email || t('notSet')}
                                    </p>
                                  </div>
                                  <div className="relative group">
                                    <label className="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1 transition-colors duration-200 group-hover:text-gold-500 break-words">
                                      <i className="bi bi-tag mr-2"></i>
                                      {t('referralCode')}
                                    </label>
                                    <p className="text-gray-900 dark:text-white py-2 border-b border-gray-200 dark:border-gray-600 break-words">
                                      {profile.referral_code || t('notSet')}
                                    </p>
                                  </div>
                                </div>
                                <div className="relative group">
  <label className="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-1">
    <i className="bi bi-people-fill mr-2"></i>
    Jumlah Invite
  </label>
  <p className="text-gray-900 dark:text-white py-2 border-b border-gray-200 dark:border-gray-600 break-words">
    {inviteCount}
  </p>
</div>
                                <div className="mt-6 flex flex-wrap gap-4">
                                  {isEditing ? (
                                    <>
                                      <button
                                        onClick={handleSaveProfile}
                                        disabled={isLoading}
                                        className="bg-gold-600 hover:bg-gold-700 text-white py-2 px-4 rounded-md font-medium flex items-center transition-colors duration-300 disabled:opacity-50"
                                      >
                                        {isLoading ? (
                                          <span className="flex items-center">
                                            <i className="bi bi-arrow-repeat animate-spin mr-2"></i>
                                            {t('saving')}
                                          </span>
                                        ) : (
                                          <span className="flex items-center">
                                            <i className="bi bi-save mr-2"></i>
                                            {t('save')}
                                          </span>
                                        )}
                                      </button>
                                      <button
                                        onClick={handleEditToggle}
                                        className="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-md font-medium flex items-center transition-colors duration-300"
                                        disabled={isLoading}
                                      >
                                        <i className="bi bi-x mr-2"></i>
                                        {t('cancel')}
                                      </button>
                                    </>
                                  ) : (
                                    <button
                                      onClick={handleEditToggle}
                                      className="bg-gold-600 hover:bg-gold-700 text-white py-2 px-4 rounded-md font-medium flex items-center transition-colors duration-300"
                                    >
                                      <i className="bi bi-pencil mr-2"></i>
                                      {t('editProfile')}
                                    </button>
                                  )}
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      );
                    }
                    
                    function WalletPage({ user, t }) {
                      // State untuk manajemen wallet
                      const [wallet, setWallet] = React.useState({ 
                        balance: 0, 
                        transactions: [], 
                        wallet_address: null 
                      });
                      const [isLoading, setIsLoading] = React.useState(true);
                      const [isConnecting, setIsConnecting] = React.useState(false);
                      const [error, setError] = React.useState('');
                      const [walletStatus, setWalletStatus] = React.useState('');
                      const [walletConnections, setWalletConnections] = React.useState([]);
                      const [showConnections, setShowConnections] = React.useState(false);
                      const [isWalletConnectionEnabled, setIsWalletConnectionEnabled] = React.useState(true);
                      const [showWalletOptions, setShowWalletOptions] = React.useState(false);
                      const [currentPage, setCurrentPage] = React.useState(1);
                      const transactionsPerPage = 5;
                    
                      // State untuk deteksi wallet yang terinstall
                      const [detectedWallets, setDetectedWallets] = React.useState({
                        metamask: false,
                        okx: false,
                        phantom: false
                      });
                    
                      // Fungsi untuk memeriksa wallet yang terinstall
                      const checkInstalledWallets = () => {
                        setDetectedWallets({
                          metamask: !!window.ethereum?.isMetaMask,
                          okx: !!window.okxwallet,
                          phantom: !!window.solana?.isPhantom
                        });
                      };
                    
                      // Cek wallet yang terinstall saat komponen pertama kali render
                      React.useEffect(() => {
                        checkInstalledWallets();
                        
                        // Cek secara berkala untuk perubahan
                        const interval = setInterval(checkInstalledWallets, 3000);
                        return () => clearInterval(interval);
                      }, []);
                    
                      // Fungsi untuk mengambil data wallet dari database
                      const fetchWalletData = async () => {
                        setIsLoading(true);
                        try {
                          // Ambil data wallet
                          const { data: walletData, error: walletError } = await supabase
                            .from('wallet')
                            .select('balance, wallet_address')
                            .eq('user_id', user.id)
                            .single();
                    
                          if (walletError) throw walletError;
                    
                          // Ambil data transaksi
                          const { data: transactionData, error: transactionError } = await supabase
                            .from('transactions')
                            .select('*')
                            .eq('user_id', user.id)
                            .order('created_at', { ascending: false })
                            .limit(10);
                    
                          if (transactionError) throw transactionError;
                    
                          // Ambil data koneksi wallet
                          const { data: connectionsData, error: connectionsError } = await supabase
                            .from('wallet_connections')
                            .select('wallet_address, connected_at')
                            .eq('user_id', user.id)
                            .order('connected_at', { ascending: false });
                    
                          if (connectionsError) throw connectionsError;
                    
                          // Update state dengan data yang didapat
                          setWallet({
                            balance: walletData?.balance || 0,
                            wallet_address: walletData?.wallet_address || null,
                            transactions: transactionData || [],
                          });
                    
                          setWalletConnections(connectionsData || []);
                    
                          // Set status wallet jika ada
                          if (walletData?.wallet_address) {
                            setWalletStatus(
                              `${t('Addreas')}: ${walletData.wallet_address.slice(0, 6)}...${walletData.wallet_address.slice(-4)}`
                            );
                          }
                        } catch (err) {
                          console.error('Gagal mengambil data wallet:', err);
                          setError(`Gagal memuat wallet: ${err.message}`);
                        } finally {
                          setIsLoading(false);
                        }
                      };
                    
                      // Panggil fungsi fetch data saat komponen pertama render
                      React.useEffect(() => {
                        fetchWalletData();
                      }, [user.id, t]);
                    
                      // Fungsi untuk menghubungkan ke MetaMask
                      const connectMetaMask = async () => {
                        try {
                          if (!window.ethereum) {
                            throw new Error('MetaMask tidak ditemukan!');
                          }
                          
                          // Minta akses ke akun
                          const accounts = await window.ethereum.request({ 
                            method: 'eth_requestAccounts' 
                          });
                          
                          if (!accounts || accounts.length === 0) {
                            throw new Error('Tidak ada akun yang ditemukan di MetaMask');
                          }
                          
                          // Dapatkan chain ID
                          const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                          console.log('Terhubung ke chain:', chainId);
                          
                          // Handle perubahan chain
                          window.ethereum.on('chainChanged', (newChainId) => {
                            console.log('Chain berubah:', newChainId);
                            window.location.reload();
                          });
                          
                          // Handle perubahan akun
                          window.ethereum.on('accountsChanged', (newAccounts) => {
                            console.log('Akun berubah:', newAccounts);
                            if (newAccounts.length === 0) {
                              console.log('Wallet terputus');
                              disconnectWallet();
                            } else {
                              connectWallet('metamask');
                            }
                          });
                    
                          return accounts[0];
                        } catch (error) {
                          console.error('Error saat menghubungkan MetaMask:', error);
                          throw new Error(error.message);
                        }
                      };
                    
                      // Fungsi untuk menghubungkan ke Phantom Wallet
                      const connectPhantom = async () => {
                        try {
                          if (!window.solana) {
                            throw new Error('Phantom wallet tidak ditemukan!');
                          }
                          
                          if (window.solana.isPhantom) {
                            const response = await window.solana.connect();
                            const publicKey = response.publicKey.toString();
                            
                            if (!publicKey) {
                              throw new Error('Tidak menemukan public key di Phantom');
                            }
                            
                            // Handle perubahan akun
                            window.solana.on('accountChanged', (newPublicKey) => {
                              console.log('Akun berubah:', newPublicKey?.toString());
                              if (newPublicKey) {
                                connectWallet('phantom');
                              } else {
                                disconnectWallet();
                              }
                            });
                            
                            // Handle disconnect
                            window.solana.on('disconnect', () => {
                              console.log('Wallet terputus');
                              disconnectWallet();
                            });
                    
                            return publicKey;
                          } else {
                            throw new Error('Phantom wallet tidak terdeteksi!');
                          }
                        } catch (error) {
                          console.error('Error saat menghubungkan Phantom:', error);
                          throw new Error(error.message);
                        }
                      };
                    
                      // Fungsi untuk menghubungkan ke OKX Wallet
                      const connectOKX = async () => {
                        try {
                          if (!window.okxwallet) {
                            throw new Error('OKX Wallet tidak ditemukan!');
                          }
                          
                          // Minta akses ke akun
                          const accounts = await window.okxwallet.request({ 
                            method: 'eth_requestAccounts' 
                          });
                          
                          if (!accounts || accounts.length === 0) {
                            throw new Error('Tidak ada akun yang ditemukan di OKX Wallet');
                          }
                          
                          // Dapatkan chain ID
                          const chainId = await window.okxwallet.request({ method: 'eth_chainId' });
                          console.log('Terhubung ke chain:', chainId);
                          
                          // Handle perubahan chain
                          window.okxwallet.on('chainChanged', (newChainId) => {
                            console.log('Chain berubah:', newChainId);
                            window.location.reload();
                          });
                          
                          // Handle perubahan akun
                          window.okxwallet.on('accountsChanged', (newAccounts) => {
                            console.log('Akun berubah:', newAccounts);
                            if (newAccounts.length === 0) {
                              console.log('Wallet terputus');
                              disconnectWallet();
                            } else {
                              connectWallet('okx');
                            }
                          });
                    
                          return accounts[0];
                        } catch (error) {
                          console.error('Error saat menghubungkan OKX:', error);
                          throw new Error(error.message);
                        }
                      };
                    
                      // Fungsi utama untuk menghubungkan wallet
                      const connectWallet = async (walletType) => {
                        if (!isWalletConnectionEnabled) {
                          setError('Koneksi wallet dinonaktifkan. Aktifkan untuk menghubungkan.');
                          return;
                        }
                    
                        setIsConnecting(true);
                        setError('');
                        setWalletStatus('');
                        setShowWalletOptions(false);
                    
                        try {
                          console.log('Mencoba menghubungkan dengan:', walletType);
                    
                          let walletAddress;
                          if (walletType === 'metamask') {
                            walletAddress = await connectMetaMask();
                          } else if (walletType === 'phantom') {
                            walletAddress = await connectPhantom();
                          } else if (walletType === 'okx') {
                            walletAddress = await connectOKX();
                          } else {
                            throw new Error('Jenis wallet tidak valid');
                          }
                    
                          // Cek apakah wallet sudah digunakan oleh user lain
                          const { data: existingWallet, error: checkError } = await supabase
                            .from('wallet')
                            .select('user_id')
                            .eq('wallet_address', walletAddress)
                            .neq('user_id', user.id)
                            .single();
                    
                          if (checkError && checkError.code !== 'PGRST116') {
                            throw new Error(`Gagal memverifikasi alamat wallet: ${checkError.message}`);
                          }
                    
                          if (existingWallet) {
                            throw new Error('Alamat wallet ini sudah digunakan oleh user lain');
                          }
                    
                          // Simpan alamat wallet ke database
                          const { error: updateError } = await supabase
                            .from('wallet')
                            .update({ wallet_address: walletAddress })
                            .eq('user_id', user.id);
                    
                          if (updateError) {
                            throw new Error(`Gagal menyimpan alamat wallet: ${updateError.message}`);
                          }
                    
                          // Simpan ke tabel koneksi wallet
                          const { error: connectionError } = await supabase
                            .from('wallet_connections')
                            .insert({ user_id: user.id, wallet_address: walletAddress });
                    
                          if (connectionError) {
                            throw new Error(`Gagal menyimpan koneksi wallet: ${connectionError.message}`);
                          }
                    
                          // Update state
                          setWallet(prev => ({
                            ...prev,
                            wallet_address: walletAddress,
                          }));
                    
                          setWalletConnections(prev => [
                            { wallet_address: walletAddress, connected_at: new Date().toISOString() },
                            ...prev,
                          ]);
                    
                          setWalletStatus(`Wallet terhubung: ${walletAddress.slice(0, 6)}...${walletAddress.slice(-4)}`);
                        } catch (error) {
                          console.error('Error saat menghubungkan wallet:', error);
                          setError(error.message);
                          setWalletStatus('');
                        } finally {
                          setIsConnecting(false);
                        }
                      };
                    
                      // Fungsi untuk memutuskan wallet
                      const disconnectWallet = async () => {
                        setIsConnecting(true);
                        setError('');
                        setWalletStatus('');
                    
                        try {
                          const { error: updateError } = await supabase
                            .from('wallet')
                            .update({ wallet_address: null })
                            .eq('user_id', user.id);
                    
                          if (updateError) {
                            throw new Error(`Gagal memutuskan wallet: ${updateError.message}`);
                          }
                    
                          setWallet(prev => ({
                            ...prev,
                            wallet_address: null,
                          }));
                          setWalletStatus('');
                        } catch (error) {
                          console.error('Error saat memutuskan wallet:', error);
                          setError(error.message);
                        } finally {
                          setIsConnecting(false);
                        }
                      };
                    
                      // Fungsi untuk toggle koneksi wallet
                      const handleWalletAction = () => {
                        if (wallet.wallet_address) {
                          disconnectWallet();
                        } else {
                          setShowWalletOptions(true);
                        }
                      };
                    
                      // Fungsi untuk format waktu
                      const formatTime = (dateString) => {
                        return new Date(dateString).toLocaleString();
                      };
                    
                      // Logika pagination
                      const indexOfLastTransaction = currentPage * transactionsPerPage;
                      const indexOfFirstTransaction = indexOfLastTransaction - transactionsPerPage;
                      const currentTransactions = wallet.transactions.slice(indexOfFirstTransaction, indexOfLastTransaction);
                      const totalPages = Math.ceil(wallet.transactions.length / transactionsPerPage);
                    
                      const handlePageChange = (pageNumber) => {
                        setCurrentPage(pageNumber);
                      };
                    
                      // Render UI
                      return (
                        <div className="ml-0 md:ml-96 px-4 md:px-6 max-w-full md:max-w-[calc(100%-384px)]">
                          <h1 className="text-2xl font-bold text-gray-900 dark:text-white mb-6 section-title animate-slide-in gold-text-gradient">
                            {t('wallet')}
                          </h1>
                          
                          {/* Tampilkan error jika ada */}
                          {error && (
  <div
    className="flex items-center bg-red-50 dark:bg-red-800/80 border border-red-200 dark:border-red-700 text-red-600 dark:text-red-100 px-3 py-2 rounded-md mb-3 text-xs shadow-sm animate-fade-in transition-all duration-300"
    style={{ minHeight: 0, maxWidth: 320 }}
  >
    <span className="flex-1 break-words">{error}</span>
    <button
      onClick={() => setError('')}
      className="ml-2 text-red-400 hover:text-red-700 dark:hover:text-white transition-colors duration-200 text-base"
      aria-label="Close"
      type="button"
      style={{ lineHeight: 1 }}
    >
      <i className="bi bi-x"></i>
    </button>
  </div>
)}
                          
                          {/* Tampilkan status wallet */}
                          {walletStatus && (
                            <div className="bg-green-100 dark:bg-green-900 border border-green-400 dark:border-green-700 text-green-700 dark:text-green-100 px-4 py-3 rounded mb-4 animate-slide-in">
                              {walletStatus}
                            </div>
                          )}
                    
                          <div className="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 crystal-card animate-slide-in">
                            {/* Tombol-tombol aksi wallet */}
                            <div className="mb-6 flex items-center space-x-4">
                              <label className="flex items-center space-x-2">
                                <span className="text-gray-800 dark:text-white"></span>
                                <input
                                  type="checkbox"
                                  checked={isWalletConnectionEnabled}
                                  onChange={() => setIsWalletConnectionEnabled(!isWalletConnectionEnabled)}
                                  className="hidden"
                                />
                                <div className={`w-10 h-5 rounded-full transition-colors duration-300 ${isWalletConnectionEnabled ? 'bg-gold-600' : 'bg-gray-400'}`}>
                                  <div
                                    className={`w-5 h-5 bg-white rounded-full shadow-md transform transition-transform duration-300 ${
                                      isWalletConnectionEnabled ? 'translate-x-5' : 'translate-x-0'
                                    }`}
                                  />
                                </div>
                              </label>
                    
                              <button
                                onClick={handleWalletAction}
                                disabled={isConnecting || !isWalletConnectionEnabled}
                                className={`py-2 px-4 rounded-md font-medium flex items-center transition-colors duration-300 ${
                                  wallet.wallet_address
                                    ? 'bg-red-600 hover:bg-red-700 text-white'
                                    : 'bg-gradient-to-r from-gold-600 to-gold-700 hover:from-gold-700 hover:to-gold-800 text-white'
                                } ${isConnecting || !isWalletConnectionEnabled ? 'opacity-50 cursor-not-allowed' : ''}`}
                              >
                                {isConnecting ? (
                                  <span className="flex items-center">
                                    <i className="bi bi-arrow-repeat animate-spin mr-2"></i>
                                    Memproses...
                                  </span>
                                ) : wallet.wallet_address ? (
                                  <span className="flex items-center">
                                    <i className="bi bi-x-circle mr-2"></i>
                                    Putuskan
                                  </span>
                                ) : (
                                  <span className="flex items-center">
                                    <i className="bi bi-wallet mr-2"></i>
                                    Hubungkan
                                  </span>
                                )}
                              </button>
                    
                              <button
                                onClick={() => setShowConnections(true)}
                                className="bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white py-2 px-4 rounded-md font-medium flex items-center transition-colors duration-300 hover:bg-gray-300 dark:hover:bg-gray-600"
                              >
                                <i className="bi bi-list mr-2"></i>
                                
                              </button>
                            </div>
                    
                            {/* Modal pilihan wallet */}
                            {showWalletOptions && (
                              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 animate-slide-in">
                                <div className="bg-white dark:bg-gray-800 rounded-xl p-6 max-w-sm w-full crystal-card">
                                  <h2 className="text-lg font-semibold text-gray-800 dark:text-white mb-4">Pilih Wallet</h2>
                                  <div className="space-y-4">
                                    {detectedWallets.metamask && (
                                      <button
                                        onClick={() => connectWallet('metamask')}
                                        className="w-full bg-gradient-to-r from-gold-600 to-gold-700 hover:from-gold-700 hover:to-gold-800 text-white py-2 px-4 rounded-md font-medium flex items-center justify-center space-x-2 transition-colors duration-300"
                                      >
                                        <img
                                          src="https://i.pinimg.com/736x/5c/87/06/5c870644ae73572b4b98a2cb1bac0a3b.jpg"
                                          alt="MetaMask"
                                          className="w-6 h-6"
                                          onError={(e) => (e.target.src = 'https://via.placeholder.com/24')}
                                        />
                                        <span>MetaMask</span>
                                      </button>
                                    )}
                                    {detectedWallets.phantom && (
                                      <button
                                        onClick={() => connectWallet('phantom')}
                                        className="w-full bg-gradient-to-r from-gold-600 to-gold-700 hover:from-gold-700 hover:to-gold-800 text-white py-2 px-4 rounded-md font-medium flex items-center justify-center space-x-2 transition-colors duration-300"
                                      >
                                        <img
                                          src="https://i.pinimg.com/736x/3c/52/25/3c522503ac51418684f1d217f13fb36d.jpg"
                                          alt="Phantom"
                                          className="w-6 h-6"
                                          onError={(e) => (e.target.src = 'https://via.placeholder.com/24')}
                                        />
                                        <span>Phantom</span>
                                      </button>
                                    )}
                                    {detectedWallets.okx && (
                                      <button
                                        onClick={() => connectWallet('okx')}
                                        className="w-full bg-gradient-to-r from-gold-600 to-gold-700 hover:from-gold-700 hover:to-gold-800 text-white py-2 px-4 rounded-md font-medium flex items-center justify-center space-x-2 transition-colors duration-300"
                                      >
                                        <img
                                          src="https://i.pinimg.com/474x/a4/d5/09/a4d509bafd18c2123c9e5362329a3d94.jpg"
                                          alt="OKX Wallet"
                                          className="w-6 h-6"
                                          onError={(e) => (e.target.src = 'https://via.placeholder.com/24')}
                                        />
                                        <span>OKX Wallet</span>
                                      </button>
                                    )}
                                    {!detectedWallets.metamask && !detectedWallets.phantom && !detectedWallets.okx && (
                                      <div className="text-center py-4 text-gray-500 dark:text-gray-400">
                                        <p>Tidak ada wallet yang terdeteksi. Silakan install wallet terlebih dahulu.</p>
                                        <div className="mt-2 space-x-2">
                                          <a href="https://metamask.io" target="_blank" rel="noopener noreferrer" className="text-blue-500 hover:underline">
                                            MetaMask
                                          </a>
                                          <a href="https://phantom.app" target="_blank" rel="noopener noreferrer" className="text-blue-500 hover:underline">
                                            Phantom
                                          </a>
                                          <a href="https://www.okx.com/web3" target="_blank" rel="noopener noreferrer" className="text-blue-500 hover:underline">
                                            OKX Wallet
                                          </a>
                                        </div>
                                      </div>
                                    )}
                                  </div>
                                  <button
                                    onClick={() => setShowWalletOptions(false)}>
                                    className="mt-4 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white py-2 px-4 rounded-md font-medium w-full"
                                  >
                                    Batal
                                  </button>
                                </div>
                              </div>
                            )}
                    
                            {/* Modal riwayat koneksi */}
                            {showConnections && (
                              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 animate-slide-in">
                                <div className="bg-white dark:bg-gray-800 rounded-xl p-6 max-w-md w-full crystal-card">
                                  <h2 className="text-lg font-semibold text-gray-800 dark:text-white mb-4">Wallet Terhubung</h2>
                                  {walletConnections.length === 0 ? (
                                    <p className="text-gray-500 dark:text-gray-400">Belum ada wallet yang terhubung</p>
                                  ) : (
                                    <div className="space-y-2 max-h-64 overflow-y-auto">
                                      {walletConnections.map((connection, index) => (
                                        <div
                                          key={index}
                                          className="p-3 bg-gray-50 dark:bg-gray-700 rounded-md flex justify-between items-center"
                                        >
                                          <span className="text-sm text-gray-800 dark:text-white">
                                            {connection.wallet_address.slice(0, 6)}...{connection.wallet_address.slice(-4)}
                                          </span>
                                          <span className="text-xs text-gray-500 dark:text-gray-400">
                                            {formatTime(connection.connected_at)}
                                          </span>
                                        </div>
                                      ))}
                                    </div>
                                  )}
                                  <button
                                    onClick={() => setShowConnections(false)}
                                    className="mt-4 bg-gold-600 hover:bg-gold-700 text-white py-2 px-4 rounded-md font-medium w-full"
                                  >
                                    Tutup
                                  </button>
                                </div>
                              </div>
                            )}
                    
                            {isLoading ? (
                            <div className="flex items-center justify-center py-6">
                              {/* Spinner dengan efek gradasi dan glow */}
                              <div className="relative w-12 h-12">
                                <div className="absolute inset-0 border-4 border-t-transparent border-gold-400 rounded-full animate-spin [animation-duration:1.2s] bg-gradient-to-r from-gold-300/30 to-transparent opacity-50 blur-sm"></div>
                                <div className="absolute inset-0 border-4 border-t-gold-500 border-gold-200/50 rounded-full animate-spin [animation-duration:1.2s]"></div>
                                {/* Inner glow untuk kesan premium */}
                                <div className="absolute inset-2 bg-gold-500/10 rounded-full animate-pulse"></div>
                              </div>
                              {/* Teks dengan efek pulsating */}
                              <span className="ml-4 text-lg font-light text-gray-700 dark:text-gray-200 animate-[pulse_2s_ease-in-out_infinite]">
                                
                              </span>
                            </div>
                            ) : (
                              <>
                                {/* Tampilkan saldo */}
                                <div className="mb-6">
                                  <h2 className="text-lg font-semibold text-gray-800 dark:text-white mb-2">Saldo</h2>
                                  <div className="flex items-end">
                                    <p className="text-3xl font-bold text-gold-600">{wallet.balance.toFixed(8)}</p>
                                    <span className="ml-2 text-xl text-gray-500 dark:text-gray-400">₿Ǥɱ</span>
                                  </div>
                                  <p className="text-sm text-gray-500 dark:text-gray-400">
                                    ≈ ${(wallet.balance * 50000).toFixed(2)} (Point)
                                  </p>
                                </div>
                    
                                {/* Tampilkan transaksi */}
                                <div>
                                  <h2 className="text-lg font-semibold text-gray-800 dark:text-white mb-4">Transaksi</h2>
                                  {wallet.transactions.length === 0 ? (
                                    <div className="text-center py-8 text-gray-500 dark:text-gray-400">
                                      <i className="bi bi-wallet text-3xl mb-2"></i>
                                      <p>Tidak ada transaksi</p>
                                    </div>
                                  ) : (
                                    <>
                                      <div className="overflow-x-auto">
                                        <table className="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                          <thead className="bg-gray-50 dark:bg-gray-700">
                                            <tr>
                                              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Tanggal</th>
                                              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Jenis</th>
                                              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Jumlah</th>
                                              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Deskripsi</th>
                                            </tr>
                                          </thead>
                                          <tbody className="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                            {currentTransactions.map((tx) => (
                                              <tr key={tx.id}>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                                                  {formatTime(tx.created_at)}
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                                                  {tx.type}
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gold-600 dark:text-gold-400">
                                                  {tx.amount.toFixed(8)} ₿Ǥɱ
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                                                  {tx.description}
                                                </td>
                                              </tr>
                                            ))}
                                          </tbody>
                                        </table>
                                      </div>
                                      {/* Pagination */}
                                      {totalPages > 1 && (
                                        <div className="flex justify-center mt-4 space-x-2">
                                          {Array.from({ length: totalPages }, (_, index) => (
                                            <button
                                              key={index + 1}
                                              onClick={() => handlePageChange(index + 1)}
                                              className={`px-3 py-1 rounded-md text-sm font-medium transition-colors duration-300 ${
                                                currentPage === index + 1
                                                  ? 'bg-gold-600 text-white'
                                                  : 'bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white hover:bg-gray-300 dark:hover:bg-gray-600'
                                              }`}
                                            >
                                              {index + 1}
                                            </button>
                                          ))}
                                        </div>
                                      )}
                                    </>
                                  )}
                                </div>
                              </>
                            )}
                          </div>
                        </div>
                      );
                    }
                    function LeaderboardPage({ user, t }) {
  const [leaderboard, setLeaderboard] = React.useState([]);
  const [isLoading, setIsLoading] = React.useState(false);
  const [error, setError] = React.useState('');

  // Ambil data leaderboard + cek user pernah beli booster
  const fetchLeaderboard = async () => {
  setIsLoading(true);
  setError('');
  try {
    // Ambil wallet dan profile
    const { data: walletData, error: walletError } = await supabase
      .from('wallet')
      .select(`
        balance,
        user_id,
        profiles(full_name, profile_photo)
      `)
      .order('balance', { ascending: false })
      .limit(50);

    if (walletError) throw walletError;

    // Ambil user_id semua leaderboard
    const userIds = walletData.map((w) => w.user_id);

    // Ambil semua pembelian booster user di leaderboard
    const { data: boosterData, error: boosterError } = await supabase
      .from('user_boost_purchases')
      .select('user_id')
      .in('user_id', userIds);

    if (boosterError) throw boosterError;

    // Buat set user_id yang pernah beli booster
    const premiumUserIds = new Set(boosterData.map((b) => b.user_id));

    // Gabungkan data
    const transformedData = walletData.map((entry, index) => ({
      rank: index + 1,
      user_id: entry.user_id,
      balance: entry.balance || 0,
      full_name: entry.profiles?.full_name || 'Anonymous',
      profile_photo: entry.profiles?.profile_photo || null,
      hasPremium: premiumUserIds.has(entry.user_id),
    }));

    setLeaderboard(transformedData);
  } catch (err) {
    setError(err.message || 'Failed to fetch leaderboard');
  } finally {
    setIsLoading(false);
  }
};

  React.useEffect(() => {
    fetchLeaderboard();
  }, []);

  return (
    <div className="ml-0 md:ml-96 px-4 md:px-6 max-w-full md:max-w-[calc(100%-384px)]">
      <h1 className="text-2xl font-bold text-gray-900 dark:text-white mb-6 section-title animate-slide-in gold-text-gradient">
        {t('leaderboard')}
      </h1>
      {error && (
        <div className="bg-red-100 dark:bg-red-900 border border-red-400 dark:border-red-700 text-red-700 dark:text-red-100 px-4 py-3 rounded mb-4 animate-slide-in">
          {error}
        </div>
      )}
      <div className="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 crystal-card animate-slide-in">
        <h2 className="text-lg font-semibold text-gray-800 dark:text-white mb-4">
          {t('Top Miners')}
        </h2>
        {isLoading ? (
          <div className="flex items-center justify-center py-6">
            <div className="relative w-12 h-12">
              <div className="absolute inset-0 border-4 border-t-transparent border-gold-400 rounded-full animate-spin [animation-duration:1.2s] bg-gradient-to-r from-gold-300/30 to-transparent opacity-50 blur-sm"></div>
              <div className="absolute inset-0 border-4 border-t-gold-500 border-gold-200/50 rounded-full animate-spin [animation-duration:1.2s]"></div>
              <div className="absolute inset-2 bg-gold-500/10 rounded-full animate-pulse"></div>
            </div>
            <span className="ml-4 text-lg font-light text-gray-700 dark:text-gray-200 animate-[pulse_2s_ease-in-out_infinite]">
              Loading...
            </span>
          </div>
        ) : leaderboard.length === 0 ? (
          <p className="text-gray-600 dark:text-gray-300">{t('noData')}</p>
        ) : (
          <div className="space-y-3 leaderboard-container">
            {leaderboard.map((entry) => (
              <div
                key={entry.user_id}
                className="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-700 rounded-md transition-transform duration-200 hover:scale-[1.02] hover:shadow-md leaderboard-item"
              >
                <div className="flex items-center space-x-3 min-w-[200px]">
                  <div className="flex items-center space-x-1 w-8 flex-shrink-0 rank">
                    {entry.rank === 1 && <i className="bi bi-trophy-fill text-gold-500 text-sm"></i>}
                    {entry.rank === 2 && <i className="bi bi-trophy-fill text-gray-400 text-sm"></i>}
                    {entry.rank === 3 && <i className="bi bi-trophy-fill text-amber-600 text-sm"></i>}
                    <span className="text-base font-bold text-gold-600">
                      {entry.rank}
                    </span>
                  </div>
                  {entry.profile_photo ? (
                    <img
                      className="w-10 h-10 rounded-full object-cover border-2 border-gold-200 dark:border-gold-700 flex-shrink-0"
                      src={entry.profile_photo}
                      alt={entry.full_name}
                    />
                  ) : (
                    <div className="w-10 h-10 rounded-full bg-gray-200 dark:bg-gray-700 flex items-center justify-center border-2 border-gold-200 dark:border-gold-700 flex-shrink-0">
                      <i className="bi bi-person-circle text-lg text-gray-400 dark:text-gray-600"></i>
                    </div>
                  )}
                  <span className="text-gray-800 dark:text-white font-medium max-w-[200px] flex items-center">
  {entry.full_name}
  {entry.hasPremium && (
    <i
      className="bi bi-star-fill ml-2 text-yellow-400"
      style={{
        fontSize: '1.1em',
        filter: 'drop-shadow(0 0 6px #FFD700) drop-shadow(0 0 12px #FFD700)',
        animation: 'gold-glow 1.5s infinite alternate'
      }}
      title="Premium User"
    ></i>
  )}
</span>
                </div>
                <span className="text-gold-600 font-semibold text-sm balance flex-shrink-0 min-w-[100px] text-right">
                  {entry.balance.toFixed(8)} ₿Ǥɱ
                </span>
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  );
}
                    
                    function SettingsPage({ darkMode, toggleDarkMode, t }) {
                      const [emailNotifications, setEmailNotifications] = React.useState(true);
                      const [pushNotifications, setPushNotifications] = React.useState(false);
                      const [notificationError, setNotificationError] = React.useState('');
                      const [isSendingNotification, setIsSendingNotification] = React.useState(false);
                    
                      // Fungsi untuk meminta izin notifikasi sistem
                      const requestNotificationPermission = async () => {
                        if (!("Notification" in window)) {
                          return { granted: false, error: t('notificationsNotSupported') || 'Notifications are not supported in this browser.' };
                        }
                    
                        try {
                          const permission = await Notification.requestPermission();
                          if (permission === 'granted') {
                            return { granted: true };
                          } else {
                            return {
                              granted: false,
                              error: t('notificationPermissionDenied') || 'Notification permission denied. Please enable notifications in your browser settings.',
                            };
                          }
                        } catch (err) {
                          console.error('requestNotificationPermission: Error:', err);
                          return { granted: false, error: t('notificationError') || 'Failed to request notification permission.' };
                        }
                      };
                    
                      // Fungsi untuk menampilkan notifikasi sistem
                      const showSystemNotification = () => {
                        new Notification(t('appUpdate') || 'Pembaruan dari Saya', {
                          body: t('updateMessage') || 'Ada pembaruan baru di aplikasi Anda!',
                          icon: 'https://via.placeholder.com/32', // Ganti dengan ikon aplikasi Anda
                        });
                      };
                    
                      // Fungsi untuk memvalidasi email
                      const validateEmail = (email) => {
                        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                        return re.test(email);
                      };
                    
                      // Fungsi untuk mengirim notifikasi email
                      const sendEmailNotification = async (userId, fullName, email) => {
                        try {
                          // Validasi email
                          if (!validateEmail(email)) {
                            throw new Error(t('invalidEmail') || 'Invalid email address.');
                          }
                    
                          const payload = {
                            user_id: userId,
                            full_name: fullName || 'Pengguna',
                            email: email,
                            subject: t('appUpdate') || 'Pembaruan Aplikasi',
                            message: t('updateMessageEmail') || `Halo ${fullName || 'Pengguna'}, ada pembaruan baru di aplikasi Anda. Periksa pengaturan Anda!`,
                          };
                    
                          console.log('sendEmailNotification: Sending request:', {
                            user_id: userId,
                            email,
                            subject: payload.subject.substring(0, 50),
                          });
                    
                          const { data, error } = await supabase.functions.invoke('send-notification-email', {
                            body: payload,
                          });
                    
                          if (error) {
                            console.error('sendEmailNotification: Error:', {
                              message: error.message,
                              code: error.code,
                              details: error.details,
                              hint: error.hint,
                            });
                            throw new Error(error.message || (t('emailNotificationFailed') || 'Failed to send email notification. Please check your email settings.'));
                          }
                    
                          console.log('sendEmailNotification: Success:', data);
                          return data;
                        } catch (err) {
                          console.error('sendEmailNotification: Error:', err);
                          throw err;
                        }
                      };
                    
                      // Fungsi untuk menangani klik tombol Cetak Notifikasi
                      const handleSendNotification = async () => {
                        setIsSendingNotification(true);
                        setNotificationError('');
                    
                        let systemNotificationError = '';
                        let emailNotificationError = '';
                    
                        try {
                          // Ambil data pengguna dari Supabase
                          const { data: userSession } = await supabase.auth.getUser();
                          if (!userSession?.user?.id) {
                            throw new Error(t('userNotAuthenticated') || 'User not authenticated.');
                          }
                          const userId = userSession.user.id;
                    
                          const { data: profileData, error: profileError } = await supabase
                            .from('profiles')
                            .select('full_name, email')
                            .eq('id', userId)
                            .single();
                    
                          if (profileError) {
                            console.error('handleSendNotification: Profile error:', profileError);
                            throw new Error(`Failed to fetch profile: ${profileError.message}`);
                          }
                    
                          if (!profileData?.email && emailNotifications) {
                            throw new Error(t('emailNotSet') || 'Email address not set in profile. Please update your profile.');
                          }
                    
                          // Kirim notifikasi sistem jika push notifications diaktifkan
                          if (pushNotifications) {
                            const { granted, error } = await requestNotificationPermission();
                            if (granted) {
                              showSystemNotification();
                            } else {
                              systemNotificationError = error;
                            }
                          }
                    
                          // Kirim email jika email notifications diaktifkan
                          if (emailNotifications) {
                            try {
                              await sendEmailNotification(userId, profileData.full_name, profileData.email);
                            } catch (err) {
                              emailNotificationError = err.message;
                            }
                          }
                    
                          // Tampilkan error jika ada
                          if (systemNotificationError && emailNotificationError) {
                            setNotificationError(`${systemNotificationError} ${emailNotificationError}`);
                          } else if (systemNotificationError) {
                            setNotificationError(systemNotificationError);
                          } else if (emailNotificationError) {
                            setNotificationError(emailNotificationError);
                          }
                        } catch (err) {
                          console.error('handleSendNotification: Error:', err);
                          setNotificationError(err.message);
                        } finally {
                          setIsSendingNotification(false);
                        }
                      };
                    
                      return (
                        <div className="ml-0 md:ml-96 px-4 md:px-6 max-w-full md:max-w-[calc(100%-384px)]">
                          <h1 className="text-2xl font-bold text-gray-900 dark:text-white mb-6 section-title animate-slide-in">
                            {t('settings')}
                          </h1>
                          {notificationError && (
                            <div className="bg-red-100 dark:bg-red-900 border border-red-400 dark:border-red-700 text-red-700 dark:text-red-100 px-4 py-3 rounded mb-4 animate-slide-in">
                              {notificationError}
                              {notificationError.includes('notificationPermissionDenied') && (
                                <p className="mt-2 text-sm">
                                  {t('enableNotificationsGuide') || (
                                    <>
                                      To enable notifications, go to your browser settings and allow notifications for this site.{' '}
                                      <a
                                        href="https://support.google.com/chrome/answer/6148059"
                                        target="_blank"
                                        rel="noopener noreferrer"
                                        className="text-blue-600 dark:text-blue-400 underline"
                                      >
                                        Learn more
                                      </a>
                                    </>
                                  )}
                                </p>
                              )}
                              {notificationError.includes('User not found') && (
                                <p className="mt-2 text-sm">
                                  {t('userNotFoundGuide') || (
                                    <>
                                      User profile not found. Please ensure your profile is set up correctly.{' '}
                                      <a
                                        href="/profile"
                                        className="text-blue-600 dark:text-blue-400 underline"
                                      >
                                        Update profile
                                      </a>
                                    </>
                                  )}
                                </p>
                              )}
                              {notificationError.includes('Invalid email address') && (
                                <p className="mt-2 text-sm">
                                  {t('invalidEmailGuide') || (
                                    <>
                                      The email address is invalid. Please update your profile with a valid email address.{' '}
                                      <a
                                        href="/profile"
                                        className="text-blue-600 dark:text-blue-400 underline"
                                      >
                                        Update profile
                                      </a>
                                    </>
                                  )}
                                </p>
                              )}
                              {notificationError.includes('Failed to send email') && (
                                <p className="mt-2 text-sm">
                                  {t('emailNotificationGuide') || (
                                    <>
                                      Unable to send email. Please ensure your email address is correct in your profile and try again.{' '}
                                      <a
                                        href="/profile"
                                        className="text-blue-600 dark:text-blue-400 underline"
                                      >
                                        Update profile
                                      </a>
                                    </>
                                  )}
                                </p>
                              )}
                            </div>
                          )}
                          <div className="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 crystal-card animate-slide-in">
                            <div className="space-y-6">
                              <div className="flex items-center justify-between">
                                <div>
                                  <h2 className="text-lg font-semibold text-gray-800 dark:text-white">{t('darkMode')}</h2>
                                  <p className="text-sm text-gray-500 dark:text-gray-400">{t('darkModeDescription') || 'Toggle between light and dark themes'}</p>
                                </div>
                                <button
                                  onClick={toggleDarkMode}
                                  className={`relative inline-flex items-center h-6 rounded-full w-11 transition-colors duration-200 ${
                                    darkMode ? 'bg-gold-600' : 'bg-gray-200'
                                  }`}
                                >
                                  <span
                                    className={`inline-block w-4 h-4 transform bg-white rounded-full transition-transform duration-200 ${
                                      darkMode ? 'translate-x-6' : 'translate-x-1'
                                    }`}
                                  />
                                </button>
                              </div>
                              <div>
                                <h2 className="text-lg font-semibold text-gray-800 dark:text-white">{t('notifications')}</h2>
                                <p className="text-sm text-gray-500 dark:text-gray-400">{t('notificationsDescription') || 'Manage your notification preferences'}</p>
                                <div className="mt-2 space-y-2">
                                  <label className="flex items-center">
                                    <input
                                      type="checkbox"
                                      checked={emailNotifications}
                                      onChange={() => setEmailNotifications(!emailNotifications)}
                                      className="h-4 w-4 text-gold-600 focus:ring-gold-500 border-gray-300 dark:border-gray-600 rounded"
                                    />
                                    <span className="ml-2 text-sm text-gray-600 dark:text-gray-300">{t('emailNotifications') || 'Email notifications'}</span>
                                  </label>
                                  <label className="flex items-center">
                                    <input
                                      type="checkbox"
                                      checked={pushNotifications}
                                      onChange={() => setPushNotifications(!pushNotifications)}
                                      className="h-4 w-4 text-gold-600 focus:ring-gold-500 border-gray-300 dark:border-gray-600 rounded"
                                    />
                                    <span className="ml-2 text-sm text-gray-600 dark:text-gray-300">{t('pushNotifications') || 'Push notifications'}</span>
                                  </label>
                                  <button
                                    onClick={handleSendNotification}
                                    disabled={isSendingNotification || (!emailNotifications && !pushNotifications)}
                                    className={`mt-4 bg-gradient-to-r from-gold-600 to-gold-700 hover:from-gold-700 hover:to-gold-800 text-white py-2 px-4 rounded-md font-medium flex items-center transition-colors duration-300 ${
                                      isSendingNotification || (!emailNotifications && !pushNotifications) ? 'opacity-50 cursor-not-allowed' : ''
                                    }`}
                                  >
                                    {isSendingNotification ? (
                                      <span className="flex items-center">
                                        <i className="bi bi-arrow-repeat animate-spin mr-2"></i>
                                        {t('sending')}
                                      </span>
                                    ) : (
                                      <span className="flex items-center">
                                        <i className="bi bi-bell mr-2"></i>
                                        {t('sendNotification') || 'Cetak Notifikasi'}
                                      </span>
                                    )}
                                  </button>
                                </div>
                              </div>
                              <div>
                                <h2 className="text-lg font-semibold text-gray-800 dark:text-white">{t('about')}</h2>
                                <p className="text-sm text-gray-500 dark:text-gray-400">{t('version') || 'Version 1.0.0'}</p>
                              </div>
                            </div>
                          </div>
                        </div>
                      );
                    }
                    
                        // Render the App
                        ReactDOM.render(<App />, document.getElementById('root'));
                      </script>
                    </body>
                    </html>
